<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXトレードマネージャー</title>
    <!-- Tailwind CSS CDNをロード --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Interフォントを使用 --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif, 'Noto Sans JP', sans-serif; 
            /* シンプルな暗い背景色 */
            background-color: #1a1a1a; /* ダークグレー */
            min-height: 100vh;
            color: #e5e7eb; /* 基本フォントカラーを明るい色に */
        }

        .container {
            max-width: 100%;
            padding: 1rem;
            padding-bottom: 5rem; 
        }

        /* ------------------------------------- */
        /* グラスモーフィズムの基本スタイル (シンプル化) */
        /* ------------------------------------- */

        /* カードの基本スタイル */
        .card {
            background: rgba(255, 255, 255, 0.1); /* 半透明の白 */
            backdrop-filter: blur(8px); /* ぼかし */
            -webkit-backdrop-filter: blur(8px); 
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08); /* 細い枠線 */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); /* ソフトな影 */
            transition: all 0.3s ease;
        }

        /* 入力フィールドのスタイル */
        .input-style {
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3); /* 暗く、やや透明な背景 */
            color: #ffffff; /* 入力文字を白に */
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.5); /* 凹み影 */
            transition: all 0.3s ease;
        }
        .input-style:focus {
            background: rgba(0, 0, 0, 0.4); 
            box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.7);
            outline: none;
        }
        .input-style::placeholder {
            color: rgba(255, 255, 255, 0.4); 
        }
        /* Selectタグの矢印の色 */
        select.input-style {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23ffffff'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }


        /* プライマリーボタン */
        .btn-primary {
            background-color: #3b82f6; /* 青 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); /* シンプルな影 */
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        /* 下部ナビゲーション */
        .bottom-nav {
            background: rgba(0, 0, 0, 0.7); /* 暗い半透明 */
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5); 
        }
        .nav-button-active {
            color: #93c5fd; /* アクティブな色を明るい青に */
            background: rgba(255, 255, 255, 0.08); /* アクティブ時の背景 */
            border-radius: 10px;
        }
        
        /* ロード中 */
        .loading-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
        }
        
        @media (min-width: 640px) {
            .container {
                max-width: 800px;
                margin: auto;
            }
        }
        
        /* 統計サマリーカード */
        .summary-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6);
        }
        /* CSVボタン */
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        /* カスタムロゴのスタイル */
        .app-logo-text {
            font-size: 1.8rem; 
            font-weight: 900; 
            color: #ffffff; /* 白抜き */
            letter-spacing: -0.025em; 
            margin-bottom: 0.5rem;
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.4); /* 青いソフトグロー */
        }
        /* メッセージボックスの調整 */
        #message-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }
        .text-green-700 { color: #84cc16; } 
        .text-red-700 { color: #ef4444; }   

        @media (min-width: 640px) {
             .app-logo-text {
                font-size: 2.25rem; 
            }
        }
        
        /* AIコピー成功ポップアップ用アニメーション */
        @keyframes pop-in {
            0% { transform: scale(0.9); opacity: 0; }
            60% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes big-check {
            0% { transform: scale(0.6) rotate(-10deg); opacity: 0.0; }
            50% { transform: scale(1.15) rotate(4deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .kbd-key {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 0.375rem;
            background: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 -2px 0 rgba(255,255,255,0.08);
            margin: 0 0.15rem;
            font-weight: 700;
        }
    </style>

    <!-- アプリスクリプト（LocalStorage版） --><script>

        // グローバル変数
        let userId = 'local-user';
        let tradeDataCache = []; 
        let currentPage = 'money-management'; 
        
        const FULL_TRADES_KEY = 'fx_trades_full';

        // 初期化（LocalStorage）
        function initializeLocalApp() {
            try {
                const savedId = localStorage.getItem('fx_user_id');
                userId = savedId || crypto.randomUUID();
                if (!savedId) localStorage.setItem('fx_user_id', userId);
                document.getElementById('user-info').textContent = `ユーザーID: ${userId}`;
            } catch (_) {
                userId = 'local-user';
                document.getElementById('user-info').textContent = `ユーザーID: ${userId}`;
            }
            setupRealtimeListener();
            hideLoading();
        }

        // ロード画面非表示
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // レンダリング用ロード（LocalStorage）
        function setupRealtimeListener() {
            const stored = loadFullTrades();
            const trades = stored.map(t => {
                const dateObj = new Date(typeof t.timestamp === 'number' ? t.timestamp : Date.now());
                return {
                    id: t.id,
                    dateObj,
                    date: dateObj.toLocaleString('ja-JP'),
                    pair: t.pair,
                    direction: t.direction,
                    lotSize: Number(t.lotSize) || 0,
                    entryPrice: Number(t.entryPrice) || 0,
                    exitPrice: Number(t.exitPrice) || 0,
                    pips: Number(t.pips) || 0,
                    pnl: Number(t.pnl) || 0,
                    chartUrl: t.chartUrl || '',
                    notes: t.notes || ''
                };
            });
            trades.sort((a,b) => b.dateObj - a.dateObj);
            tradeDataCache = trades;
            renderTrades(trades);
            calculateStats(trades);

            // AI用の簡易データへ同期
            try {
                const lsTrades = trades.map(t => ({
                    date: t.dateObj instanceof Date && !isNaN(t.dateObj) ? t.dateObj.toISOString().slice(0,10) : '',
                    pair: t.pair || '',
                    side: t.direction === 'buy' ? '買' : '売',
                    lot: t.lotSize,
                    entry: t.entryPrice,
                    exit: t.exitPrice,
                    pnl: t.pnl,
                    rule: '—',
                    memo: t.notes || ''
                }));
                localStorage.setItem('fx_trades', JSON.stringify(lsTrades));
            } catch (e) {
                console.warn('LocalStorageへの同期に失敗:', e);
            }
        }

        function loadFullTrades() {
            try {
                const raw = localStorage.getItem(FULL_TRADES_KEY);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch(_) { return []; }
        }
        function saveFullTrades(list) {
            localStorage.setItem(FULL_TRADES_KEY, JSON.stringify(list));
        }

        // カスタムメッセージ（アラート代替）を表示する関数
        function showCustomMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            
            messageBox.className = `p-3 rounded-lg text-center mt-4 mb-4 transition-all duration-300 ${
                type === 'success' ? 'text-green-700' :
                type === 'error' ? 'text-red-700' :
                'text-blue-400'
            }`; 
            
            messageBox.style.opacity = '1';
            messageBox.style.background = 'rgba(0, 0, 0, 0.5)'; 
            messageBox.style.border = '1px solid rgba(255, 255, 255, 0.08)';

            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 5000);
        }

        // トレード記録をLocalStorageに保存
        window.recordTrade = async function() {
            const pair = document.getElementById('pair').value;
            const direction = document.getElementById('direction').value;
            const lotSize = parseFloat(document.getElementById('lotSize').value);
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const exitPrice = parseFloat(document.getElementById('exitPrice').value);
            const pips = parseFloat(document.getElementById('pips').value);
            const pnl = parseFloat(document.getElementById('pnl').value);
            const chartUrl = '';
            const notes = document.getElementById('notes').value;

            // 必須入力チェック
            if (!pair || !direction || isNaN(lotSize) || isNaN(entryPrice) || isNaN(exitPrice) || isNaN(pips) || isNaN(pnl)) {
                showCustomMessage('必須項目をすべて入力してください。', 'error');
                return;
            }

            const list = loadFullTrades();
            const newTrade = {
                id: crypto.randomUUID(),
                pair,
                direction,
                lotSize,
                entryPrice,
                exitPrice,
                pips,
                pnl,
                chartUrl,
                notes,
                timestamp: Date.now(),
                userId
            };
            try {
                list.push(newTrade);
                saveFullTrades(list);
                showCustomMessage('トレード記録が正常に保存されました！', 'success');
                document.getElementById('tradeForm').reset();
                try {
                    if (Array.isArray(pendingFormImages) && pendingFormImages.length > 0) {
                        saveTradeImages(newTrade.id, pendingFormImages.slice(0,3));
                        pendingFormImages = [];
                        try { localStorage.removeItem('fx_temp_form_images'); } catch(_) {}
                        const cont = document.getElementById('imagePreviewContainer');
                        if (cont) cont.innerHTML = '';
                    }
                } catch (_) {}
                setupRealtimeListener();
            } catch (e) {
                console.error('トレード記録の保存エラー:', e);
                showCustomMessage('記録の保存中にエラーが発生しました。', 'error');
            }
        }

        // トレード記録をHTMLテーブルにレンダリング
        function renderTrades(trades) {
            const tableBody = document.getElementById('tradeHistoryBody');
            tableBody.innerHTML = ''; 

            if (trades.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="p-3 text-center text-gray-500">まだトレード記録がありません。</td></tr>';
                return;
            }

            trades.forEach(trade => {
                const pnlClass = trade.pnl > 0 ? 'text-green-400 font-bold' : trade.pnl < 0 ? 'text-red-400 font-bold' : 'text-gray-400';
                const row = tableBody.insertRow();
                row.className = 'border-b border-gray-800 hover:bg-gray-800/50 transition-colors text-sm'; 

                row.insertCell().textContent = trade.date;
                row.insertCell().textContent = trade.pair;
                row.insertCell().textContent = trade.direction === 'buy' ? '買い' : '売り';
                row.insertCell().textContent = trade.lotSize.toFixed(2);
                const priceDecimals = trade.pair.includes('JPY') ? 3 : 5;
                row.insertCell().textContent = trade.entryPrice.toFixed(priceDecimals);
                row.insertCell().textContent = trade.exitPrice.toFixed(priceDecimals);
                row.insertCell().textContent = trade.pips.toFixed(2);

                const pnlCell = row.insertCell();
                pnlCell.className = pnlClass;
                pnlCell.textContent = trade.pnl.toFixed(0).toLocaleString() + '円'; 

                const imgCell = row.insertCell();
                imgCell.className = 'py-2';
                const imgWrap = document.createElement('div');
                imgWrap.className = 'flex items-center gap-2 flex-wrap';
                const btn = document.createElement('button');
                btn.className = 'btn-secondary px-2 py-1 text-xs';
                btn.textContent = '📷 チャート画像を追加';
                btn.onclick = () => openImageManageModal(trade.id);
                imgWrap.appendChild(btn);

                const thumbs = loadTradeThumbnails(trade.id);
                if (thumbs.length > 0) {
                    thumbs.slice(0,3).forEach((t, idx) => {
                        const im = document.createElement('img');
                        im.src = t;
                        im.alt = `thumb-${idx+1}`;
                        im.width = 40; im.height = 40;
                        im.className = 'rounded object-cover cursor-pointer border border-gray-700';
                        im.onclick = () => openImageViewer(trade.id, idx);
                        imgWrap.appendChild(im);
                    });
                } else {
                    const none = document.createElement('span');
                    none.className = 'text-gray-500 text-xs';
                    none.textContent = 'なし';
                    imgWrap.appendChild(none);
                }
                imgCell.appendChild(imgWrap);
            });
        }
        
        // 統計情報の計算と表示
        function calculateStats(trades) {
            if (trades.length === 0) {
                document.getElementById('totalTrades').textContent = 0;
                document.getElementById('winRate').textContent = '0.00%';
                document.getElementById('profitFactor').textContent = '0.00';
                document.getElementById('totalPnl').textContent = '0 円';
                
                document.getElementById('totalPnl').className = 'text-2xl font-bold text-gray-400';
                return;
            }

            const totalTrades = trades.length;
            let winningTrades = 0;
            let totalPnl = 0;
            let grossProfit = 0;
            let grossLoss = 0;

            trades.forEach(trade => {
                totalPnl += trade.pnl;
                if (trade.pnl > 0) {
                    winningTrades++;
                    grossProfit += trade.pnl;
                } else {
                    grossLoss += Math.abs(trade.pnl);
                }
            });

            const winRate = (winningTrades / totalTrades) * 100;
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? '---' : '0.00');

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = `${winRate.toFixed(2)}%`;
            document.getElementById('profitFactor').textContent = profitFactor === '---' ? '∞' : profitFactor.toFixed(2);
            
            const totalPnlElement = document.getElementById('totalPnl');
            totalPnlElement.textContent = `${totalPnl.toFixed(0).toLocaleString()} 円`;
            totalPnlElement.className = totalPnl >= 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
        }

        // 資金管理：ロットサイズ計算
        window.calculateLotSize = function() {
            const balance = parseFloat(document.getElementById('accountBalance').value);
            const riskPct = parseFloat(document.getElementById('riskPercentage').value);
            const stopLossPips = parseFloat(document.getElementById('stopLossPips').value);
            const pipValuePerLot = parseFloat(document.getElementById('pipValuePerLot').value);

            if (isNaN(balance) || balance <= 0 || isNaN(riskPct) || riskPct <= 0 || isNaN(stopLossPips) || stopLossPips <= 0 || isNaN(pipValuePerLot) || pipValuePerLot <= 0) {
                document.getElementById('calculatedLotSize').textContent = '無効な入力値';
                document.getElementById('calculatedLotSize').className = 'text-xl text-red-400 font-semibold';
                document.getElementById('riskAmountDisplay').textContent = '';
                return;
            }

            const riskAmount = balance * (riskPct / 100);
            const calculatedLotSize = riskAmount / (stopLossPips * pipValuePerLot);

            const resultElement = document.getElementById('calculatedLotSize');
            resultElement.textContent = calculatedLotSize.toFixed(2) + ' ロット';
            resultElement.className = 'text-2xl text-blue-400 font-bold';
            
            document.getElementById('riskAmountDisplay').textContent = `許容リスク額: ${riskAmount.toLocaleString()} 円相当`;
            document.getElementById('riskAmountDisplay').className = 'text-sm text-gray-400 mt-1';
            
            showCustomMessage(`適切なロットサイズは ${calculatedLotSize.toFixed(2)} ロットです。`, 'info');
        }

        // CSVエクスポート機能
        window.exportToCSV = function() {
            if (tradeDataCache.length === 0) {
                showCustomMessage('エクスポートするトレード記録がありません。', 'error');
                return;
            }
            
            const headers = ["日付", "通貨ペア", "方向", "ロット数", "エントリー価格", "エグジット価格", "獲得/損失 pips", "損益(円)", "チャートURL", "メモ"];
            
            const csvRows = tradeDataCache.map(trade => {
                const dateString = trade.dateObj.toISOString(); 
                const directionText = trade.direction === 'buy' ? '買い' : '売り';
                const imgCount = getTradeImages(trade.id).length;
                const memoWithImages = trade.notes ? trade.notes : '';
                const memoFinal = imgCount > 0 ? (memoWithImages + ` [画像${imgCount}枚あり]`) : memoWithImages;
                
                return [
                    `"${dateString}"`, 
                    `"${trade.pair}"`,
                    `"${directionText}"`,
                    trade.lotSize,
                    trade.entryPrice,
                    trade.exitPrice,
                    trade.pips,
                    trade.pnl,
                    `"${trade.chartUrl || ''}"`,
                    `"${(memoFinal ? memoFinal.replace(/"/g, '""') : '')}"` 
                ].join(',');
            });
            
            const csvContent = headers.join(',') + '\n' + csvRows.join('\n');
            const blob = new Blob(['\ufeff', csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `fx_trade_history_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showCustomMessage('トレード履歴をCSVとしてエクスポートしました。', 'success');
            } else {
                showCustomMessage('お使いのブラウザではCSVエクスポート機能がサポートされていません。', 'error');
            }
        }

        // ページ切り替えロジック
        window.showPage = function(pageId) {
            currentPage = pageId;
            const pages = ['money-management', 'trade-recording', 'history-analysis'];
            
            // コンテンツの切り替え
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (pageId === id) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });

            // ナビゲーションボタンのスタイリング切り替え
            pages.forEach(id => {
                const navItem = document.getElementById(`nav-${id}`);
                const icon = navItem.querySelector('svg');

                if (pageId === id) {
                    navItem.classList.add('nav-button-active');
                    icon.classList.add('text-blue-400'); 
                    navItem.classList.remove('text-gray-400');
                } else {
                    navItem.classList.remove('nav-button-active');
                    icon.classList.remove('text-blue-400');
                    navItem.classList.add('text-gray-400');
                }
            });
        }

        // 初期ページ表示（LocalStorage版）
        window.onload = () => {
            initializeLocalApp();
            showPage(currentPage);
            setupFormImageButtons();
            loadPendingFormImagesFromLocal();
        };

        // ===== AI分析機能 =====
        let lastGeneratedPrompt = '';
        function getTradesFromLocalStorage() {
            try {
                const raw = localStorage.getItem('fx_trades');
                if (!raw) return [];
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function convertTradesToCsv(trades) {
            const headers = ['日付','通貨ペア','売買','ロット数','エントリー価格','決済価格','損益','ルール遵守','メモ'];
            const rows = trades.map(t => {
                const safeMemo = String(t.memo || '').replace(/"/g, '""');
                const pnlStr = typeof t.pnl === 'number' ? (t.pnl >= 0 ? `+${t.pnl}` : `${t.pnl}`) : String(t.pnl || '');
                return [
                    t.date || '',
                    t.pair || '',
                    t.side || '',
                    t.lot ?? '',
                    t.entry ?? '',
                    t.exit ?? '',
                    pnlStr,
                    (t.rule === true || t.rule === '○') ? '○' : (t.rule === false || t.rule === '×') ? '×' : (t.rule || '—'),
                    `"${safeMemo}` + `"`
                ].join(',');
            });
            return headers.join(',') + '\n' + rows.join('\n');
        }

        function buildAiPrompt(csv) {
            const template = `あなたはFXトレードのプロアナリストです。
以下のCSVデータは私の今週のトレード記録です。

【分析項目】
1. 勝ちパターンと負けパターンの特徴
2. 時間帯・通貨ペア別の傾向
3. ルール遵守率と勝率の相関
4. メンタル面の課題（連敗時の行動パターンなど）
5. 次週改善すべき具体的行動3つ

━━━━━━━━━━━━━━━━━━━━
[トレードデータ]
${csv}
━━━━━━━━━━━━━━━━━━━━

初心者にも分かりやすく、箇条書きで分析してください。
特に改善点は具体的な数値目標付きでお願いします。`;
            return template;
        }

        async function copyToClipboardWithFallback(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (e) {
                    // fallthrough to fallback
                }
            }
            // Fallback: create textarea and select
            try {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.top = '-1000px';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                const ok = document.execCommand('copy');
                if (!ok) {
                    // 表示用フォールバック
                    showAiPromptFallback(text);
                    document.body.removeChild(ta);
                    return false;
                }
                document.body.removeChild(ta);
                return true;
            } catch (e) {
                showAiPromptFallback(text);
                return false;
            }
        }

        function showAiPromptFallback(text) {
            const area = document.getElementById('ai-fallback-area');
            const modal = document.getElementById('ai-modal');
            area.value = text;
            area.focus();
            area.select();
            modal.classList.remove('hidden');
        }

        // 既定AIの管理
        function setPreferredAI(type) {
            try { localStorage.setItem('preferredAI', type); } catch(_) {}
        }
        function getPreferredAI() {
            try { return localStorage.getItem('preferredAI') || null; } catch(_) { return null; }
        }
        function resetPreferredAI() {
            try { localStorage.removeItem('preferredAI'); } catch(_) {}
            showCustomMessage('既定AIをリセットしました', 'success');
        }
        function displayNameForAI(type) {
            const map = { chatgpt: 'ChatGPT', gemini: 'Gemini', claude: 'Claude' };
            return map[type] || type;
        }

        // アクション付きトースト
        function showActionToast(message, actionLabel, actionHandler, secondaryLabel, secondaryHandler) {
            const box = document.getElementById('message-box');
            box.className = 'p-3 rounded-lg text-center mt-4 mb-4 transition-all duration-300 text-green-700';
            box.style.opacity = '1';
            box.style.background = 'rgba(0, 0, 0, 0.5)';
            box.style.border = '1px solid rgba(255, 255, 255, 0.08)';
            box.innerHTML = '';
            const span = document.createElement('span');
            span.textContent = message + ' ';
            box.appendChild(span);
            if (actionLabel && actionHandler) {
                const btn = document.createElement('button');
                btn.className = 'underline text-blue-300 ml-2';
                btn.textContent = actionLabel;
                btn.onclick = actionHandler;
                box.appendChild(btn);
            }
            if (secondaryLabel && secondaryHandler) {
                const btn2 = document.createElement('button');
                btn2.className = 'underline text-blue-300 ml-3';
                btn2.textContent = secondaryLabel;
                btn2.onclick = secondaryHandler;
                box.appendChild(btn2);
            }
            setTimeout(() => { box.style.opacity = '0'; }, 6000);
        }

        window.handleAiAnalyze = async function() {
            const trades = getTradesFromLocalStorage();
            if (!trades || trades.length === 0) {
                showCustomMessage('⚠️ トレード記録がありません。先にトレードを記録してください。', 'error');
                return;
            }
            const csv = convertTradesToCsv(trades);
            const prompt = buildAiPrompt(csv);
            lastGeneratedPrompt = prompt;

            const btn = document.getElementById('btn-ai-analyze');
            const originalHtml = btn ? btn.innerHTML : '';

            const copied = await copyToClipboardWithFallback(prompt);
            if (copied) {
                // タップ/クリックの強化フィードバック
                if (navigator.vibrate) try { navigator.vibrate(200); } catch (_) {}
                playFeedbackBeep();

                if (btn) {
                    // 緑色に光るエフェクト
                    btn.classList.add('bg-green-500','shadow-[0_0_0_0_rgba(34,197,94,0.9)]');
                    btn.style.boxShadow = '0 0 0 0 rgba(34,197,94,0.9)';
                    btn.style.transition = 'box-shadow 0.6s ease-out, background-color 0.2s ease-out';
                    setTimeout(() => {
                        btn.style.boxShadow = '0 0 24px 6px rgba(34,197,94,0.45)';
                    }, 10);

                    // テキストを一瞬差し替え
                    btn.innerHTML = '✅ コピー完了！';

                    // ポップアップのチェックアイコン
                    const pop = document.createElement('span');
                    pop.textContent = '✅';
                    pop.className = 'absolute -top-4 -right-2 text-2xl';
                    pop.style.transition = 'transform 250ms ease, opacity 300ms ease';
                    pop.style.transform = 'translateY(8px) scale(0.6)';
                    pop.style.opacity = '0';
                    btn.appendChild(pop);
                    requestAnimationFrame(() => {
                        pop.style.transform = 'translateY(-8px) scale(1)';
                        pop.style.opacity = '1';
                    });

                    setTimeout(() => {
                        if (btn && originalHtml) btn.innerHTML = originalHtml;
                        btn.classList.remove('bg-green-500');
                        pop.remove();
                        btn.style.boxShadow = '';
                    }, 1000);
                }

                // 初回は巨大チュートリアル、2回目以降はトーストのみ
                const completed = localStorage.getItem('ai_tutorial_completed') === '1';
                const pref = getPreferredAI();
                if (pref) {
                    const name = displayNameForAI(pref);
                    // 自動で既定AIを開く
                    const urlMap = { chatgpt: 'https://chat.openai.com/', gemini: 'https://gemini.google.com/app', claude: 'https://claude.ai/new' };
                    const url = urlMap[pref];
                    let opened = null;
                    if (url) opened = window.open(url, '_blank', 'noopener');
                    if (!opened) {
                        showActionToast(`前回のAI（${name}）を開けませんでした（ブロック）。`, '開く', () => window.open(url, '_blank', 'noopener'), '変更する', () => openAiSelectModal());
                    } else {
                        showActionToast(`前回のAI（${name}）を開きました。`, '変更する', () => openAiSelectModal());
                    }
                } else {
                    if (completed) {
                        showCustomMessage('✅ コピーしました。AIを選んで開き、Ctrl+V で貼り付けてください。', 'success');
                        openAiSelectModal();
                    } else {
                        showAiTutorialPopup();
                    }
                }
            }
        }

        function showAiTutorialPopup() {
            const overlay = document.getElementById('ai-copy-tutorial');
            if (!overlay) return;
            overlay.classList.remove('hidden');
            // フォーカス移動（アクセシビリティ）
            const ack = document.getElementById('ai-copy-tutorial-ack');
            if (ack) ack.focus();
            
            const onAck = () => {
                const noshow = document.getElementById('ai-copy-tutorial-noshow');
                if (noshow && noshow.checked) {
                    localStorage.setItem('ai_tutorial_completed', '1');
                }
                overlay.classList.add('hidden');
                openAiSelectModal();
            };
            const ackBtn = document.getElementById('ai-copy-tutorial-ack');
            if (ackBtn) {
                ackBtn.onclick = onAck;
            }
        }

        window.closeAiModal = function() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        // AI選択モーダルの制御
        function openAiSelectModal() {
            const modal = document.getElementById('ai-select-modal');
            const card = document.getElementById('ai-select-card');
            modal.classList.remove('hidden');
            // 初期は透明・縮小 → 次フレームで表示
            card.classList.add('opacity-0','scale-95');
            requestAnimationFrame(() => {
                card.classList.remove('opacity-0','scale-95');
                card.classList.add('opacity-100','scale-100');
            });
        }

        window.closeAiSelectModal = function() {
            const modal = document.getElementById('ai-select-modal');
            const card = document.getElementById('ai-select-card');
            card.classList.remove('opacity-100','scale-100');
            card.classList.add('opacity-0','scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 150);
        }

        window.openAiUrl = function(type) {
            const urlMap = {
                chatgpt: 'https://chat.openai.com/',
                gemini: 'https://gemini.google.com/app',
                claude: 'https://claude.ai/new'
            };
            const url = urlMap[type];
            if (url) {
                setPreferredAI(type);
                const win = window.open(url, '_blank', 'noopener');
                if (!win) {
                    showActionToast('ポップアップがブロックされました。', '開く', () => window.open(url, '_blank', 'noopener'));
                }
            }
        }

        window.downloadPromptTxt = function() {
            const content = lastGeneratedPrompt || '';
            if (!content) {
                showCustomMessage('ダウンロード可能なデータがありません。', 'error');
                return;
            }
            const btn = document.getElementById('btn-download-prompt');
            const originalHtml = btn.innerHTML;
            const ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
            try {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `FX_analysis_prompt_${ymd}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                btn.textContent = '✅ ファイルをダウンロードしました';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 3000);
            } catch (e) {
                btn.textContent = '❌ ダウンロードに失敗しました。もう一度お試しください。';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 3000);
            }
        }
        
        // フィードバック用ビープ音（オプション）
        function playFeedbackBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880; // A5
                o.connect(g);
                g.connect(ctx.destination);
                g.gain.setValueAtTime(0.0001, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
                o.start();
                o.stop(ctx.currentTime + 0.2);
            } catch (_) { /* ignore */ }
        }

        // ===== 画像管理ユーティリティ =====
        let currentImageTradeId = null;

        function getTradeImagesKey(tradeId) {
            return `fx_trade_images_${tradeId}`;
        }
        function getTradeImages(tradeId) {
            try {
                const raw = localStorage.getItem(getTradeImagesKey(tradeId));
                if (!raw) return [];
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : [];
            } catch(_) { return []; }
        }
        function saveTradeImages(tradeId, images) {
            localStorage.setItem(getTradeImagesKey(tradeId), JSON.stringify(images));
        }
        function loadTradeThumbnails(tradeId) {
            return getTradeImages(tradeId).map(x => x.thumb);
        }

        function openImageManageModal(tradeId) {
            currentImageTradeId = tradeId;
            const modal = document.getElementById('img-manage-modal');
            const list = document.getElementById('img-preview-list');
            list.innerHTML = '';
            const imgs = getTradeImages(tradeId);
            imgs.forEach((img, idx) => list.appendChild(buildThumbItem(img.thumb, idx)));
            modal.classList.remove('hidden');

            const drop = document.getElementById('img-drop-area');
            drop.tabIndex = 0;
            drop.ondragover = (e) => { e.preventDefault(); drop.classList.add('bg-gray-800/40'); };
            drop.ondragleave = () => { drop.classList.remove('bg-gray-800/40'); };
            drop.ondrop = (e) => {
                e.preventDefault();
                drop.classList.remove('bg-gray-800/40');
                const files = Array.from(e.dataTransfer.files || []).filter(isSupportedImage);
                processAndAddFiles(files);
            };
            drop.onpaste = (e) => {
                const items = e.clipboardData && e.clipboardData.items ? Array.from(e.clipboardData.items) : [];
                const files = items.map(i => i.getAsFile && i.getAsFile()).filter(Boolean).filter(isSupportedImage);
                if (files.length > 0) processAndAddFiles(files);
            };

            const fileInput = document.getElementById('img-file-input');
            fileInput.onchange = () => {
                const files = Array.from(fileInput.files || []).filter(isSupportedImage);
                processAndAddFiles(files);
                fileInput.value = '';
            };
        }
        function closeImageManageModal() {
            currentImageTradeId = null;
            document.getElementById('img-manage-modal').classList.add('hidden');
        }

        function isSupportedImage(file) {
            return file && /^image\/(png|jpeg|jpg|gif)$/i.test(file.type);
        }

        function buildThumbItem(src, idx) {
            const wrap = document.createElement('div');
            wrap.className = 'relative';
            const im = document.createElement('img');
            im.src = src; im.width = 80; im.height = 80; im.className = 'rounded object-cover border border-gray-700 cursor-pointer';
            im.onclick = () => { if (currentImageTradeId!=null) openImageViewer(currentImageTradeId, idx); };
            const del = document.createElement('button');
            del.className = 'absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 text-xs';
            del.textContent = '×';
            del.onclick = (e) => { e.stopPropagation(); deleteImageAt(idx); };
            wrap.appendChild(im);
            wrap.appendChild(del);
            return wrap;
        }

        async function processAndAddFiles(files) {
            if (!currentImageTradeId) return;
            const existing = getTradeImages(currentImageTradeId);
            if (existing.length >= 3) {
                showCustomMessage('画像が多すぎます。古い画像を削除してください', 'error');
                return;
            }
            const available = Math.max(0, 3 - existing.length);
            const targets = files.slice(0, available);
            try {
                const processed = [];
                for (const f of targets) {
                    const { data, thumb } = await readResizeCompress(f);
                    processed.push({ data, thumb, type: 'image/jpeg', createdAt: Date.now() });
                }
                const updated = existing.concat(processed);
                try {
                    saveTradeImages(currentImageTradeId, updated);
                } catch (e) {
                    console.warn('LocalStorage保存エラー(容量超過の可能性):', e);
                    showCustomMessage('画像の保存に失敗しました（容量超過の可能性）', 'error');
                    return;
                }
                // プレビュー更新
                const list = document.getElementById('img-preview-list');
                list.innerHTML = '';
                updated.forEach((img, idx) => list.appendChild(buildThumbItem(img.thumb, idx)));
                // テーブルのサムネも更新
                setupRealtimeListener(); // 再レンダリング用に再トリガー
            } catch (e) {
                console.error('画像処理エラー:', e);
                showCustomMessage('画像の処理に失敗しました', 'error');
            }
        }

        function deleteImageAt(idx) {
            if (currentImageTradeId == null) return;
            const imgs = getTradeImages(currentImageTradeId);
            imgs.splice(idx, 1);
            saveTradeImages(currentImageTradeId, imgs);
            const list = document.getElementById('img-preview-list');
            list.innerHTML = '';
            imgs.forEach((img, i) => list.appendChild(buildThumbItem(img.thumb, i)));
            setupRealtimeListener();
        }

        function openImageViewer(tradeId, index) {
            const imgs = getTradeImages(tradeId);
            if (!imgs[index]) return;
            const modal = document.getElementById('img-viewer-modal');
            const img = document.getElementById('img-viewer-image');
            img.src = imgs[index].data || imgs[index].thumb;
            modal.classList.remove('hidden');
        }
        function closeImageViewer() {
            document.getElementById('img-viewer-modal').classList.add('hidden');
        }

        function readFileAsImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        function drawToCanvas(image, maxSize) {
            const canvas = document.createElement('canvas');
            let { width, height } = image;
            const scale = Math.min(1, maxSize / Math.max(width, height));
            width = Math.round(width * scale);
            height = Math.round(height * scale);
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0, width, height);
            return canvas;
        }
        async function readResizeCompress(file) {
            const img = await readFileAsImage(file);
            const canvas = drawToCanvas(img, 1200);
            const data = canvas.toDataURL('image/jpeg', 0.8);
            const thumbCanvas = drawToCanvas(img, 200);
            const thumb = thumbCanvas.toDataURL('image/jpeg', 0.8);
            return { data, thumb };
        }

        // ===== フォーム用アップロード（新規記録に紐づく一時画像） =====
        let pendingFormImages = [];
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const TEN_MB = 10 * 1024 * 1024;

        function renderFormPreviews() {
            const previews = document.getElementById('imagePreviewContainer');
            if (!previews) return;
            previews.innerHTML = '';
            pendingFormImages.forEach((img, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'relative';
                const im = document.createElement('img');
                im.src = img.thumb; im.width = 80; im.height = 80; im.className = 'rounded object-cover border border-gray-700';
                const del = document.createElement('button');
                del.className = 'absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 text-xs';
                del.textContent = '×';
                del.onclick = () => { pendingFormImages.splice(idx,1); renderFormPreviews(); };
                wrap.appendChild(im); wrap.appendChild(del); previews.appendChild(wrap);
            });
        }

        function syncPendingFormImagesToLocal() {
            try { localStorage.setItem('fx_temp_form_images', JSON.stringify(pendingFormImages)); } catch(_) {}
        }
        function loadPendingFormImagesFromLocal() {
            try {
                const raw = localStorage.getItem('fx_temp_form_images');
                const arr = raw ? JSON.parse(raw) : [];
                if (Array.isArray(arr)) { pendingFormImages = arr; renderFormPreviews(); }
            } catch(_) {}
        }

        function showProgress(text, pct) {
            const box = document.getElementById('uploadProgress');
            const fill = document.getElementById('uploadProgressFill');
            const t = document.getElementById('uploadProgressText');
            if (!box || !fill || !t) return;
            box.classList.remove('hidden');
            if (typeof pct === 'number') fill.style.width = Math.max(0, Math.min(100, pct)) + '%';
            if (text) t.textContent = text;
        }
        function hideProgress() {
            const box = document.getElementById('uploadProgress');
            const fill = document.getElementById('uploadProgressFill');
            if (!box || !fill) return;
            box.classList.add('hidden');
            fill.style.width = '0%';
        }

        function showPreview(previewUrl, tempId) {
            const previews = document.getElementById('imagePreviewContainer');
            const wrap = document.createElement('div');
            wrap.className = 'relative';
            wrap.dataset.tempId = tempId;
            const im = document.createElement('img');
            im.src = previewUrl; im.width = 80; im.height = 80; im.className = 'rounded object-cover border border-gray-700';
            const del = document.createElement('button');
            del.className = 'absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 text-xs';
            del.textContent = '×';
            del.onclick = () => {
                const idx = pendingFormImages.findIndex(x => x.tempId === tempId);
                if (idx >= 0) { pendingFormImages.splice(idx,1); syncPendingFormImagesToLocal(); }
                if (wrap.parentNode) wrap.parentNode.removeChild(wrap);
            };
            wrap.appendChild(im); wrap.appendChild(del); previews.appendChild(wrap);
        }
        function updateThumbnailFor(tempId, thumbUrl) {
            const wrap = Array.from(document.querySelectorAll('#imagePreviewContainer > div')).find(d => d.dataset.tempId === String(tempId));
            if (!wrap) return;
            const im = wrap.querySelector('img');
            if (im) im.src = thumbUrl;
        }
        function showSuccessFor(tempId) {
            hideProgress();
        }
        function showErrorFor(tempId, msg) {
            hideProgress();
            showCustomMessage(msg || '画像の保存に失敗しました', 'error');
        }

        async function createThumbnail(file, maxSize) {
            return await resizeImage(file, maxSize, 0.7);
        }
        function resizeImage(file, maxSize, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        if (width > height && width > maxSize) { height = (height * maxSize) / width; width = maxSize; }
                        else if (height > maxSize) { width = (width * maxSize) / height; height = maxSize; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d', { alpha: false });
                        ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (blob) {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(blob);
                            } else { reject(new Error('Blob生成失敗')); }
                        }, 'image/jpeg', quality);
                        canvas.width = 0; canvas.height = 0;
                        URL.revokeObjectURL(img.src);
                    } catch (err) { reject(err); }
                };
                img.onerror = reject;
                const url = URL.createObjectURL(file);
                img.src = url;
            });
        }

        async function saveToStorageEntry(tempId, dataBase64, thumbBase64) {
            const idx = pendingFormImages.findIndex(x => x.tempId === tempId);
            if (idx >= 0) {
                pendingFormImages[idx].data = dataBase64;
                if (thumbBase64) pendingFormImages[idx].thumb = thumbBase64;
            }
            syncPendingFormImagesToLocal();
        }

        async function handleImageUpload(file) {
            if (!file) return;
            if (file.size > TEN_MB) {
                showCustomMessage('画像サイズが大きすぎます（10MBまで）。', 'error');
                return;
            }
            if (pendingFormImages.length >= 3) {
                showCustomMessage('画像が多すぎます。古い画像を削除してください', 'error');
                return;
            }
            const tempId = crypto.randomUUID();
            const previewUrl = URL.createObjectURL(file);
            pendingFormImages.push({ tempId, previewUrl, createdAt: Date.now() });
            showPreview(previewUrl, tempId);
            showProgress('サムネイル生成中...', 20);

            // ステップ2: サムネイル
            setTimeout(async () => {
                try {
                    const thumb = await createThumbnail(file, 150);
                    updateThumbnailFor(tempId, thumb);
                    const idx = pendingFormImages.findIndex(x => x.tempId === tempId);
                    if (idx >= 0) pendingFormImages[idx].thumb = thumb;
                    showProgress('保存用画像を生成中...', 60);
                } catch (err) {
                    console.error('サムネイル生成失敗:', err);
                }
            }, 100);

            // ステップ3: 保存用
            setTimeout(async () => {
                const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 5000));
                try {
                    const data = await Promise.race([resizeImage(file, 600, 0.6), timeout]);
                    await saveToStorageEntry(tempId, data, null);
                    showProgress('保存しました', 100);
                    setTimeout(hideProgress, 500);
                    showSuccessFor(tempId);
                } catch (err) {
                    console.error('画像保存失敗:', err);
                    showErrorFor(tempId, err.message === 'timeout' ? '画像の処理がタイムアウトしました' : '画像の保存に失敗しました');
                }
            }, 200);
        }

        async function addFilesToPending(files) {
            const valid = files.filter(f => /^image\//i.test(f.type));
            for (const f of valid) {
                await handleImageUpload(f);
            }
        }

        // 既存inputへのonchangeをシンプル化
        (function setupFormImageUpload(){
            const input = document.getElementById('imageUpload');
            if (!input) return;
            input.onchange = async () => {
                const files = Array.from(input.files || []);
                input.value = '';
                await addFilesToPending(files);
            };
        })();

        // デバイス別ボタンの描画
        function setupFormImageButtons() {
            const box = document.getElementById('form-image-buttons');
            if (!box) return;
            box.innerHTML = '';
            if (isMobile) {
                const cam = document.createElement('button');
                cam.type = 'button'; cam.className = 'btn-secondary flex-1'; cam.textContent = '📷 カメラで撮影';
                cam.onclick = () => openCamera();
                const gal = document.createElement('button');
                gal.type = 'button'; gal.className = 'btn-secondary flex-1'; gal.textContent = '🖼️ ギャラリーから選択';
                gal.onclick = () => selectFromGallery();
                box.appendChild(cam); box.appendChild(gal);
            } else {
                const sel = document.createElement('button');
                sel.type = 'button'; sel.className = 'btn-secondary flex-1'; sel.textContent = '📷 画像を選択';
                sel.onclick = () => selectImageFile();
                const pst = document.createElement('button');
                pst.type = 'button'; pst.className = 'btn-secondary flex-1'; pst.textContent = '📋 クリップボードから貼り付け';
                pst.onclick = () => pasteFromClipboard();
                box.appendChild(sel); box.appendChild(pst);
            }
        }

        // PC: ファイル選択
        window.selectImageFile = function() {
            const input = document.getElementById('imageUpload');
            if (input) input.click();
        }

        // PC: クリップボード貼り付け
        window.pasteFromClipboard = function() {
            if (!navigator.clipboard || !navigator.clipboard.read) {
                alert('クリップボードから画像を読み取れませんでした。\n画像をコピーしてから再度お試しください。');
                return;
            }
            navigator.clipboard.read().then(async (items) => {
                const files = [];
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            files.push(new File([blob], 'clipboard-image', { type: blob.type }));
                        }
                    }
                }
                if (files.length === 0) {
                    alert('クリップボードに画像が見つかりませんでした。');
                    return;
                }
                addFilesToPending(files);
            }).catch(() => {
                alert('クリップボードから画像を読み取れませんでした。\n画像をコピーしてから再度お試しください。');
            });
        }

        // スマホ: カメラ起動
        window.openCamera = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = (e) => {
                const files = Array.from(e.target.files || []);
                addFilesToPending(files);
            };
            input.click();
        }

        // スマホ: ギャラリー選択
        window.selectFromGallery = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = (e) => {
                const files = Array.from(e.target.files || []);
                addFilesToPending(files);
            };
            input.click();
        }
    </script>
</head>
<body>
    <!-- ロードオーバーレイ --><div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- コンテンツラッパー (以前のオーバーレイは削除) --><div>
        <div class="container min-h-screen mx-auto pt-6 pb-2">
            <header class="text-center mb-6">
                <!-- ユーザー様の文字ロゴをCSSで再現し、h1タグとして配置 --><h1 class="app-logo-text">FX トレードマネージャー</h1>
                <p id="user-info" class="text-sm text-gray-400 mt-1">認証中...</p>
            </header>

            <!-- メッセージボックス (Alert代替) --><div id="message-box" style="opacity:0;" class="p-3 rounded-lg text-center mt-4 transition-all duration-300"></div>

            <!-- ページコンテンツエリア --><!-- 1. 資金管理：ロット計算ツール --><section id="money-management" class="hidden px-2 sm:px-0">
                <div class="mb-8 p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">ロット計算ツール</h2>
                    <p class="text-sm text-gray-400 mb-4">許容リスクに基づき、適切なポジションサイズを計算します。</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="accountBalance" class="block text-sm font-medium text-gray-300">口座残高 (円相当)</label>
                            <input type="number" id="accountBalance" value="1000000" min="1" class="input-style mt-1" placeholder="例: 1000000">
                        </div>

                        <div>
                            <label for="riskPercentage" class="block text-sm font-medium text-gray-300">1トレードの許容リスク率 (%)</label>
                            <input type="number" id="riskPercentage" value="1" min="0.1" max="100" step="0.1" class="input-style mt-1" placeholder="例: 1.0">
                        </div>
                        
                        <div>
                            <label for="stopLossPips" class="block text-sm font-medium text-gray-300">損切り幅 (pips)</label>
                            <input type="number" id="stopLossPips" value="50" min="1" class="input-style mt-1" placeholder="例: 50">
                        </div>
                        
                        <div>
                            <label for="pipValuePerLot" class="block text-sm font-medium text-gray-300">1ロットあたりの1pipsの価値 (円相当)</label>
                            <input type="number" id="pipValuePerLot" value="1000" min="1" class="input-style mt-1" placeholder="例: 1000">
                            <p class="text-xs text-gray-500 mt-1">※USD/JPYの場合、1ロット=1000円相当</p>
                        </div>
                    </div>

                    <button onclick="calculateLotSize()" class="btn-primary w-full mt-4">
                        ロットサイズを計算
                    </button>

                    <!-- 結果表示エリア --><div class="mt-6 p-4 summary-card text-center">
                        <p class="text-sm font-medium text-gray-400 mb-1">推奨ロットサイズ</p>
                        <div id="calculatedLotSize" class="text-2xl text-white font-bold">-- ロット</div>
                        <div id="riskAmountDisplay" class="text-sm text-gray-400 mt-2"></div>
                    </div>
                </div>
            </section>

            <!-- 2. トレード記録フォーム --><section id="trade-recording" class="hidden px-2 sm:px-0">
                <div class="p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">新規トレード記録</h2>
                    <form id="tradeForm" onsubmit="event.preventDefault(); recordTrade();">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            
                            <!-- 通貨ペア --><div>
                                <label for="pair" class="block text-sm font-medium text-gray-300">通貨ペア</label>
                                <select id="pair" required class="input-style mt-1">
                                    <option value="">選択してください</option>
                                    <option value="USD/JPY">USD/JPY</option>
                                    <option value="EUR/USD">EUR/USD</option>
                                    <option value="GBP/JPY">GBP/JPY</option>
                                    <option value="AUD/USD">AUD/USD</option>
                                    <option value="OTHERS">その他</option>
                                </select>
                            </div>

                            <!-- 売買方向 --><div>
                                <label for="direction" class="block text-sm font-medium text-gray-300">売買方向</label>
                                <select id="direction" required class="input-style mt-1">
                                    <option value="">選択してください</option>
                                    <option value="buy">買い (Buy)</option>
                                    <option value="sell">売り (Sell)</option>
                                </select>
                            </div>

                            <!-- ロット数 --><div>
                                <label for="lotSize" class="block text-sm font-medium text-gray-300">ロット数 (Lot)</label>
                                <input type="number" id="lotSize" required step="0.01" min="0.01" class="input-style mt-1" placeholder="例: 1.0">
                            </div>

                            <!-- エントリー価格 --><div>
                                <label for="entryPrice" class="block text-sm font-medium text-gray-300">エントリー価格</label>
                                <input type="number" id="entryPrice" required step="any" class="input-style mt-1" placeholder="例: 150.050">
                            </div>

                            <!-- エグジット価格 --><div>
                                <label for="exitPrice" class="block text-sm font-medium text-gray-300">エグジット価格</label>
                                <input type="number" id="exitPrice" required step="any" class="input-style mt-1" placeholder="例: 150.100">
                            </div>

                            <!-- 獲得/損失 pips --><div>
                                <label for="pips" class="block text-sm font-medium text-gray-300">獲得/損失 pips</label>
                                <input type="number" id="pips" required step="any" class="input-style mt-1" placeholder="例: 50.0">
                            </div>

                            <!-- 損益 (円相当) --><div class="sm:col-span-2">
                                <label for="pnl" class="block text-sm font-medium text-gray-300">損益 (円相当)</label>
                                <input type="number" id="pnl" required step="any" class="input-style mt-1" placeholder="例: 5000">
                            </div>

                        </div>

                        <!-- メモ --><div class="mt-4">
                            <label for="notes" class="block text-sm font-medium text-gray-300">トレードの考察/メモ</label>
                            <textarea id="notes" rows="3" class="input-style mt-1 resize-none" placeholder="エントリー根拠、反省点などを記述..."></textarea>
                        </div>

                        <!-- 画像アップロード（任意） -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-300">チャート画像（任意）</label>
                            <div id="form-image-buttons" class="flex gap-2 mb-2"></div>
                            <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;" />
                            <div id="imagePreviewContainer" class="flex flex-wrap gap-2"></div>
                            <div id="uploadProgress" class="mt-2 hidden">
                                <div class="w-full h-2 bg-gray-700 rounded">
                                    <div id="uploadProgressFill" class="h-2 bg-green-500 rounded" style="width:0%"></div>
                                </div>
                                <span id="uploadProgressText" class="text-xs text-gray-300 mt-1 inline-block">画像を処理中...</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-6">
                            トレードを記録
                        </button>
                    </form>
                </div>
            </section>

            <!-- 3. 履歴・分析セクション --><section id="history-analysis" class="hidden px-2 sm:px-0">
                <!-- 統計サマリー --><div class="mb-6 summary-card grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-xs font-medium text-gray-400">合計トレード数</p>
                        <p id="totalTrades" class="text-xl font-bold text-white">0</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">勝率</p>
                        <p id="winRate" class="text-xl font-bold text-white">0.00%</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">プロフィットファクター</p>
                        <p id="profitFactor" class="text-xl font-bold text-white">0.00</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">合計損益</p>
                        <p id="totalPnl" class="text-xl font-bold text-white">0 円</p>
                    </div>
                </div>

                <div class="p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">トレード履歴</h2>

                    <!-- CSVボタン --><button onclick="exportToCSV()" class="btn-secondary px-4 py-2 text-sm font-medium mb-4 mr-2">
                        <!-- アイコンの色を白に調整 --><svg class="inline-block w-4 h-4 mr-2 -mt-0.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        CSVエクスポート
                    </button>
                    <!-- AI分析ボタン -->
                    <button id="btn-ai-analyze" onclick="handleAiAnalyze()" class="btn-primary px-4 py-2 text-sm font-bold mb-4 relative overflow-visible">
                        <span class="mr-1">🤖</span> AIで今週を分析
                    </button>
                    
                    <div class="overflow-x-auto rounded-lg shadow-inner">
                        <table class="min-w-full divide-y divide-gray-700 text-white">
                            <thead class="bg-gray-800/60">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">日付</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ペア</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">方向</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ロット</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">E.価格</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">X.価格</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pips</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">損益</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">画像</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistoryBody" class="divide-y divide-gray-800 bg-transparent">
                                <tr><td colspan="9" class="p-3 text-center text-gray-400">履歴を読み込み中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- フッター --><footer class="text-center text-xs text-gray-500 py-4 mt-8">
                <p>Powered by LocalStorage | ユーザーIDは上部に表示</p>
            </footer>
        </div>
    </div>
    
    <!-- 固定された下部ナビゲーションバー --><div class="fixed bottom-0 left-0 right-0 border-t border-gray-800 shadow-2xl z-50 bottom-nav">
        <nav class="flex justify-around max-w-xl mx-auto">
            <!-- 資金管理タブ (ウォレット/シンプル) --><button id="nav-money-management" onclick="showPage('money-management')" class="flex-1 flex flex-col items-center p-2 text-xs font-semibold rounded-xl transition-colors text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V9m0 4v1m-4 5h8a2 2 0 002-2V6a2 2 0 00-2-2H8a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                資金管理
            </button>
            <!-- トレード記録タブ (ペン/シンプル) --><button id="nav-trade-recording" onclick="showPage('trade-recording')" class="flex-1 flex flex-col items-center p-2 text-xs font-semibold rounded-xl transition-colors text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                トレード記録
            </button>
            <!-- 履歴・分析タブ (上昇トレンド/シンプル) --><button id="nav-history-analysis" onclick="showPage('history-analysis')" class="flex-1 flex flex-col items-center p-2 text-xs font-semibold rounded-xl transition-colors text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                履歴・分析
            </button>
        </nav>
    </div>
    <!-- AI分析モーダル -->
    <div id="ai-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto mt-24 w-[92%] max-w-xl rounded-2xl border border-white/10 bg-gray-900/90 p-5 shadow-2xl">
            <h3 id="ai-modal-title" class="text-lg font-bold text-white">AI分析</h3>
            <p id="ai-modal-desc" class="mt-1 text-sm text-gray-300">クリップボードAPIが使えないため、下のテキストを手動でコピーしてください。</p>
            <textarea id="ai-fallback-area" class="mt-4 w-full h-48 input-style"></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button class="btn-secondary px-4 py-2 text-sm" onclick="closeAiModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- AI選択モーダル（コピー成功時のガイド） -->
    <div id="ai-select-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60" onclick="closeAiSelectModal()"></div>
        <div id="ai-select-card" class="relative mx-auto mt-16 w-[92%] max-w-2xl rounded-2xl border border-white/10 bg-gray-900/90 p-5 shadow-2xl transition-all duration-150 ease-out opacity-0 scale-95">
            <button class="absolute right-3 top-3 text-gray-400 hover:text-white" aria-label="閉じる" onclick="closeAiSelectModal()">×</button>
            <div id="ai-copied-title" class="font-bold rounded-lg text-white animate-pulse" style="background:#065f46; padding:16px; font-size:24px;">
                ✅ データをコピーしました
            </div>

            <div class="mt-3 text-sm text-gray-300 font-medium">【方法1: クリップボードから貼り付け（推奨）】</div>
            <p class="mt-1 text-sm text-gray-300">どのAIで分析しますか？</p>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                <button class="btn-primary w-full" onclick="openAiUrl('chatgpt')"><span class="mr-1">🤖</span> ChatGPTで開く</button>
                <button class="btn-primary w-full" onclick="openAiUrl('gemini')"><span class="mr-1">✨</span> Geminiで開く</button>
                <button class="btn-primary w-full" onclick="openAiUrl('claude')"><span class="mr-1">🧠</span> Claudeで開く</button>
            </div>

            <div id="ai-paste-hint" class="mt-3 rounded-lg text-gray-900 font-semibold" style="background:#fde68a; padding:12px; font-size:16px;">
                <span class="mr-1">⚡</span> 開いたら <span class="font-bold">Ctrl+V</span>（Macは <span class="font-bold">⌘+V</span>）で貼り付けてください
            </div>

            <div class="my-4 flex items-center text-gray-500 text-xs">
                <div class="flex-1 h-px bg-gray-700"></div>
                <span class="px-3">━━━━━ または ━━━━━</span>
                <div class="flex-1 h-px bg-gray-700"></div>
            </div>

            <div class="text-sm text-gray-300 font-medium">【方法2: ファイルをダウンロード】</div>
            <button id="btn-download-prompt" class="btn-secondary mt-2 w-full md:w-auto" onclick="downloadPromptTxt()"><span class="mr-1">📄</span> プロンプトファイルをダウンロード</button>
            <p class="mt-2 text-xs text-gray-400">※ダウンロードしたファイルをAIにアップロードしてください</p>
            <div class="mt-3 text-xs text-gray-400 text-right">
                <button class="underline hover:text-white" onclick="resetPreferredAI()">既定AI設定をリセット</button>
            </div>
        </div>
    </div>

    <!-- AIコピー成功：巨大チュートリアルポップアップ（最前面） -->
    <div id="ai-copy-tutorial" class="fixed inset-0 hidden" style="z-index:80;">
        <div class="absolute inset-0" style="background: rgba(16,185,129,0.25);"></div>
        <div class="relative mx-auto my-8 w-[92%] sm:w-[80%] md:w-[70%] lg:w-[60%] max-h-[85vh] overflow-y-auto rounded-2xl border border-white/10 bg-gray-900/95 p-5 shadow-2xl" role="dialog" aria-modal="true" aria-labelledby="ai-copy-tutorial-title" style="animation: pop-in 200ms ease-out;">
            <div class="flex items-start gap-3">
                <div class="text-green-400" aria-hidden="true" style="font-size:64px; line-height:1; animation: big-check 350ms ease-out;">✅</div>
                <div>
                    <div id="ai-copy-tutorial-title" class="font-extrabold text-white" style="font-size:24px;">データのコピーが完了しました！</div>
                    <div class="mt-2 text-gray-300 text-sm">このあとAIを開いて貼り付けしてください。以下の手順に沿って進めればOKです。</div>
                </div>
            </div>

            <div class="mt-4 text-gray-200 text-sm">
                <div class="opacity-80">━━━━━━━━━━━━━━━━━━━━━━━━</div>
                <div class="mt-2 font-bold text-white">次のステップ：</div>
                <div class="opacity-80 mt-2">━━━━━━━━━━━━━━━━━━━━━━━━</div>

                <div class="mt-4 space-y-4">
                    <div class="text-white">
                        <div class="font-extrabold" style="font-size:20px;">① 下のボタンでAIを選んで開く</div>
                        <div class="mt-1 text-gray-300">ChatGPT / Gemini / Claude のいずれかを選びます。</div>
                    </div>
                    <div class="text-white">
                        <div class="font-extrabold" style="font-size:20px;">② 開いたページで「<span class="font-extrabold" style="color:#ef4444;">貼り付け</span>」する</div>
                        <div class="mt-2 text-gray-300">キーボードで <span class="kbd-key">Ctrl</span> + <span class="kbd-key">V</span>（Mac: <span class="kbd-key">⌘</span> + <span class="kbd-key">V</span>）</div>
                        <div class="mt-2 text-gray-300">または、右クリック → 「貼り付け」</div>
                    </div>
                </div>

                <div class="opacity-80 mt-5">━━━━━━━━━━━━━━━━━━━━━━━━</div>

                <div class="mt-4 flex items-center gap-3">
                    <input id="ai-copy-tutorial-noshow" type="checkbox" class="h-4 w-4">
                    <label for="ai-copy-tutorial-noshow" class="text-sm text-gray-300">次回からこのガイドを表示しない</label>
                </div>

                <div class="mt-5 flex flex-col sm:flex-row gap-3">
                    <button id="ai-copy-tutorial-ack" class="btn-primary w-full sm:w-auto text-base px-5 py-3 font-extrabold">[理解しました]</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 画像管理モーダル -->
    <div id="img-manage-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/60" onclick="closeImageManageModal()"></div>
        <div class="relative mx-auto mt-10 w-[92%] max-w-2xl rounded-2xl border border-white/10 bg-gray-900/95 p-5 shadow-2xl">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-white">チャート画像を追加・管理</h3>
                <button class="text-gray-400 hover:text-white" onclick="closeImageManageModal()">×</button>
            </div>
            <div class="mt-3 text-xs text-gray-400">最大3枚まで。PNG/JPEG/GIF。貼り付け、ドラッグ&ドロップ、またはファイル選択に対応。</div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <input id="img-file-input" type="file" accept="image/png,image/jpeg,image/jpg,image/gif" multiple capture="environment" class="hidden" />
                <button class="btn-primary px-3 py-2 text-sm" onclick="document.getElementById('img-file-input').click()">ファイルを選択</button>
                <div id="img-drop-area" class="flex-1 rounded-lg border border-dashed border-gray-600 p-4 text-center text-sm text-gray-300">
                    ここに画像をドラッグ＆ドロップ / フォーカスして Ctrl+V で貼り付け
                </div>
            </div>

            <div class="mt-4">
                <div class="text-sm text-gray-300 mb-2">プレビュー</div>
                <div id="img-preview-list" class="flex flex-wrap gap-3"></div>
            </div>

            <div class="mt-5 flex justify-end gap-2">
                <button class="btn-secondary px-4 py-2 text-sm" onclick="closeImageManageModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 画像ビューアモーダル -->
    <div id="img-viewer-modal" class="fixed inset-0 z-[75] hidden">
        <div class="absolute inset-0 bg-black/80" onclick="closeImageViewer()"></div>
        <div class="relative mx-auto mt-8 w-[92%] max-w-4xl p-2">
            <img id="img-viewer-image" alt="preview" class="mx-auto max-h-[80vh] rounded-lg" style="touch-action: auto;" />
            <div class="mt-3 flex justify-center">
                <button class="btn-secondary px-4 py-2 text-sm" onclick="closeImageViewer()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 🧪 テストデータ追加ボタン（開発用） -->
    <button id="btn-add-testdata" aria-label="テストデータを追加" onclick="addTestData()" class="fixed bottom-20 right-4 z-[60] px-3 py-2 text-xs font-bold rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2" style="background-color:#f59e0b;color:#111827;">
        🧪 テストデータを追加
    </button>

    <script>
    // 開発用: テストデータをLocalStorageに追加（上書き or 確認の上リセット）
    window.addTestData = function() {
        try {
            const key = 'fx_trades';
            const existing = localStorage.getItem(key);

            if (existing) {
                const ok = confirm('テストデータをリセットして追加しますか？\n（既存データは上書きされます）');
                if (!ok) return;
            }

            // 既存のAI連携と同一フォーマット: date, pair, side, lot, entry, exit, pnl, rule, memo
            const samples = [
                { date: '2025-10-31', pair: 'USD/JPY', side: '買', lot: 0.1, entry: 150.50, exit: 150.80, pnl: 3000, rule: '○', memo: '順張りエントリー成功' },
                { date: '2025-10-31', pair: 'EUR/USD', side: '売', lot: 0.2, entry: 1.0850, exit: 1.0820, pnl: 6000, rule: '○', memo: '逆張りエントリー成功' },
                { date: '2025-10-30', pair: 'GBP/JPY', side: '買', lot: 0.15, entry: 195.50, exit: 195.20, pnl: -3000, rule: '×', memo: '損切り遅延で損失拡大' }
            ];

            localStorage.setItem(key, JSON.stringify(samples));
            alert('✅ テストデータを3件追加しました');
            location.reload();
        } catch (e) {
            console.error('テストデータ保存エラー:', e);
            alert('❌ データの保存に失敗しました');
        }
    }
    </script>
</body>
</html>
