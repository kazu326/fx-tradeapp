<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXãƒˆãƒ¬ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>
    <!-- Tailwind CSS CDNã‚’ãƒ­ãƒ¼ãƒ‰ --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.jsã‚’ãƒ­ãƒ¼ãƒ‰ --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Interãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif, 'Noto Sans JP', sans-serif; 
            /* ã‚·ãƒ³ãƒ—ãƒ«ãªæš—ã„èƒŒæ™¯è‰² */
            background-color: #1a1a1a; /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
            min-height: 100vh;
            color: #e5e7eb; /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã‚’æ˜ã‚‹ã„è‰²ã« */
        }

        .container {
            max-width: 100%;
            padding: 1rem;
            padding-bottom: 5rem; 
        }

        /* ------------------------------------- */
        /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« (ã‚·ãƒ³ãƒ—ãƒ«åŒ–) */
        /* ------------------------------------- */

        /* ã‚«ãƒ¼ãƒ‰ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: rgba(255, 255, 255, 0.1); /* åŠé€æ˜ã®ç™½ */
            backdrop-filter: blur(8px); /* ã¼ã‹ã— */
            -webkit-backdrop-filter: blur(8px); 
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08); /* ç´°ã„æ ç·š */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); /* ã‚½ãƒ•ãƒˆãªå½± */
            transition: all 0.3s ease;
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-style {
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3); /* æš—ãã€ã‚„ã‚„é€æ˜ãªèƒŒæ™¯ */
            color: #ffffff; /* å…¥åŠ›æ–‡å­—ã‚’ç™½ã« */
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.5); /* å‡¹ã¿å½± */
            transition: all 0.3s ease;
        }
        .input-style:focus {
            background: rgba(0, 0, 0, 0.4); 
            box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.7);
            outline: none;
        }
        .input-style::placeholder {
            color: rgba(255, 255, 255, 0.4); 
        }
        /* Selectã‚¿ã‚°ã®çŸ¢å°ã®è‰² */
        select.input-style {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23ffffff'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }


        /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒœã‚¿ãƒ³ */
        .btn-primary {
            background-color: #3b82f6; /* é’ */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); /* ã‚·ãƒ³ãƒ—ãƒ«ãªå½± */
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav {
            background: rgba(0, 0, 0, 0.7); /* æš—ã„åŠé€æ˜ */
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5); 
        }
        .nav-button-active {
            color: #93c5fd; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè‰²ã‚’æ˜ã‚‹ã„é’ã« */
            background: rgba(255, 255, 255, 0.08); /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®èƒŒæ™¯ */
            border-radius: 10px;
        }
        
        /* ãƒ­ãƒ¼ãƒ‰ä¸­ */
        .loading-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
        }
        
        @media (min-width: 640px) {
            .container {
                max-width: 800px;
                margin: auto;
            }
        }
        
        /* çµ±è¨ˆã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6);
        }
        /* CSVãƒœã‚¿ãƒ³ */
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚´ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .app-logo-text {
            font-size: 1.8rem; 
            font-weight: 900; 
            color: #ffffff; /* ç™½æŠœã */
            letter-spacing: -0.025em; 
            margin-bottom: 0.5rem;
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.4); /* é’ã„ã‚½ãƒ•ãƒˆã‚°ãƒ­ãƒ¼ */
        }
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®èª¿æ•´ */
        #message-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }
        .text-green-700 { color: #84cc16; } 
        .text-red-700 { color: #ef4444; }   

        @media (min-width: 640px) {
             .app-logo-text {
                font-size: 2.25rem; 
            }
        }
        
        /* AIã‚³ãƒ”ãƒ¼æˆåŠŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pop-in {
            0% { transform: scale(0.9); opacity: 0; }
            60% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes big-check {
            0% { transform: scale(0.6) rotate(-10deg); opacity: 0.0; }
            50% { transform: scale(1.15) rotate(4deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .kbd-key {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 0.375rem;
            background: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 -2px 0 rgba(255,255,255,0.08);
            margin: 0 0.15rem;
            font-weight: 700;
        }
        
        /* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒœã‚¿ãƒ³ */
        .prompt-type {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        .prompt-type:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(59,130,246,0.4);
            transform: translateY(-2px);
        }
        .prompt-type.active {
            background: rgba(59,130,246,0.15);
            border-color: #3b82f6;
            box-shadow: 0 0 12px rgba(59,130,246,0.2);
        }
        .prompt-type .icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }
        .prompt-type .desc {
            display: block;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-top: 0.25rem;
        }
        
        /* ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ */
        .snackbar {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            max-width: 90%;
            width: auto;
            min-width: 300px;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .snackbar-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .snackbar-content p {
            margin: 0 0 12px 0;
            color: #ffffff;
            font-size: 14px;
            text-align: center;
        }
        .rating-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .rating-buttons button {
            font-size: 24px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rating-buttons button:hover {
            transform: scale(1.2);
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        .snackbar .close-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .snackbar .close-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        /* åºƒå‘Šã‚¹ã‚¿ã‚¤ãƒ« */
        .ad-banner, .ad-inline, .ad-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            margin: 16px 0;
            text-align: center;
        }
        .ad-label {
            display: inline-block;
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .ad-content a {
            text-decoration: none;
            color: #ffffff;
            display: block;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .ad-content a:hover {
            background: rgba(255,255,255,0.1);
        }
        .ad-cta {
            color: #3b82f6;
            font-weight: 600;
        }
        .pro-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        .feature-item {
            text-align: center;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
        }
        .feature-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
        }
        .pro-price {
            font-size: 24px;
            text-align: center;
            margin: 24px 0;
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä»˜ããƒˆãƒ¼ã‚¹ãƒˆ */
        .action-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateX(120%);
            transition: all 0.3s ease;
            max-width: 400px;
        }
        .action-toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #ffffff;
        }
        .toast-action {
            padding: 6px 12px;
            background: #3b82f6;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toast-action:hover {
            background: #2563eb;
        }
        
        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒˆãƒ¼ã‚¹ãƒˆ */
        .progress-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 10002;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #ffffff;
        }
        .progress-toast.show {
            opacity: 1;
        }
        /* ãƒˆãƒ¼ã‚¹ãƒˆä½ç½®åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        .action-toast.toast-left {
            left: 20px;
            right: auto;
            transform: translateX(-120%);
        }
        .action-toast.toast-left.show {
            transform: translateX(0);
        }
        .action-toast.toast-right {
            right: 20px;
            left: auto;
            transform: translateX(120%);
        }
        .action-toast.toast-right.show {
            transform: translateX(0);
        }
        .action-toast.toast-center {
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
        }
        .action-toast.toast-center.show {
            transform: translateX(-50%) translateY(0);
        }
        .progress-toast.toast-left {
            left: 20px;
            right: auto;
            transform: translateX(-120%);
        }
        .progress-toast.toast-left.show {
            transform: translateX(0);
        }
        .progress-toast.toast-right {
            right: 20px;
            left: auto;
            transform: translateX(120%);
        }
        .progress-toast.toast-right.show {
            transform: translateX(0);
        }
        .progress-toast.toast-center {
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
        }
        .progress-toast.toast-center.show {
            transform: translateX(-50%) translateY(0);
        }
        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-bar {
            width: 100%;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 2px;
            animation: progress 2000ms linear;
        }
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        kbd {
            display: inline-block;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        
        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .app-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .tab-btn {
            flex: 1;
            min-width: 80px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: rgba(255,255,255,0.5);
            transition: all 0.2s ease;
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
        }
        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: rgba(59,130,246,0.1);
        }
        .tab-icon {
            font-size: 20px;
        }
        .tab-label {
            font-size: 12px;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .stat-label {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3b82f6;
        }
        .chart-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .chart-container h4 {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin: 0 0 12px 0;
        }
        @media (max-width: 640px) {
            .tab-label { font-size: 10px; }
            .tab-icon { font-size: 18px; }
            .tab-btn { padding: 8px 12px; }
        }
        .completion-toast {
            position: fixed;
            top: 20px;
            z-index: 10003;
            background: rgba(31, 33, 33, 0.98);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            min-width: 320px;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }
        .completion-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .completion-toast.toast-left {
            left: 20px;
        }
        .completion-toast.toast-right {
            right: 20px;
        }
        .completion-toast.toast-center {
            left: 50%;
            transform: translate(-50%, -10px);
        }
        .completion-toast.toast-center.show {
            transform: translate(-50%, 0);
        }
        @media (prefers-color-scheme: light) {
            .completion-toast {
                background: rgba(255, 255, 255, 0.98);
            }
        }
        @media (prefers-color-scheme: dark) {
            .completion-toast {
                background: rgba(31, 33, 33, 0.98);
            }
        }
        [data-color-scheme="light"] .completion-toast {
            background: rgba(255, 255, 255, 0.98);
        }
        [data-color-scheme="dark"] .completion-toast {
            background: rgba(31, 33, 33, 0.98);
        }
        .summary-header {
            margin-bottom: 12px;
            font-size: 16px;
            color: #ffffff;
            font-weight: 600;
        }
        .summary-row {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #ffffff;
        }
        .summary-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .summary-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>

    <!-- ã‚¢ãƒ—ãƒªã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆLocalStorageç‰ˆï¼‰ --><script>

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let userId = 'local-user';
        let tradeDataCache = []; 
        let currentPage = 'money-management'; 
        
        const FULL_TRADES_KEY = 'fx_trades_full';
        
        // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
        let chartInstances = {};
        
        // AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†
        let lastAIWindow = null;
        let latestPromptText = '';

        // ===== ãƒ—ãƒ©ãƒ³ç®¡ç†æ©Ÿèƒ½ =====
        function initializePlan() {
            if (!localStorage.getItem('userPlan')) {
                localStorage.setItem('userPlan', 'free');
                localStorage.setItem('planStartDate', new Date().toISOString());
            }
        }
        function getUserPlan() {
            return localStorage.getItem('userPlan') || 'free';
        }
        function isPro() {
            return getUserPlan() === 'pro';
        }
        function setPlan(plan) {
            localStorage.setItem('userPlan', plan);
            updateAdDisplay();
        }
        function getDaysSinceInstall() {
            const startDate = localStorage.getItem('planStartDate');
            if (!startDate) return 0;
            return Math.floor((Date.now() - new Date(startDate).getTime()) / (1000 * 60 * 60 * 24));
        }
        function updateAdDisplay() {
            const plan = getUserPlan();
            console.log('updateAdDisplay called, plan:', plan);
            
            const footerAd = document.getElementById('footerAdBanner');
            const modalAd = document.getElementById('modalAd');
            const settingsAd = document.getElementById('settingsAd');
            
            console.log('åºƒå‘Šè¦ç´ :', { footerAd: !!footerAd, modalAd: !!modalAd, settingsAd: !!settingsAd });
            
            if (plan === 'pro') {
                if (footerAd) footerAd.style.display = 'none';
                if (modalAd) modalAd.style.display = 'none';
                if (settingsAd) settingsAd.style.display = 'none';
                } else {
                if (footerAd) footerAd.style.display = 'block';
                if (settingsAd) settingsAd.style.display = 'block';
                
                const days = getDaysSinceInstall();
                console.log('çµŒéæ—¥æ•°:', days);
                if (modalAd && days >= 7) {
                    modalAd.style.display = 'block';
                }
            }
        }
        function logAdClick(placement) {
            logEvent({
                type: 'ad_click',
                placement,
                plan: getUserPlan(),
                timestamp: new Date().toISOString()
            });
        }
        window.showProInfo = function() {
            const modal = document.getElementById('proInfoModal');
            if (modal) modal.classList.remove('hidden');
        }
        window.closeProInfo = function() {
            const modal = document.getElementById('proInfoModal');
            if (modal) modal.classList.add('hidden');
        }
        window.toggleDevPlan = function() {
            const current = getUserPlan();
            const newPlan = current === 'free' ? 'pro' : 'free';
            setPlan(newPlan);
            const planDisplay = document.getElementById('currentPlanDisplay');
            if (planDisplay) {
                planDisplay.textContent = newPlan === 'pro' ? 'Proç‰ˆ' : 'ç„¡æ–™ç‰ˆ';
            }
            showCustomMessage(`ãƒ—ãƒ©ãƒ³ã‚’ ${newPlan} ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
            setTimeout(() => location.reload(), 1000);
        }

        // ===== AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ªãƒ¼ãƒ—ãƒ³æ©Ÿèƒ½ =====
        
        function getToastPosition() {
            const position = localStorage.getItem('windowPosition') || 'right';
            return position === 'right' ? 'left' : position === 'left' ? 'right' : 'center';
        }
        
        function showProgressToast(message, duration = 2000) {
            const existing = document.querySelector('.progress-toast');
            if (existing) existing.remove();
            const position = getToastPosition();
            const toast = document.createElement('div');
            toast.className = `progress-toast show toast-${position}`;
            toast.innerHTML = `
                <span>â³ ${message}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="animation: progress ${duration}ms linear"></div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // å®Œäº†ã‚µãƒãƒªãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆã®è¡¨ç¤º
        function showCompletionSummary({ promptType, ai, imageCount, logsOk }) {
            const windowPos = localStorage.getItem('windowPosition') || 'right';
            const toastSide = windowPos === 'right' ? 'left' : windowPos === 'left' ? 'right' : 'center';
            
            const aiNames = {
                chatgpt: 'ChatGPT',
                gemini: 'Gemini',
                claude: 'Claude'
            };
            
            const promptTypeNames = {
                basic: 'åŸºæœ¬åˆ†æ',
                trend: 'ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚©ãƒ­ãƒ¼å‹',
                range: 'ãƒ¬ãƒ³ã‚¸é€†å¼µã‚Šå‹',
                breakout: 'ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆå‹',
                mental: 'ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ'
            };
            
            const div = document.createElement('div');
            div.className = `completion-toast show toast-${toastSide}`;
            div.innerHTML = `
                <div class="summary-header">
                    <span style="font-weight: 600;">âœ… AIåˆ†ææº–å‚™å®Œäº†</span>
                </div>
                <div class="summary-row">
                    <span>ğŸ“š ${promptTypeNames[promptType] || promptType || 'åŸºæœ¬åˆ†æ'}</span>
                    <span>ğŸ¤– ${aiNames[ai] || 'AI'}</span>
                </div>
                <div class="summary-row">
                    <span>ğŸ–¼ï¸ ç”»åƒ ${imageCount || 0} æš</span>
                    <span>${logsOk ? 'ğŸ—’ï¸ ãƒ­ã‚°è¨˜éŒ²æ¸ˆ' : ''}</span>
                </div>
                <div class="summary-actions">
                    <button class="btn-secondary px-3 py-1 text-xs" id="reCopyBtn">ğŸ“‹ å†ã‚³ãƒ”ãƒ¼</button>
                    <button class="btn-secondary px-3 py-1 text-xs" id="openOtherBtn">ğŸ”„ åˆ¥AIã§é–‹ã</button>
                    <button class="btn-secondary px-3 py-1 text-xs" id="closeToastBtn">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(div);
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            div.querySelector('#reCopyBtn').onclick = () => {
                if (latestPromptText) {
                    navigator.clipboard.writeText(latestPromptText).then(() => {
                        showCustomMessage('ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å†ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                    });
                }
            };
            
            div.querySelector('#openOtherBtn').onclick = () => {
                const modal = document.getElementById('ai-select-modal');
                if (modal) modal.classList.remove('hidden');
                closeCompletionToast(div);
            };
            
            div.querySelector('#closeToastBtn').onclick = () => {
                closeCompletionToast(div);
            };
            
            // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
            setTimeout(() => {
                closeCompletionToast(div);
            }, 5000);
        }
        
        function closeCompletionToast(div) {
            div.classList.remove('show');
            setTimeout(() => div.remove(), 300);
        }
        
        function openAITab(type) {
            const urlMap = {
                chatgpt: 'https://chat.openai.com/',
                gemini: 'https://gemini.google.com/app',
                claude: 'https://claude.ai/new'
            };
            
            const url = urlMap[type];
            if (!url) return null;
            
            console.log('openAITab called:', type, url);
            console.log('lastAIWindow exists:', !!lastAIWindow);
            
            // æ—¢å­˜ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã‚ã‚Œã°å†åˆ©ç”¨ã‚’è©¦ã¿ã‚‹ï¼ˆclosedãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ï¼‰
            if (lastAIWindow) {
                try {
                    console.log('Attempting to reuse window...');
                    lastAIWindow.location.href = url;
                    lastAIWindow.focus();
                    console.log('Window reused successfully');
                    showCustomMessage('ğŸ”„ æ—¢å­˜ã®AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å†åˆ©ç”¨ã—ã¾ã—ãŸ', 'success');
                    return lastAIWindow;
                } catch (e) {
                    console.error('ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å†åˆ©ç”¨ã«å¤±æ•—ï¼ˆæ–°è¦ä½œæˆã—ã¾ã™ï¼‰:', e);
                    lastAIWindow = null;
                }
            }
            
            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
            console.log('Opening new window...');
            
            const sizePreference = localStorage.getItem('windowSize') || 'half';
            const positionPreference = localStorage.getItem('windowPosition') || 'right';
            const autoResize = localStorage.getItem('autoResizeOriginal') === 'true';
            
            const screenWidth = window.screen.availWidth;
            const screenHeight = window.screen.availHeight;
            
            let windowWidth, windowHeight, windowLeft, windowTop;
            
            switch (sizePreference) {
                case 'half':
                    windowWidth = Math.floor(screenWidth * 0.5);
                    windowHeight = screenHeight;
                    break;
                case 'two-thirds':
                    windowWidth = Math.floor(screenWidth * 0.67);
                    windowHeight = screenHeight;
                    break;
                case 'full':
                    windowWidth = screenWidth;
                    windowHeight = screenHeight;
                    break;
                case 'small':
                    windowWidth = 800;
                    windowHeight = 600;
                    break;
                default:
                    windowWidth = Math.floor(screenWidth * 0.5);
                    windowHeight = screenHeight;
            }
            
            switch (positionPreference) {
                case 'right':
                    windowLeft = screenWidth - windowWidth;
                    windowTop = 0;
                    break;
                case 'left':
                    windowLeft = 0;
                    windowTop = 0;
                    break;
                case 'center':
                    windowLeft = Math.floor((screenWidth - windowWidth) / 2);
                    windowTop = Math.floor((screenHeight - windowHeight) / 2);
                    break;
                default:
                    windowLeft = screenWidth - windowWidth;
                    windowTop = 0;
            }
            
            const features = [
                `width=${windowWidth}`,
                `height=${windowHeight}`,
                `left=${windowLeft}`,
                `top=${windowTop}`,
                'menubar=no',
                'toolbar=no',
                'location=yes',
                'status=no',
                'resizable=yes',
                'scrollbars=yes'
            ].join(',');
            
            // å›ºå®šåã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
            lastAIWindow = window.open(url, 'FXTradeAI', features);
            
            if (!lastAIWindow) {
                console.error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                showCustomMessage('âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', 'error');
                lastAIWindow = window.open(url, '_blank');
            } else {
                console.log('Window opened successfully');
                showCustomMessage('âœ… AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã¾ã—ãŸ', 'success');
                try {
                    lastAIWindow.focus();
                } catch (e) {
                    console.error('ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤±æ•—:', e);
                }
                
                // å…ƒã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªã‚µã‚¤ã‚ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                if (autoResize && sizePreference === 'half' && window.resizeTo && window.moveTo) {
                    try {
                        if (positionPreference === 'right') {
                            window.resizeTo(windowWidth, windowHeight);
                            window.moveTo(0, 0);
                        } else if (positionPreference === 'left') {
                            window.resizeTo(windowWidth, windowHeight);
                            window.moveTo(windowWidth, 0);
                        }
                    } catch (e) {
                        console.log('è‡ªå‹•ãƒªã‚µã‚¤ã‚ºãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', e);
                    }
                }
            }
            
            return lastAIWindow;
        }
        
        window.saveWindowPreference = function() {
            try {
                const size = document.getElementById('windowSizePreference').value;
                const position = document.getElementById('windowPositionPreference').value;
                const autoResize = document.getElementById('autoResizeOriginal').checked;
                localStorage.setItem('windowSize', size);
                localStorage.setItem('windowPosition', position);
                localStorage.setItem('autoResizeOriginal', autoResize);
                showCustomMessage('âœ… ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            } catch (_) {
                showCustomMessage('âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        window.saveWindowPreferenceFromSettings = function() {
            try {
                const size = document.getElementById('windowSizePreferenceSettings').value;
                const position = document.getElementById('windowPositionPreferenceSettings').value;
                const autoResize = document.getElementById('autoResizeOriginalSettings').checked;
                localStorage.setItem('windowSize', size);
                localStorage.setItem('windowPosition', position);
                localStorage.setItem('autoResizeOriginal', autoResize);
                showCustomMessage('âœ… ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            } catch (_) {
                showCustomMessage('âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        window.toggleSurveyFromSettings = function() {
            const checked = document.getElementById('surveyToggleSettings').checked;
            const bg = document.getElementById('surveyToggleBgSettings');
            const thumb = document.getElementById('surveyToggleThumbSettings');
            localStorage.setItem('surveyDisabled', checked ? '0' : '1');
            bg.style.background = checked ? '#ef4444' : '#10b981';
            thumb.style.transform = checked ? 'translateX(0)' : 'translateX(16px)';
        }
        
        // é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ã®ä¿å­˜
        window.saveContinuousMode = function() {
            const checked = document.getElementById('continuousMode')?.checked || false;
            localStorage.setItem('continuousMode', checked);
            console.log('é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰:', checked);
            const bg = document.getElementById('continuousModeToggleBg');
            const thumb = document.getElementById('continuousModeToggleThumb');
            if (bg && thumb) {
                bg.style.background = checked ? '#10b981' : '#ef4444';
                thumb.style.transform = checked ? 'translateX(16px)' : 'translateX(0)';
            }
            showCustomMessage(`âœ… é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ã‚’${checked ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}ã«ã—ã¾ã—ãŸ`, 'success');
        }
        
        // é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ã®å¾©å…ƒ
        function updateContinuousModeDisplay() {
            const continuousMode = localStorage.getItem('continuousMode') === 'true';
            const checkbox = document.getElementById('continuousMode');
            const bg = document.getElementById('continuousModeToggleBg');
            const thumb = document.getElementById('continuousModeToggleThumb');
            if (checkbox) checkbox.checked = continuousMode;
            if (bg) bg.style.background = continuousMode ? '#10b981' : '#ef4444';
            if (thumb) thumb.style.transform = continuousMode ? 'translateX(16px)' : 'translateX(0)';
        }
        
        // ãƒˆãƒ¬ãƒ¼ãƒ‰é¸æŠæ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆé€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
        window.handleSelectTrade = function(tradeId) {
            console.log('handleSelectTrade called:', tradeId);
            
            const continuousMode = localStorage.getItem('continuousMode') === 'true';
            console.log('continuousMode:', continuousMode);
            
            if (!continuousMode) {
                console.log('é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ãŒOFFã§ã™');
                return;
            }
            
            const trades = loadFullTrades();
            const trade = trades.find(t => String(t.id) === String(tradeId));
            
            if (!trade) {
                console.error('ãƒˆãƒ¬ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', tradeId);
                return;
            }
            
            console.log('Selected trade:', trade);
            
            // å˜ä¸€ãƒˆãƒ¬ãƒ¼ãƒ‰ã®CSVã‚’ç”Ÿæˆ
            const singleTradeData = {
                date: trade.date || (trade.timestamp ? new Date(trade.timestamp).toISOString().slice(0,10) : ''),
                pair: trade.pair || '',
                side: trade.direction === 'buy' ? 'è²·' : 'å£²',
                lot: trade.lotSize || 0,
                entry: trade.entryPrice || 0,
                exit: trade.exitPrice || 0,
                pnl: trade.pnl || 0,
                rule: 'â€”',
                memo: trade.notes || trade.memo || ''
            };
            
            const csv = convertTradesToCsv([singleTradeData]);
            const promptType = getLastPromptType() || 'basic';
            const prompt = generatePromptByType(promptType, csv);
            
            latestPromptText = prompt;
            
            navigator.clipboard.writeText(prompt).then(() => {
                showCustomMessage('ğŸ“‹ é¸æŠã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                
                const preferredAI = getPreferredAI() || 'chatgpt';
                
                // å®Œäº†ã‚µãƒãƒªãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤º
                showCompletionSummary({
                    promptType: promptType,
                    ai: preferredAI,
                    imageCount: 0,
                    logsOk: true
                });
                
                // æ—¢å­˜ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å†åˆ©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ´»ç”¨
                setTimeout(() => {
                    openAITab(preferredAI);
                }, 400);
            }).catch((err) => {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                showCustomMessage('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            });
        }

        // ===== é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½ =====
        function startOfWeek(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        function endOfWeek(date = new Date()) {
            const start = startOfWeek(date);
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            return end;
        }
        
        function filterTradesByRange(trades, range) {
            const now = new Date();
            let fromDate, toDate;
            
            switch (range) {
                case '7d':
                    toDate = now;
                    fromDate = new Date(now);
                    fromDate.setDate(fromDate.getDate() - 6);
                    fromDate.setHours(0, 0, 0, 0);
                    break;
                case '14d':
                    toDate = now;
                    fromDate = new Date(now);
                    fromDate.setDate(fromDate.getDate() - 13);
                    fromDate.setHours(0, 0, 0, 0);
                    break;
                case '30d':
                    toDate = now;
                    fromDate = new Date(now);
                    fromDate.setDate(fromDate.getDate() - 29);
                    fromDate.setHours(0, 0, 0, 0);
                    break;
                case 'thisWeek':
                    fromDate = startOfWeek(now);
                    toDate = endOfWeek(now);
                    break;
                case 'lastWeek':
                    const lastWeekDate = new Date(now);
                    lastWeekDate.setDate(lastWeekDate.getDate() - 7);
                    fromDate = startOfWeek(lastWeekDate);
                    toDate = endOfWeek(lastWeekDate);
                    break;
                default:
                    fromDate = new Date(0);
                    toDate = now;
            }
            
            return trades.filter(trade => {
                const tradeDate = new Date(trade.date || trade.timestamp || now);
                return tradeDate >= fromDate && tradeDate <= toDate;
            });
        }
        
        function summarizeTrades(trades) {
            const count = trades.length;
            let wins = 0;
            let losses = 0;
            let pnlSum = 0;
            let ruleKeeps = 0;
            
            const byPair = {};
            const byHour = Array(24).fill(0).map(() => ({ count: 0, wins: 0, pnl: 0 }));
            
            trades.forEach(trade => {
                const pnl = Number(trade.pnl) || 0;
                pnlSum += pnl;
                
                if (pnl >= 0) {
                    wins++;
                } else {
                    losses++;
                }
                
                if (trade.rule === true || trade.rule === 'â—‹') {
                    ruleKeeps++;
                }
                
                const pair = trade.pair || 'N/A';
                if (!byPair[pair]) {
                    byPair[pair] = { count: 0, wins: 0, pnl: 0 };
                }
                byPair[pair].count++;
                if (pnl >= 0) byPair[pair].wins++;
                byPair[pair].pnl += pnl;
                
                const tradeDate = new Date(trade.date || trade.timestamp || new Date());
                const hour = tradeDate.getHours();
                byHour[hour].count++;
                if (pnl >= 0) byHour[hour].wins++;
                byHour[hour].pnl += pnl;
            });
            
            const winRate = count > 0 ? Math.round((wins / count) * 100) : 0;
            const ruleRate = count > 0 ? Math.round((ruleKeeps / count) * 100) : 0;
            
            return { count, wins, losses, pnlSum, winRate, ruleRate, byPair, byHour };
        }
        
        function getRangeLabel(range) {
            const formatDate = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const now = new Date();
            
            if (range === 'thisWeek') {
                const from = startOfWeek(now);
                const to = endOfWeek(now);
                return `${formatDate(from)} ã€œ ${formatDate(to)}`;
            }
            if (range === 'lastWeek') {
                const lastWeekDate = new Date(now);
                lastWeekDate.setDate(lastWeekDate.getDate() - 7);
                const from = startOfWeek(lastWeekDate);
                const to = endOfWeek(lastWeekDate);
                return `${formatDate(from)} ã€œ ${formatDate(to)}`;
            }
            const days = range === '7d' ? 7 : range === '14d' ? 14 : 30;
            const from = new Date(now);
            from.setDate(from.getDate() - (days - 1));
            from.setHours(0, 0, 0, 0);
            return `${formatDate(from)} ã€œ ${formatDate(now)}`;
        }
        
        function makeWeeklyMarkdown(rangeLabel, trades, summary) {
            const pairEntries = Object.entries(summary.byPair);
            const bestPairs = pairEntries.sort((a, b) => b[1].pnl - a[1].pnl).slice(0, 3);
            const worstPairs = pairEntries.sort((a, b) => a[1].pnl - b[1].pnl).slice(0, 3);
            
            const hourStats = summary.byHour
                .map((v, i) => ({
                    hour: i,
                    winRate: v.count > 0 ? Math.round((v.wins / v.count) * 100) : 0,
                    count: v.count,
                    pnl: v.pnl
                }))
                .filter(v => v.count > 0);
                
            const bestHours = hourStats.sort((a, b) => b.pnl - a.pnl).slice(0, 3);
            const worstHours = hourStats.sort((a, b) => a.pnl - b.pnl).slice(0, 3);
            
            const markdown = `# é€±æ¬¡ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆ

**æœŸé–“**: ${rangeLabel}

## ğŸ“Š ã‚µãƒãƒªãƒ¼

- **ãƒˆãƒ¬ãƒ¼ãƒ‰å›æ•°**: ${summary.count} å›
- **å‹ç‡**: ${summary.winRate}% ï¼ˆ${summary.wins}å‹${summary.losses}æ•—ï¼‰
- **åˆè¨ˆæç›Š**: ${summary.pnlSum.toLocaleString()} å††
- **ãƒ«ãƒ¼ãƒ«éµå®ˆç‡**: ${summary.ruleRate}%

---

## âœ… å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¸Šä½3é€šè²¨ãƒšã‚¢ï¼‰

${bestPairs.length > 0 
  ? bestPairs.map(([pair, data]) => 
      `- **${pair}**: æç›Š ${data.pnl.toLocaleString()} å††, å‹ç‡ ${data.count > 0 ? Math.round((data.wins / data.count) * 100) : 0}% (${data.count}å›)`
    ).join('\n')
  : '- ãƒ‡ãƒ¼ã‚¿ä¸è¶³'
}

---

## âŒ è² ã‘ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¸‹ä½3é€šè²¨ãƒšã‚¢ï¼‰

${worstPairs.length > 0
  ? worstPairs.map(([pair, data]) => 
      `- **${pair}**: æç›Š ${data.pnl.toLocaleString()} å††, å‹ç‡ ${data.count > 0 ? Math.round((data.wins / data.count) * 100) : 0}% (${data.count}å›)`
    ).join('\n')
  : '- ãƒ‡ãƒ¼ã‚¿ä¸è¶³'
}

---

## â° æ™‚é–“å¸¯ã®å‚¾å‘

### å¥½èª¿ãªæ™‚é–“å¸¯

${bestHours.length > 0
  ? bestHours.map(h => `- ${h.hour}æ™‚å°: æç›Š ${h.pnl.toLocaleString()} å††, å‹ç‡ ${h.winRate}% (${h.count}å›)`).join('\n')
  : '- ãƒ‡ãƒ¼ã‚¿ä¸è¶³'
}

### ä¸èª¿ãªæ™‚é–“å¸¯

${worstHours.length > 0
  ? worstHours.map(h => `- ${h.hour}æ™‚å°: æç›Š ${h.pnl.toLocaleString()} å††, å‹ç‡ ${h.winRate}% (${h.count}å›)`).join('\n')
  : '- ãƒ‡ãƒ¼ã‚¿ä¸è¶³'
}

---

## ğŸ¯ æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¬¡é€±ã®ç›®æ¨™ï¼‰

1. **ãƒ«ãƒ¼ãƒ«éµå®ˆç‡ã‚’å‘ä¸Š**: ç›®æ¨™ ${Math.min(summary.ruleRate + 5, 100)}% ï¼ˆç¾åœ¨ ${summary.ruleRate}%ï¼‰
2. **ä¸èª¿æ™‚é–“å¸¯ã®å¯¾ç­–**: ãƒ­ãƒƒãƒˆåŠæ¸›ã¾ãŸã¯è¦‹é€ã‚Šã‚’æ¤œè¨
3. **å¥½èª¿ãƒšã‚¢ãƒ»æ™‚é–“å¸¯ã®å†ç¾**: å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‹åŒ–ã—ã¦ç¶™ç¶š

---

*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ˆ${new Date().toLocaleString('ja-JP')}ï¼‰*
`;
            
            return markdown;
        }
        
        window.generateWeeklyReport = function() {
            const range = document.getElementById('reportRange')?.value || '7d';
            const allTrades = loadFullTrades();
            const filteredTrades = filterTradesByRange(allTrades, range);
            
            if (filteredTrades.length === 0) {
                showCustomMessage('âš ï¸ æŒ‡å®šæœŸé–“ã«ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const summary = summarizeTrades(filteredTrades);
            const rangeLabel = getRangeLabel(range);
            const markdown = makeWeeklyMarkdown(rangeLabel, filteredTrades, summary);
            
            const outputEl = document.getElementById('weeklyReportOutput');
            if (outputEl) {
                outputEl.value = markdown;
            }
            
            showCustomMessage('âœ… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
        }
        
        window.copyWeeklyReport = function() {
            const outputEl = document.getElementById('weeklyReportOutput');
            if (!outputEl || !outputEl.value) {
                showCustomMessage('âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            outputEl.select();
            document.execCommand('copy');
            showCustomMessage('ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
        }
        
        window.downloadWeeklyReport = function() {
            const outputEl = document.getElementById('weeklyReportOutput');
            if (!outputEl || !outputEl.value) {
                showCustomMessage('âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const blob = new Blob([outputEl.value], { type: 'text/markdown;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `weekly_report_${Date.now()}.md`;
            link.click();
            URL.revokeObjectURL(url);
            
            showCustomMessage('ğŸ’¾ ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }
        
        // åˆ†æã‚¿ãƒ–ç”¨ã®é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé–¢æ•°
        window.generateWeeklyReportFromAnalytics = function() {
            const range = document.getElementById('reportRangeAnalytics')?.value || '7d';
            const allTrades = loadFullTrades();
            const filteredTrades = filterTradesByRange(allTrades, range);
            
            if (filteredTrades.length === 0) {
                showCustomMessage('âš ï¸ æŒ‡å®šæœŸé–“ã«ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const summary = summarizeTrades(filteredTrades);
            const rangeLabel = getRangeLabel(range);
            const markdown = makeWeeklyMarkdown(rangeLabel, filteredTrades, summary);
            
            const outputEl = document.getElementById('weeklyReportOutputAnalytics');
            if (outputEl) {
                outputEl.value = markdown;
            }
            
            showCustomMessage('âœ… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
        }
        
        window.copyWeeklyReportFromAnalytics = function() {
            const outputEl = document.getElementById('weeklyReportOutputAnalytics');
            if (!outputEl || !outputEl.value) {
                showCustomMessage('âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            outputEl.select();
            document.execCommand('copy');
            showCustomMessage('ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
        }
        
        window.downloadWeeklyReportFromAnalytics = function() {
            const outputEl = document.getElementById('weeklyReportOutputAnalytics');
            if (!outputEl || !outputEl.value) {
                showCustomMessage('âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const blob = new Blob([outputEl.value], { type: 'text/markdown;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `weekly_report_${Date.now()}.md`;
            link.click();
            URL.revokeObjectURL(url);
            
            showCustomMessage('ğŸ’¾ ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        // åˆæœŸåŒ–ï¼ˆLocalStorageï¼‰
        function initializeLocalApp() {
            initializePlan();
            try {
                const savedId = localStorage.getItem('fx_user_id');
                userId = savedId || crypto.randomUUID();
                if (!savedId) localStorage.setItem('fx_user_id', userId);
                document.getElementById('user-info').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`;
            } catch (_) {
                userId = 'local-user';
                document.getElementById('user-info').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`;
            }
            setupRealtimeListener();
            hideLoading();
            updateAdDisplay();
        }

        // ãƒ­ãƒ¼ãƒ‰ç”»é¢éè¡¨ç¤º
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç”¨ãƒ­ãƒ¼ãƒ‰ï¼ˆLocalStorageï¼‰
        function setupRealtimeListener() {
            const stored = loadFullTrades();
            const trades = stored.map(t => {
                const dateObj = new Date(typeof t.timestamp === 'number' ? t.timestamp : Date.now());
                return {
                    id: t.id,
                    dateObj,
                    date: dateObj.toLocaleString('ja-JP'),
                    pair: t.pair,
                    direction: t.direction,
                    lotSize: Number(t.lotSize) || 0,
                    entryPrice: Number(t.entryPrice) || 0,
                    exitPrice: Number(t.exitPrice) || 0,
                    pips: Number(t.pips) || 0,
                    pnl: Number(t.pnl) || 0,
                    chartUrl: t.chartUrl || '',
                    notes: t.notes || ''
                };
            });
            trades.sort((a,b) => b.dateObj - a.dateObj);
                tradeDataCache = trades; 
                renderTrades(trades);
                calculateStats(trades);

            // AIç”¨ã®ç°¡æ˜“ãƒ‡ãƒ¼ã‚¿ã¸åŒæœŸ
            try {
                const lsTrades = trades.map(t => ({
                    date: t.dateObj instanceof Date && !isNaN(t.dateObj) ? t.dateObj.toISOString().slice(0,10) : '',
                            pair: t.pair || '',
                            side: t.direction === 'buy' ? 'è²·' : 'å£²',
                    lot: t.lotSize,
                            entry: t.entryPrice,
                            exit: t.exitPrice,
                            pnl: t.pnl,
                    rule: 'â€”',
                            memo: t.notes || ''
                }));
                    localStorage.setItem('fx_trades', JSON.stringify(lsTrades));
                } catch (e) {
                    console.warn('LocalStorageã¸ã®åŒæœŸã«å¤±æ•—:', e);
                }
        }

        function loadFullTrades() {
            try {
                const raw = localStorage.getItem(FULL_TRADES_KEY);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch(_) { return []; }
        }
        function saveFullTrades(list) {
            localStorage.setItem(FULL_TRADES_KEY, JSON.stringify(list));
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆä»£æ›¿ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showCustomMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            
            messageBox.className = `p-3 rounded-lg text-center mt-4 mb-4 transition-all duration-300 ${
                type === 'success' ? 'text-green-700' :
                type === 'error' ? 'text-red-700' :
                'text-blue-400'
            }`; 
            
            messageBox.style.opacity = '1';
            messageBox.style.background = 'rgba(0, 0, 0, 0.5)'; 
            messageBox.style.border = '1px solid rgba(255, 255, 255, 0.08)';

            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 5000);
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚’LocalStorageã«ä¿å­˜
        window.recordTrade = async function() {
            const pair = document.getElementById('pair').value;
            const direction = document.getElementById('direction').value;
            const lotSize = parseFloat(document.getElementById('lotSize').value);
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const exitPrice = parseFloat(document.getElementById('exitPrice').value);
            const pips = parseFloat(document.getElementById('pips').value);
            const pnl = parseFloat(document.getElementById('pnl').value);
            const chartUrl = '';
            const notes = document.getElementById('notes').value;

            // å¿…é ˆå…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!pair || !direction || isNaN(lotSize) || isNaN(entryPrice) || isNaN(exitPrice) || isNaN(pips) || isNaN(pnl)) {
                showCustomMessage('å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            const list = loadFullTrades();
            const newTrade = {
                id: crypto.randomUUID(),
                pair,
                direction,
                lotSize,
                entryPrice,
                exitPrice,
                pips,
                pnl,
                chartUrl,
                notes,
                timestamp: Date.now(),
                userId
            };
            try {
                list.push(newTrade);
                saveFullTrades(list);
                showCustomMessage('ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼', 'success');
                document.getElementById('tradeForm').reset();
                try {
                    if (Array.isArray(pendingFormImages) && pendingFormImages.length > 0) {
                        saveTradeImages(newTrade.id, pendingFormImages.slice(0,3));
                        pendingFormImages = [];
                        try { localStorage.removeItem('fx_temp_form_images'); } catch(_) {}
                        const cont = document.getElementById('imagePreviewContainer');
                        if (cont) cont.innerHTML = '';
                    }
                } catch (_) {}
                setupRealtimeListener();
                // ã‚°ãƒ©ãƒ•å†æç”»
                if (typeof buildCharts === 'function') {
                    buildCharts();
                }
            } catch (e) {
                console.error('ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                showCustomMessage('è¨˜éŒ²ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚’HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderTrades(trades) {
            console.log('renderTrades called with', trades.length, 'trades');
            const tableBody = document.getElementById('tradeHistoryBody');
            tableBody.innerHTML = ''; 

            if (trades.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="p-3 text-center text-gray-500">ã¾ã ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                return;
            }

            trades.forEach((trade, index) => {
                const pnlClass = trade.pnl > 0 ? 'text-green-400 font-bold' : trade.pnl < 0 ? 'text-red-400 font-bold' : 'text-gray-400';
                const row = tableBody.insertRow();
                row.className = 'border-b border-gray-800 hover:bg-gray-800/50 transition-colors text-sm cursor-pointer';
                
                // é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå­è¦ç´ ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ç„¡è¦–ï¼‰
                row.onclick = (e) => {
                    console.log('Row clicked:', trade.id, e.target);
                    // ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ç„¡è¦–
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'IMG' || e.target.closest('button')) {
                        console.log('Ignoring click on button/image');
                        return;
                    }
                    console.log('Calling handleSelectTrade:', trade.id);
                    handleSelectTrade(trade.id);
                }; 

                row.insertCell().textContent = trade.date;
                row.insertCell().textContent = trade.pair;
                row.insertCell().textContent = trade.direction === 'buy' ? 'è²·ã„' : 'å£²ã‚Š';
                row.insertCell().textContent = trade.lotSize.toFixed(2);
                const priceDecimals = trade.pair.includes('JPY') ? 3 : 5;
                row.insertCell().textContent = trade.entryPrice.toFixed(priceDecimals);
                row.insertCell().textContent = trade.exitPrice.toFixed(priceDecimals);
                row.insertCell().textContent = trade.pips.toFixed(2);

                const pnlCell = row.insertCell();
                pnlCell.className = pnlClass;
                pnlCell.textContent = trade.pnl.toFixed(0).toLocaleString() + 'å††'; 

                const imgCell = row.insertCell();
                imgCell.className = 'py-2';
                const imgWrap = document.createElement('div');
                imgWrap.className = 'flex items-center gap-2 flex-wrap';
                const btn = document.createElement('button');
                btn.className = 'btn-secondary px-2 py-1 text-xs';
                btn.textContent = 'ğŸ“· ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’è¿½åŠ ';
                btn.onclick = () => openImageManageModal(trade.id);
                imgWrap.appendChild(btn);

                const thumbs = loadTradeThumbnails(trade.id);
                if (thumbs.length > 0) {
                    thumbs.slice(0,3).forEach((t, idx) => {
                        const im = document.createElement('img');
                        im.src = t;
                        im.alt = `thumb-${idx+1}`;
                        im.width = 40; im.height = 40;
                        im.className = 'rounded object-cover cursor-pointer border border-gray-700';
                        im.onclick = () => openImageViewer(trade.id, idx);
                        imgWrap.appendChild(im);
                    });
                } else {
                    const none = document.createElement('span');
                    none.className = 'text-gray-500 text-xs';
                    none.textContent = 'ãªã—';
                    imgWrap.appendChild(none);
                }
                imgCell.appendChild(imgWrap);
            });
            
            console.log('âœ… Trade rows rendered with click events');
        }
        
        // çµ±è¨ˆæƒ…å ±ã®è¨ˆç®—ã¨è¡¨ç¤º
        function calculateStats(trades) {
            if (trades.length === 0) {
                document.getElementById('totalTrades').textContent = 0;
                document.getElementById('winRate').textContent = '0.00%';
                document.getElementById('profitFactor').textContent = '0.00';
                document.getElementById('totalPnl').textContent = '0 å††';
                
                document.getElementById('totalPnl').className = 'text-2xl font-bold text-gray-400';
                return;
            }

            const totalTrades = trades.length;
            let winningTrades = 0;
            let totalPnl = 0;
            let grossProfit = 0;
            let grossLoss = 0;

            trades.forEach(trade => {
                totalPnl += trade.pnl;
                if (trade.pnl > 0) {
                    winningTrades++;
                    grossProfit += trade.pnl;
                } else {
                    grossLoss += Math.abs(trade.pnl);
                }
            });

            const winRate = (winningTrades / totalTrades) * 100;
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? '---' : '0.00');

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = `${winRate.toFixed(2)}%`;
            document.getElementById('profitFactor').textContent = profitFactor === '---' ? 'âˆ' : profitFactor.toFixed(2);
            
            const totalPnlElement = document.getElementById('totalPnl');
            totalPnlElement.textContent = `${totalPnl.toFixed(0).toLocaleString()} å††`;
            totalPnlElement.className = totalPnl >= 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
        }

        // è³‡é‡‘ç®¡ç†ï¼šãƒ­ãƒƒãƒˆã‚µã‚¤ã‚ºè¨ˆç®—
        window.calculateLotSize = function() {
            const balance = parseFloat(document.getElementById('accountBalance').value);
            const riskPct = parseFloat(document.getElementById('riskPercentage').value);
            const stopLossPips = parseFloat(document.getElementById('stopLossPips').value);
            const pipValuePerLot = parseFloat(document.getElementById('pipValuePerLot').value);

            if (isNaN(balance) || balance <= 0 || isNaN(riskPct) || riskPct <= 0 || isNaN(stopLossPips) || stopLossPips <= 0 || isNaN(pipValuePerLot) || pipValuePerLot <= 0) {
                document.getElementById('calculatedLotSize').textContent = 'ç„¡åŠ¹ãªå…¥åŠ›å€¤';
                document.getElementById('calculatedLotSize').className = 'text-xl text-red-400 font-semibold';
                document.getElementById('riskAmountDisplay').textContent = '';
                return;
            }

            const riskAmount = balance * (riskPct / 100);
            const calculatedLotSize = riskAmount / (stopLossPips * pipValuePerLot);

            const resultElement = document.getElementById('calculatedLotSize');
            resultElement.textContent = calculatedLotSize.toFixed(2) + ' ãƒ­ãƒƒãƒˆ';
            resultElement.className = 'text-2xl text-blue-400 font-bold';
            
            document.getElementById('riskAmountDisplay').textContent = `è¨±å®¹ãƒªã‚¹ã‚¯é¡: ${riskAmount.toLocaleString()} å††ç›¸å½“`;
            document.getElementById('riskAmountDisplay').className = 'text-sm text-gray-400 mt-1';
            
            showCustomMessage(`é©åˆ‡ãªãƒ­ãƒƒãƒˆã‚µã‚¤ã‚ºã¯ ${calculatedLotSize.toFixed(2)} ãƒ­ãƒƒãƒˆã§ã™ã€‚`, 'info');
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        window.exportToCSV = function() {
            if (tradeDataCache.length === 0) {
                showCustomMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            const headers = ["æ—¥ä»˜", "é€šè²¨ãƒšã‚¢", "æ–¹å‘", "ãƒ­ãƒƒãƒˆæ•°", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼", "ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼", "ç²å¾—/æå¤± pips", "æç›Š(å††)", "ãƒãƒ£ãƒ¼ãƒˆURL", "ãƒ¡ãƒ¢"];
            
            const csvRows = tradeDataCache.map(trade => {
                const dateString = trade.dateObj.toISOString(); 
                const directionText = trade.direction === 'buy' ? 'è²·ã„' : 'å£²ã‚Š';
                const imgCount = getTradeImages(trade.id).length;
                const memoWithImages = trade.notes ? trade.notes : '';
                const memoFinal = imgCount > 0 ? (memoWithImages + ` [ç”»åƒ${imgCount}æšã‚ã‚Š]`) : memoWithImages;
                
                return [
                    `"${dateString}"`, 
                    `"${trade.pair}"`,
                    `"${directionText}"`,
                    trade.lotSize,
                    trade.entryPrice,
                    trade.exitPrice,
                    trade.pips,
                    trade.pnl,
                    `"${trade.chartUrl || ''}"`,
                    `"${(memoFinal ? memoFinal.replace(/"/g, '""') : '')}"` 
                ].join(',');
            });
            
            const csvContent = headers.join(',') + '\n' + csvRows.join('\n');
            const blob = new Blob(['\ufeff', csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `fx_trade_history_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showCustomMessage('ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ã‚’CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚', 'success');
            } else {
                showCustomMessage('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
        window.showPage = function(pageId) {
            currentPage = pageId;
            const pages = ['money-management', 'trade-recording', 'history-analysis'];
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (pageId === id) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°åˆ‡ã‚Šæ›¿ãˆ
            pages.forEach(id => {
                const navItem = document.getElementById(`nav-${id}`);
                const icon = navItem.querySelector('svg');

                if (pageId === id) {
                    navItem.classList.add('nav-button-active');
                    icon.classList.add('text-blue-400'); 
                    navItem.classList.remove('text-gray-400');
                } else {
                    navItem.classList.remove('nav-button-active');
                    icon.classList.remove('text-blue-400');
                    navItem.classList.add('text-gray-400');
                }
            });
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        let currentTab = 'record';
        
        window.switchTab = function(tabName) {
            currentTab = tabName;
            localStorage.setItem('currentTab', tabName);
            
            console.log('Switching to tab:', tabName);
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            const btn = document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`);
            if (btn) btn.classList.add('active');
            
            const content = document.getElementById(`tab-${tabName}`);
            if (content) {
                content.classList.add('active');
                
                // ã‚¿ãƒ–ã”ã¨ã®åˆæœŸåŒ–å‡¦ç†
                if (tabName === 'record') {
                    console.log('âœ… Record tab activated');
                    // å°‘ã—é…å»¶ã•ã›ã¦ç¢ºå®Ÿã«DOMãŒæº–å‚™ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
                    setTimeout(() => {
                        loadAndDisplayTrades();
                    }, 100);
                } else if (tabName === 'analytics') {
                    updateAnalytics();
                } else if (tabName === 'settings') {
                    updateSettingsDisplay();
                }
            }
        }
        
        function loadAndDisplayTrades() {
            console.log('loadAndDisplayTrades called');
            const trades = loadFullTrades();
            console.log('Trades loaded:', trades.length);
            
            if (trades.length === 0) {
                console.log('No trades to display');
            } else {
                console.log('Displaying trades...');
            }
            
            // æ—¢å­˜ã®setupRealtimeListenerãŒãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹
            setupRealtimeListener();
        }
        
        function updateAnalytics() {
            const trades = loadFullTrades();
            const summary = summarizeTrades(trades);
            
            const totalEl = document.getElementById('analyticsTotalTrades');
            const winEl = document.getElementById('analyticsWinRate');
            const pnlEl = document.getElementById('analyticsTotalPnl');
            const ruleEl = document.getElementById('analyticsRuleKeepRate');
            
            if (totalEl) totalEl.textContent = summary.count;
            if (winEl) winEl.textContent = `${summary.winRate}%`;
            if (pnlEl) pnlEl.textContent = `Â¥${summary.pnlSum.toLocaleString()}`;
            if (ruleEl) ruleEl.textContent = `${summary.ruleRate}%`;
            
            // ã‚°ãƒ©ãƒ•å†æç”»
            buildCharts();
        }
        
        // æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        function groupByDate(trades) {
            const map = {};
            
            trades.forEach(trade => {
                const date = new Date(trade.date || trade.createdAt || new Date());
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                if (!map[key]) {
                    map[key] = { pnl: 0, count: 0, wins: 0 };
                }
                
                const pnl = Number(trade.pnl) || Number(trade.profit) || 0;
                map[key].pnl += pnl;
                map[key].count += 1;
                if (pnl >= 0) map[key].wins += 1;
            });
            
            const keys = Object.keys(map).sort();
            return keys.map(key => ({ date: key, ...map[key] }));
        }
        
        // ã‚°ãƒ©ãƒ•æç”»
        function buildCharts() {
            const trades = loadFullTrades();
            
            if (trades.length === 0) {
                console.log('ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“');
                return;
            }
            
            // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartInstances = {};
            
            // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿
            const daily = groupByDate(trades);
            
            // 1. æ—¥åˆ¥æç›Šã‚°ãƒ©ãƒ•
            const ctx1 = document.getElementById('chartDailyPnl');
            if (ctx1) {
                chartInstances.dailyPnl = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: daily.map(d => d.date),
                        datasets: [{
                            label: 'æ—¥åˆ¥æç›Š (å††)',
                            data: daily.map(d => d.pnl),
                            backgroundColor: daily.map(d => 
                                d.pnl >= 0 ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)'
                            ),
                            borderColor: daily.map(d => 
                                d.pnl >= 0 ? 'rgba(46, 204, 113, 1)' : 'rgba(231, 76, 60, 1)'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `æç›Š: Â¥${context.parsed.y.toLocaleString()}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => `Â¥${value.toLocaleString()}`
                                }
                            }
                        }
                    }
                });
            }
            
            // 2. å‹ç‡æ¨ç§»ã‚°ãƒ©ãƒ•
            const ctx2 = document.getElementById('chartWinRate');
            if (ctx2) {
                chartInstances.winRate = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: daily.map(d => d.date),
                        datasets: [{
                            label: 'å‹ç‡ (%)',
                            data: daily.map(d => d.count > 0 ? Math.round((d.wins / d.count) * 100) : 0),
                            borderColor: 'rgba(91, 188, 255, 1)',
                            backgroundColor: 'rgba(91, 188, 255, 0.1)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `å‹ç‡: ${context.parsed.y}%`
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: (value) => `${value}%`
                                }
                            }
                        }
                    }
                });
            }
            
            // 3. é€šè²¨ãƒšã‚¢åˆ¥æˆç¸¾
            const byPair = {};
            trades.forEach(trade => {
                const pair = trade.pair || trade.symbol || trade.currencyPair || 'N/A';
                if (!byPair[pair]) {
                    byPair[pair] = { pnl: 0, count: 0, wins: 0 };
                }
                const pnl = Number(trade.pnl) || Number(trade.profit) || 0;
                byPair[pair].pnl += pnl;
                byPair[pair].count += 1;
                if (pnl >= 0) byPair[pair].wins += 1;
            });
            
            const pairKeys = Object.keys(byPair).sort((a, b) => byPair[b].pnl - byPair[a].pnl);
            
            const ctx3 = document.getElementById('chartByPair');
            if (ctx3) {
                chartInstances.byPair = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: pairKeys,
                        datasets: [
                            {
                                label: 'åˆè¨ˆæç›Š (å††)',
                                data: pairKeys.map(k => byPair[k].pnl),
                                backgroundColor: 'rgba(155, 89, 182, 0.7)',
                                borderColor: 'rgba(155, 89, 182, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'å‹ç‡ (%)',
                                data: pairKeys.map(k => 
                                    byPair[k].count > 0 ? Math.round((byPair[k].wins / byPair[k].count) * 100) : 0
                                ),
                                type: 'line',
                                borderColor: 'rgba(241, 196, 15, 1)',
                                backgroundColor: 'rgba(241, 196, 15, 0.1)',
                                borderWidth: 2,
                                yAxisID: 'y1',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        if (context.datasetIndex === 0) {
                                            return `æç›Š: Â¥${context.parsed.y.toLocaleString()}`;
                                        } else {
                                            return `å‹ç‡: ${context.parsed.y}%`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => `Â¥${value.toLocaleString()}`
                                }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                min: 0,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    callback: (value) => `${value}%`
                                }
                            }
                        }
                    }
                });
            }
            
            // 4. æ™‚é–“å¸¯åˆ¥å‹ç‡
            const byHour = Array(24).fill(0).map(() => ({ count: 0, wins: 0 }));
            trades.forEach(trade => {
                const date = new Date(trade.date || trade.createdAt || new Date());
                const hour = date.getHours();
                const pnl = Number(trade.pnl) || Number(trade.profit) || 0;
                byHour[hour].count += 1;
                if (pnl >= 0) byHour[hour].wins += 1;
            });
            
            const ctx4 = document.getElementById('chartByHour');
            if (ctx4) {
                chartInstances.byHour = new Chart(ctx4, {
                    type: 'bar',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}æ™‚`),
                        datasets: [{
                            label: 'å‹ç‡ (%)',
                            data: byHour.map(h => 
                                h.count > 0 ? Math.round((h.wins / h.count) * 100) : 0
                            ),
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `å‹ç‡: ${context.parsed.y}% (${byHour[context.dataIndex].count}å›)`
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: (value) => `${value}%`
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function updateSettingsDisplay() {
            // ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
            const planDisplay = document.getElementById('currentPlanDisplaySettings');
            if (planDisplay) {
                const plan = getUserPlan();
                planDisplay.textContent = plan === 'pro' ? 'Proç‰ˆ' : 'ç„¡æ–™ç‰ˆ';
            }
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¨­å®šã‚’æ›´æ–°
            const size = localStorage.getItem('windowSize') || 'half';
            const position = localStorage.getItem('windowPosition') || 'right';
            const autoResize = localStorage.getItem('autoResizeOriginal') === 'true';
            
            const sizeSelect = document.getElementById('windowSizePreferenceSettings');
            const positionSelect = document.getElementById('windowPositionPreferenceSettings');
            const autoResizeCheck = document.getElementById('autoResizeOriginalSettings');
            const autoResizeBg = document.getElementById('autoResizeToggleBgSettings');
            const autoResizeThumb = document.getElementById('autoResizeToggleThumbSettings');
            
            if (sizeSelect) sizeSelect.value = size;
            if (positionSelect) positionSelect.value = position;
            if (autoResizeCheck) autoResizeCheck.checked = autoResize;
            if (autoResizeBg) autoResizeBg.style.background = autoResize ? '#10b981' : '#ef4444';
            if (autoResizeThumb) autoResizeThumb.style.transform = autoResize ? 'translateX(16px)' : 'translateX(0)';
            
            // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å®šã‚’æ›´æ–°
            const surveyToggle = document.getElementById('surveyToggleSettings');
            const surveyBg = document.getElementById('surveyToggleBgSettings');
            const surveyThumb = document.getElementById('surveyToggleThumbSettings');
            if (surveyToggle && surveyBg && surveyThumb) {
                const disabled = localStorage.getItem('surveyDisabled') === '1';
                surveyToggle.checked = !disabled;
                surveyBg.style.background = disabled ? '#ef4444' : '#10b981';
                surveyThumb.style.transform = disabled ? 'translateX(0)' : 'translateX(16px)';
            }
            
            // é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ã‚’æ›´æ–°
            updateContinuousModeDisplay();
        }

        // åˆæœŸãƒšãƒ¼ã‚¸è¡¨ç¤ºï¼ˆLocalStorageç‰ˆï¼‰
        window.onload = () => {
            initializeLocalApp();
            setupFormImageButtons();
            loadPendingFormImagesFromLocal();
            
            // å‰å›ã®ã‚¿ãƒ–ã‚’å¾©å…ƒ
            const savedTab = localStorage.getItem('currentTab') || 'record';
            switchTab(savedTab);
        };

        // ===== AIåˆ†ææ©Ÿèƒ½ =====
        let lastGeneratedPrompt = '';
        function getTradesFromLocalStorage() {
            try {
                const raw = localStorage.getItem('fx_trades');
                if (!raw) return [];
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function convertTradesToCsv(trades) {
            const headers = ['æ—¥ä»˜','é€šè²¨ãƒšã‚¢','å£²è²·','ãƒ­ãƒƒãƒˆæ•°','ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼','æ±ºæ¸ˆä¾¡æ ¼','æç›Š','ãƒ«ãƒ¼ãƒ«éµå®ˆ','ãƒ¡ãƒ¢'];
            const rows = trades.map(t => {
                const safeMemo = String(t.memo || '').replace(/"/g, '""');
                const pnlStr = typeof t.pnl === 'number' ? (t.pnl >= 0 ? `+${t.pnl}` : `${t.pnl}`) : String(t.pnl || '');
                return [
                    t.date || '',
                    t.pair || '',
                    t.side || '',
                    t.lot ?? '',
                    t.entry ?? '',
                    t.exit ?? '',
                    pnlStr,
                    (t.rule === true || t.rule === 'â—‹') ? 'â—‹' : (t.rule === false || t.rule === 'Ã—') ? 'Ã—' : (t.rule || 'â€”'),
                    `"${safeMemo}` + `"`
                ].join(',');
            });
            return headers.join(',') + '\n' + rows.join('\n');
        }

        function buildAiPrompt(csv) {
            const type = getLastPromptType();
            return generatePromptByType(type, csv);
        }

        function generatePromptByType(type, csv) {
            const prompts = {
                basic: `ã‚ãªãŸã¯FXæˆ¦ç•¥ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‡ãƒ¼ã‚¿ã€‘
${csv}

ã€å‡ºåŠ›å½¢å¼ã€‘
1. å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ™‚é–“å¸¯/é€šè²¨ãƒšã‚¢/ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç†ç”±åˆ¥ï¼‰
2. è² ã‘ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ«ãƒ¼ãƒ«é€¸è„±/æ„Ÿæƒ…ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼‰
3. æ”¹å–„ã™ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³3ã¤
4. æ³¨æ„ã™ã¹ãå‚¾å‘

å‰ç½®ãä¸è¦ã€‚ç®‡æ¡æ›¸ãã§æ˜ç¢ºã«ã€‚`,

                trend: `ã‚ãªãŸã¯ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æå°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚©ãƒ­ãƒ¼æˆ¦ç•¥ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‡ãƒ¼ã‚¿ã€‘
${csv}

ã€å‡ºåŠ›å½¢å¼ã€‘
1. ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®šã®ç²¾åº¦ï¼ˆæ­£ã—ãèªè­˜ã§ãã¦ã„ã‚‹ã‹ï¼‰
2. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ†æï¼ˆé…å»¶/æ—©ã™ãã®å‚¾å‘ï¼‰
3. åˆ©ç¢ºãƒ»æåˆ‡ã‚Šã®æœ€é©åŒ–ææ¡ˆ
4. æ¬¡å›ã®ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤æ–­ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æ•°å€¤ã¨å…·ä½“ä¾‹ã‚’äº¤ãˆã¦ã€‚`,

                range: `ã‚ãªãŸã¯ãƒ¬ãƒ³ã‚¸å–å¼•å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ¬ãƒ³ã‚¸é€†å¼µã‚Šæˆ¦ç•¥ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‡ãƒ¼ã‚¿ã€‘
${csv}

ã€å‡ºåŠ›å½¢å¼ã€‘
1. ãƒ¬ãƒ³ã‚¸èªè­˜ã®ç²¾åº¦
2. åç™º/ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤æ–­ã®æ¤œè¨¼
3. ãƒ€ãƒã‚·å›é¿ã®ãƒã‚¤ãƒ³ãƒˆ
4. ãƒ¬ãƒ³ã‚¸å¹…ã®é©åˆ‡æ€§

å…·ä½“çš„ãªæ”¹å–„ç­–ã‚’å«ã‚ã¦ã€‚`,

                breakout: `ã‚ãªãŸã¯ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆåˆ†æå°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‡ãƒ¼ã‚¿ã€‘
${csv}

ã€å‡ºåŠ›å½¢å¼ã€‘
1. ãƒ–ãƒ¬ã‚¤ã‚¯å‰ã®åœ§ç¸®ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
2. å¤±æ•—ãƒ–ãƒ¬ã‚¤ã‚¯ï¼ˆãƒ€ãƒã‚·ï¼‰ã®ç‰¹å¾´
3. å‡ºæ¥é«˜/ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨ã®ç›¸é–¢
4. å†ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶ã®ææ¡ˆ

ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå…·ä½“çš„ãªæŒ‡æ‘˜ã‚’ã€‚`,

                mental: `ã‚ãªãŸã¯è¡Œå‹•ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‹ã‚‰ãƒ¡ãƒ³ã‚¿ãƒ«é¢ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‡ãƒ¼ã‚¿ã€‘
${csv}

ã€å‡ºåŠ›å½¢å¼ã€‘
1. é€£æ•—å¾Œã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
2. ãƒã‚¸ãƒã‚¸ç—…/ãƒªãƒ™ãƒ³ã‚¸ãƒˆãƒ¬ãƒ¼ãƒ‰å…†å€™
3. æ„Ÿæƒ…ãƒˆãƒªã‚¬ãƒ¼ã®ç‰¹å®š
4. ãƒ¡ãƒ³ã‚¿ãƒ«æ”¹å–„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

è¡Œå‹•å¤‰å®¹ã«ã¤ãªãŒã‚‹å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã€‚`
            };
            return prompts[type] || prompts.basic;
        }

        function getLastPromptType() {
            try { return localStorage.getItem('lastPromptType') || 'basic'; } catch(_) { return 'basic'; }
        }
        function setLastPromptType(type) {
            try { localStorage.setItem('lastPromptType', type); } catch(_) {}
        }

        async function copyToClipboardWithFallback(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (e) {
                    // fallthrough to fallback
                }
            }
            // Fallback: create textarea and select
            try {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.top = '-1000px';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                const ok = document.execCommand('copy');
                if (!ok) {
                    // è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    showAiPromptFallback(text);
                    document.body.removeChild(ta);
                    return false;
                }
                document.body.removeChild(ta);
                return true;
            } catch (e) {
                showAiPromptFallback(text);
                return false;
            }
        }

        function showAiPromptFallback(text) {
            const area = document.getElementById('ai-fallback-area');
            const modal = document.getElementById('ai-modal');
            area.value = text;
            area.focus();
            area.select();
            modal.classList.remove('hidden');
        }

        // æ—¢å®šAIã®ç®¡ç†
        function setPreferredAI(type) {
            try { localStorage.setItem('preferredAI', type); } catch(_) {}
        }
        function getPreferredAI() {
            try { return localStorage.getItem('preferredAI') || null; } catch(_) { return null; }
        }
        window.resetPreferredAI = function() {
            const confirmed = confirm('æ—¢å®šAIã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\næ¬¡å›ã‹ã‚‰é¸æŠç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
            if (confirmed) {
                try {
                    localStorage.removeItem('preferredAI');
                    showCustomMessage('âœ… æ—¢å®šAIè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
                } catch(_) {
                    showCustomMessage('âŒ ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }
        function displayNameForAI(type) {
            const map = { chatgpt: 'ChatGPT', gemini: 'Gemini', claude: 'Claude' };
            return map[type] || type;
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä»˜ããƒˆãƒ¼ã‚¹ãƒˆï¼ˆæ”¹å–„ç‰ˆï¼‰
        function showActionToast(message, actionLabel, actionHandler, secondaryLabel, secondaryHandler) {
            // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‰Šé™¤
            const existing = document.querySelector('.action-toast');
            if (existing) existing.remove();
            
            const position = getToastPosition();
            const toast = document.createElement('div');
            toast.className = `action-toast toast-${position}`;
            toast.innerHTML = `<span class="toast-message">${message}</span>`;
            
            if (actionLabel && actionHandler) {
                const btn = document.createElement('button');
                btn.className = 'toast-action';
                btn.textContent = actionLabel;
                btn.onclick = () => {
                    actionHandler();
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                };
                toast.appendChild(btn);
            }
            
            if (secondaryLabel && secondaryHandler) {
                const btn2 = document.createElement('button');
                btn2.className = 'toast-action';
                btn2.textContent = secondaryLabel;
                btn2.onclick = () => {
                    secondaryHandler();
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                };
                toast.appendChild(btn2);
            }
            
            document.body.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });
            
            // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        window.handleAiAnalyze = async function() {
            const trades = getTradesFromLocalStorage();
            if (!trades || trades.length === 0) {
                showCustomMessage('âš ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            const csv = convertTradesToCsv(trades);
            const prompt = buildAiPrompt(csv);
            lastGeneratedPrompt = prompt;
            latestPromptText = prompt; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜

            const btn = document.getElementById('btn-ai-analyze');
            const originalHtml = btn ? btn.innerHTML : '';

            const copied = await copyToClipboardWithFallback(prompt);
            if (copied) {
                // ãƒ­ã‚°è¨˜éŒ²
                const promptType = getLastPromptType();
                logEvent({
                    type: 'prompt_use',
                    promptType,
                    device: isMobile ? 'mobile' : 'desktop',
                    actions: { copied: true }
                });
                
                // ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã®å¼·åŒ–ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                if (navigator.vibrate) try { navigator.vibrate(200); } catch (_) {}
                playFeedbackBeep();

                if (btn) {
                    // ç·‘è‰²ã«å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    btn.classList.add('bg-green-500','shadow-[0_0_0_0_rgba(34,197,94,0.9)]');
                    btn.style.boxShadow = '0 0 0 0 rgba(34,197,94,0.9)';
                    btn.style.transition = 'box-shadow 0.6s ease-out, background-color 0.2s ease-out';
                    setTimeout(() => {
                        btn.style.boxShadow = '0 0 24px 6px rgba(34,197,94,0.45)';
                    }, 10);

                    // ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€ç¬å·®ã—æ›¿ãˆ
                    btn.innerHTML = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';

                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³
                    const pop = document.createElement('span');
                    pop.textContent = 'âœ…';
                    pop.className = 'absolute -top-4 -right-2 text-2xl';
                    pop.style.transition = 'transform 250ms ease, opacity 300ms ease';
                    pop.style.transform = 'translateY(8px) scale(0.6)';
                    pop.style.opacity = '0';
                    btn.appendChild(pop);
                    requestAnimationFrame(() => {
                        pop.style.transform = 'translateY(-8px) scale(1)';
                        pop.style.opacity = '1';
                    });

                    setTimeout(() => {
                        if (btn && originalHtml) btn.innerHTML = originalHtml;
                        btn.classList.remove('bg-green-500');
                        pop.remove();
                        btn.style.boxShadow = '';
                    }, 1000);
                }

                // åˆ©ç”¨å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                incrementUseCount();
                
                // åˆå›ã¯å·¨å¤§ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€2å›ç›®ä»¥é™ã¯ãƒˆãƒ¼ã‚¹ãƒˆã®ã¿
                const completed = localStorage.getItem('ai_tutorial_completed') === '1';
                const pref = getPreferredAI();
                if (pref) {
                    const promptType = getLastPromptType();
                    
                    // å®Œäº†ã‚µãƒãƒªãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤º
                    showCompletionSummary({
                        promptType: promptType,
                        ai: pref,
                        imageCount: 0,
                        logsOk: true
                    });
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã¨ã‚¿ãƒ–ã‚’é–‹ã
                    setTimeout(() => {
                        showProgressToast('ğŸš€ AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã„ã¦ã„ã¾ã™...');
                        
                        setTimeout(() => {
                            const opened = openAITab(pref);
                            
                            // ãƒ­ã‚°ã«ã‚¿ãƒ–ã‚ªãƒ¼ãƒ—ãƒ³æƒ…å ±ã‚’è¿½åŠ 
                            const logs = JSON.parse(localStorage.getItem('fx_logs') || '[]');
                            if (logs.length > 0) {
                                logs[logs.length - 1].actions.tabOpened = !!opened;
                                logs[logs.length - 1].actions.ai = pref;
                                localStorage.setItem('fx_logs', JSON.stringify(logs));
                            }
                            
                            // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¡¨ç¤ºåˆ¤å®šï¼ˆ3ç§’å¾Œï¼‰
                            setTimeout(() => {
                                if (shouldShowSurvey()) {
                                    showSurvey();
                                }
                            }, 3000);
                        }, 500);
                    }, 1500);
                } else {
                    if (completed) {
                        showCustomMessage('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚AIã‚’é¸ã‚“ã§é–‹ãã€Ctrl+V ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚', 'success');
                        openAiSelectModal();
                    } else {
                        showAiTutorialPopup();
                    }
                    
                    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆ3ç§’å¾Œï¼‰
                    setTimeout(() => {
                        if (shouldShowSurvey()) {
                            showSurvey();
                        }
                    }, 3000);
                }
            }
        }

        function showAiTutorialPopup() {
            const overlay = document.getElementById('ai-copy-tutorial');
            if (!overlay) return;
            overlay.classList.remove('hidden');
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼‰
            const ack = document.getElementById('ai-copy-tutorial-ack');
            if (ack) ack.focus();
            
            const onAck = () => {
                const noshow = document.getElementById('ai-copy-tutorial-noshow');
                if (noshow && noshow.checked) {
                    localStorage.setItem('ai_tutorial_completed', '1');
                }
                overlay.classList.add('hidden');
                openAiSelectModal();
            };
            const ackBtn = document.getElementById('ai-copy-tutorial-ack');
            if (ackBtn) {
                ackBtn.onclick = onAck;
            }
        }

        window.closeAiModal = function() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        // AIé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡
        function openAiSelectModal() {
            const modal = document.getElementById('ai-select-modal');
            const card = document.getElementById('ai-select-card');
            modal.classList.remove('hidden');
            // åˆæœŸã¯é€æ˜ãƒ»ç¸®å° â†’ æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§è¡¨ç¤º
            card.classList.add('opacity-0','scale-95');
            requestAnimationFrame(() => {
                card.classList.remove('opacity-0','scale-95');
                card.classList.add('opacity-100','scale-100');
            });
            renderPromptLibrary();
            // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒˆã‚°ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateSurveyToggle();
            // ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
            updatePlanDisplay();
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¨­å®šã‚’æ›´æ–°
            updateWindowPreferencesDisplay();
        }

        function updatePlanDisplay() {
            const planDisplay = document.getElementById('currentPlanDisplay');
            if (planDisplay) {
                const plan = getUserPlan();
                planDisplay.textContent = plan === 'pro' ? 'Proç‰ˆ' : 'ç„¡æ–™ç‰ˆ';
            }
        }

        function updateWindowPreferencesDisplay() {
            const size = localStorage.getItem('windowSize') || 'half';
            const position = localStorage.getItem('windowPosition') || 'right';
            const autoResize = localStorage.getItem('autoResizeOriginal') === 'true';
            
            const sizeSelect = document.getElementById('windowSizePreference');
            const positionSelect = document.getElementById('windowPositionPreference');
            const autoResizeCheck = document.getElementById('autoResizeOriginal');
            const autoResizeBg = document.getElementById('autoResizeToggleBg');
            const autoResizeThumb = document.getElementById('autoResizeToggleThumb');
            
            if (sizeSelect) sizeSelect.value = size;
            if (positionSelect) positionSelect.value = position;
            if (autoResizeCheck) autoResizeCheck.checked = autoResize;
            if (autoResizeBg) autoResizeBg.style.background = autoResize ? '#10b981' : '#ef4444';
            if (autoResizeThumb) autoResizeThumb.style.transform = autoResize ? 'translateX(16px)' : 'translateX(0)';
        }

        function updateSurveyToggle() {
            const toggle = document.getElementById('surveyToggle');
            const bg = document.getElementById('surveyToggleBg');
            const thumb = document.getElementById('surveyToggleThumb');
            if (!toggle || !bg || !thumb) return;
            const disabled = localStorage.getItem('surveyDisabled') === '1';
            toggle.checked = !disabled;
            bg.style.background = disabled ? '#ef4444' : '#10b981';
            thumb.style.transform = disabled ? 'translateX(0)' : 'translateX(16px)';
        }

        function renderPromptLibrary() {
            const box = document.getElementById('prompt-library');
            if (!box) return;
            const current = getLastPromptType();
            const types = [
                { key: 'basic', icon: 'ğŸ“Š', name: 'åŸºæœ¬åˆ†æ', desc: 'ãƒãƒ©ãƒ³ã‚¹å‹ãƒ»åˆå¿ƒè€…æ¨å¥¨' },
                { key: 'trend', icon: 'ğŸ“ˆ', name: 'ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚©ãƒ­ãƒ¼å‹', desc: 'é †å¼µã‚Šæˆ¦ç•¥' },
                { key: 'range', icon: 'ğŸ”„', name: 'ãƒ¬ãƒ³ã‚¸é€†å¼µã‚Šå‹', desc: 'ãƒ¬ãƒ³ã‚¸æˆ¦ç•¥' },
                { key: 'breakout', icon: 'ğŸ’¥', name: 'ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆå‹', desc: 'ãƒ–ãƒ¬ã‚¤ã‚¯æˆ¦ç•¥' },
                { key: 'mental', icon: 'ğŸ§˜', name: 'ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ', desc: 'æ„Ÿæƒ…ãƒ»è¡Œå‹•æ”¹å–„' }
            ];
            box.innerHTML = '';
            types.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'prompt-type' + (t.key === current ? ' active' : '');
                btn.innerHTML = `<span class="icon">${t.icon}</span><span class="font-bold">${t.name}</span><span class="desc">${t.desc}</span>`;
                btn.onclick = () => {
                    setLastPromptType(t.key);
                    renderPromptLibrary();
                    // æ–°ã—ã„é¸æŠã‚¿ã‚¤ãƒ—ã§å†ç”Ÿæˆãƒ»ã‚³ãƒ”ãƒ¼
                    handleAiAnalyze();
                };
                box.appendChild(btn);
            });
        }

        window.closeAiSelectModal = function() {
            const modal = document.getElementById('ai-select-modal');
            const card = document.getElementById('ai-select-card');
            card.classList.remove('opacity-100','scale-100');
            card.classList.add('opacity-0','scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 150);
        }

        window.openAiUrl = function(type) {
            // æ—¢å®šAIè¨­å®šã‚’ä¿å­˜
            setPreferredAI(type);
            
            // ãƒ­ã‚°è¨˜éŒ²
            const promptType = getLastPromptType();
            logEvent({
                type: 'prompt_use',
                promptType,
                device: isMobile ? 'mobile' : 'desktop',
                actions: { copied: true, ai: type }
            });
            
            // å®Œäº†ã‚µãƒãƒªãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤º
            showCompletionSummary({
                promptType: promptType,
                ai: type,
                imageCount: 0,
                logsOk: true
            });
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã¨ã‚¿ãƒ–ã‚’é–‹ã
            setTimeout(() => {
                showProgressToast('ğŸš€ AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã„ã¦ã„ã¾ã™...');
                
                setTimeout(() => {
                    const win = openAITab(type);
                    
                    // ãƒ­ã‚°ã«ã‚¿ãƒ–ã‚ªãƒ¼ãƒ—ãƒ³æƒ…å ±ã‚’è¿½åŠ 
                    const logs = JSON.parse(localStorage.getItem('fx_logs') || '[]');
                    if (logs.length > 0) {
                        logs[logs.length - 1].actions.tabOpened = !!win;
                        localStorage.setItem('fx_logs', JSON.stringify(logs));
                    }
                    
                    if (win) {
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                        closeAiSelectModal();
                        
                        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¡¨ç¤ºåˆ¤å®šï¼ˆ3ç§’å¾Œï¼‰
                        setTimeout(() => {
                            if (shouldShowSurvey()) {
                                showSurvey();
                            }
                        }, 3000);
                    }
                }, 500);
            }, 1500);
        }

        window.downloadPromptTxt = function() {
            const content = lastGeneratedPrompt || '';
            if (!content) {
                showCustomMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            const btn = document.getElementById('btn-download-prompt');
            const originalHtml = btn.innerHTML;
            const ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
            try {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `FX_analysis_prompt_${ymd}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                btn.textContent = 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 3000);
            } catch (e) {
                btn.textContent = 'âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 3000);
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        function playFeedbackBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880; // A5
                o.connect(g);
                g.connect(ctx.destination);
                g.gain.setValueAtTime(0.0001, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
                o.start();
                o.stop(ctx.currentTime + 0.2);
            } catch (_) { /* ignore */ }
        }

        // ===== ç”»åƒç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
        let currentImageTradeId = null;

        function getTradeImagesKey(tradeId) {
            return `fx_trade_images_${tradeId}`;
        }
        function getTradeImages(tradeId) {
            try {
                const raw = localStorage.getItem(getTradeImagesKey(tradeId));
                if (!raw) return [];
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : [];
            } catch(_) { return []; }
        }
        function saveTradeImages(tradeId, images) {
            localStorage.setItem(getTradeImagesKey(tradeId), JSON.stringify(images));
        }
        function loadTradeThumbnails(tradeId) {
            return getTradeImages(tradeId).map(x => x.thumb);
        }

        function openImageManageModal(tradeId) {
            currentImageTradeId = tradeId;
            const modal = document.getElementById('img-manage-modal');
            const list = document.getElementById('img-preview-list');
            list.innerHTML = '';
            const imgs = getTradeImages(tradeId);
            imgs.forEach((img, idx) => list.appendChild(buildThumbItem(img.thumb, idx)));
            modal.classList.remove('hidden');

            const drop = document.getElementById('img-drop-area');
            drop.tabIndex = 0;
            drop.ondragover = (e) => { e.preventDefault(); drop.classList.add('bg-gray-800/40'); };
            drop.ondragleave = () => { drop.classList.remove('bg-gray-800/40'); };
            drop.ondrop = (e) => {
                e.preventDefault();
                drop.classList.remove('bg-gray-800/40');
                const files = Array.from(e.dataTransfer.files || []).filter(isSupportedImage);
                processAndAddFiles(files);
            };
            drop.onpaste = (e) => {
                const items = e.clipboardData && e.clipboardData.items ? Array.from(e.clipboardData.items) : [];
                const files = items.map(i => i.getAsFile && i.getAsFile()).filter(Boolean).filter(isSupportedImage);
                if (files.length > 0) processAndAddFiles(files);
            };

            const fileInput = document.getElementById('img-file-input');
            fileInput.onchange = () => {
                const files = Array.from(fileInput.files || []).filter(isSupportedImage);
                processAndAddFiles(files);
                fileInput.value = '';
            };
        }
        function closeImageManageModal() {
            currentImageTradeId = null;
            document.getElementById('img-manage-modal').classList.add('hidden');
        }

        function isSupportedImage(file) {
            return file && /^image\/(png|jpeg|jpg|gif)$/i.test(file.type);
        }

        function buildThumbItem(src, idx) {
            const wrap = document.createElement('div');
            wrap.className = 'relative';
            const im = document.createElement('img');
            im.src = src; im.width = 80; im.height = 80; im.className = 'rounded object-cover border border-gray-700 cursor-pointer';
            im.onclick = () => { if (currentImageTradeId!=null) openImageViewer(currentImageTradeId, idx); };
            const del = document.createElement('button');
            del.className = 'absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 text-xs';
            del.textContent = 'Ã—';
            del.onclick = (e) => { e.stopPropagation(); deleteImageAt(idx); };
            wrap.appendChild(im);
            wrap.appendChild(del);
            return wrap;
        }

        async function processAndAddFiles(files) {
            if (!currentImageTradeId) return;
            const existing = getTradeImages(currentImageTradeId);
            if (existing.length >= 3) {
                showCustomMessage('ç”»åƒãŒå¤šã™ãã¾ã™ã€‚å¤ã„ç”»åƒã‚’å‰Šé™¤ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            const available = Math.max(0, 3 - existing.length);
            const targets = files.slice(0, available);
            try {
                const processed = [];
                for (const f of targets) {
                    const { data, thumb } = await readResizeCompress(f);
                    processed.push({ data, thumb, type: 'image/jpeg', createdAt: Date.now() });
                }
                const updated = existing.concat(processed);
                try {
                    saveTradeImages(currentImageTradeId, updated);
                } catch (e) {
                    console.warn('LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼(å®¹é‡è¶…éã®å¯èƒ½æ€§):', e);
                    showCustomMessage('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå®¹é‡è¶…éã®å¯èƒ½æ€§ï¼‰', 'error');
                    return;
                }
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
                const list = document.getElementById('img-preview-list');
                list.innerHTML = '';
                updated.forEach((img, idx) => list.appendChild(buildThumbItem(img.thumb, idx)));
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ ãƒã‚‚æ›´æ–°
                setupRealtimeListener(); // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç”¨ã«å†ãƒˆãƒªã‚¬ãƒ¼
            } catch (e) {
                console.error('ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:', e);
                showCustomMessage('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function deleteImageAt(idx) {
            if (currentImageTradeId == null) return;
            const imgs = getTradeImages(currentImageTradeId);
            imgs.splice(idx, 1);
            saveTradeImages(currentImageTradeId, imgs);
            const list = document.getElementById('img-preview-list');
            list.innerHTML = '';
            imgs.forEach((img, i) => list.appendChild(buildThumbItem(img.thumb, i)));
            setupRealtimeListener();
        }

        function openImageViewer(tradeId, index) {
            const imgs = getTradeImages(tradeId);
            if (!imgs[index]) return;
            const modal = document.getElementById('img-viewer-modal');
            const img = document.getElementById('img-viewer-image');
            img.src = imgs[index].data || imgs[index].thumb;
            modal.classList.remove('hidden');
        }
        function closeImageViewer() {
            document.getElementById('img-viewer-modal').classList.add('hidden');
        }

        function readFileAsImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        function drawToCanvas(image, maxSize) {
            const canvas = document.createElement('canvas');
            let { width, height } = image;
            const scale = Math.min(1, maxSize / Math.max(width, height));
            width = Math.round(width * scale);
            height = Math.round(height * scale);
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0, width, height);
            return canvas;
        }
        async function readResizeCompress(file) {
            const img = await readFileAsImage(file);
            const canvas = drawToCanvas(img, 1200);
            const data = canvas.toDataURL('image/jpeg', 0.8);
            const thumbCanvas = drawToCanvas(img, 200);
            const thumb = thumbCanvas.toDataURL('image/jpeg', 0.8);
            return { data, thumb };
        }

        // ===== ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ–°è¦è¨˜éŒ²ã«ç´ã¥ãä¸€æ™‚ç”»åƒï¼‰ =====
        let pendingFormImages = [];
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const TEN_MB = 10 * 1024 * 1024;

        // ===== ä½¿ç”¨ãƒ­ã‚°æ©Ÿèƒ½ =====
        function logEvent(eventData) {
            try {
                const logs = JSON.parse(localStorage.getItem('fx_logs') || '[]');
                logs.push({ ...eventData, id: Date.now(), timestamp: new Date().toISOString() });
                if (logs.length > 100) logs.splice(0, logs.length - 100);
                localStorage.setItem('fx_logs', JSON.stringify(logs));
            } catch (err) {
                console.error('ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', err);
            }
        }
        window.exportLogs = function() {
            try {
                const logs = JSON.parse(localStorage.getItem('fx_logs') || '[]');
                const csv = [
                    ['æ—¥æ™‚', 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒ—', 'ãƒ‡ãƒã‚¤ã‚¹', 'AI', 'æº€è¶³åº¦'].join(','),
                    ...logs.map(log => [
                        log.timestamp,
                        log.promptType || '',
                        log.device || '',
                        log.actions?.ai || '',
                        log.rating || ''
                    ].join(','))
                ].join('\n');
                const blob = new Blob(['\ufeff', csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; link.download = `fx_logs_${Date.now()}.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showCustomMessage('ä½¿ç”¨ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
            } catch (err) {
                console.error('ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', err);
                showCustomMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        window.clearLogs = function() {
            if (confirm('ä½¿ç”¨ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) {
                try {
                    localStorage.removeItem('fx_logs');
                    showCustomMessage('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                } catch (err) {
                    console.error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', err);
                    showCustomMessage('ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }

        // ===== ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ =====
        function shouldShowSurvey() {
            const disabled = localStorage.getItem('surveyDisabled') === '1';
            if (disabled) return false;
            
            const today = new Date().toDateString();
            const lastShown = localStorage.getItem('lastSurveyDate');
            const useCount = parseInt(localStorage.getItem('useCount') || '0');
            
            // ä»Šæ—¥ã™ã§ã«è¡¨ç¤ºæ¸ˆã¿
            if (lastShown === today) return false;
            
            // 7å›åˆ©ç”¨ã”ã¨ã€ã¾ãŸã¯20%ã®ç¢ºç‡
            if (useCount % 7 === 0 || Math.random() < 0.2) {
                localStorage.setItem('lastSurveyDate', today);
                return true;
            }
            
            return false;
        }
        
        function incrementUseCount() {
            try {
                const count = parseInt(localStorage.getItem('useCount') || '0');
                localStorage.setItem('useCount', String(count + 1));
            } catch(_) {}
        }
        
        function showSurvey() {
            const snackbar = document.getElementById('surveySnackbar');
            if (!snackbar) return;
            snackbar.style.display = 'block';
            // 5ç§’ã§è‡ªå‹•æ¶ˆå»
            setTimeout(() => {
                closeSurvey();
            }, 5000);
        }
        
        window.closeSurvey = function() {
            const snackbar = document.getElementById('surveySnackbar');
            if (snackbar) snackbar.style.display = 'none';
        }
        
        window.submitRating = function(rating) {
            try {
                const logs = JSON.parse(localStorage.getItem('fx_logs') || '[]');
                if (logs.length > 0) {
                    logs[logs.length - 1].rating = rating;
                    localStorage.setItem('fx_logs', JSON.stringify(logs));
                }
                showCustomMessage('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ™', 'success');
            } catch (err) {
                console.error('è©•ä¾¡ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
            }
            closeSurvey();
        }
        
        window.toggleSurvey = function() {
            const disabled = localStorage.getItem('surveyDisabled') === '1';
            localStorage.setItem('surveyDisabled', disabled ? '0' : '1');
            updateSurveyToggle();
            showCustomMessage(disabled ? 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ' : 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ', 'success');
        }

        function renderFormPreviews() {
            const previews = document.getElementById('imagePreviewContainer');
            if (!previews) return;
            previews.innerHTML = '';
            pendingFormImages.forEach((img, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'relative';
                const im = document.createElement('img');
                im.src = img.thumb; im.width = 80; im.height = 80; im.className = 'rounded object-cover border border-gray-700';
                const del = document.createElement('button');
                del.className = 'absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 text-xs';
                del.textContent = 'Ã—';
                del.onclick = () => { pendingFormImages.splice(idx,1); renderFormPreviews(); };
                wrap.appendChild(im); wrap.appendChild(del); previews.appendChild(wrap);
            });
        }

        function syncPendingFormImagesToLocal() {
            try { localStorage.setItem('fx_temp_form_images', JSON.stringify(pendingFormImages)); } catch(_) {}
        }
        function loadPendingFormImagesFromLocal() {
            try {
                const raw = localStorage.getItem('fx_temp_form_images');
                const arr = raw ? JSON.parse(raw) : [];
                if (Array.isArray(arr)) { pendingFormImages = arr; renderFormPreviews(); }
            } catch(_) {}
        }

        function showProgress(text, pct) {
            const box = document.getElementById('uploadProgress');
            const fill = document.getElementById('uploadProgressFill');
            const t = document.getElementById('uploadProgressText');
            if (!box || !fill || !t) return;
            box.classList.remove('hidden');
            if (typeof pct === 'number') fill.style.width = Math.max(0, Math.min(100, pct)) + '%';
            if (text) t.textContent = text;
        }
        function hideProgress() {
            const box = document.getElementById('uploadProgress');
            const fill = document.getElementById('uploadProgressFill');
            if (!box || !fill) return;
            box.classList.add('hidden');
            fill.style.width = '0%';
        }

        function showPreview(previewUrl, tempId) {
            const previews = document.getElementById('imagePreviewContainer');
            const wrap = document.createElement('div');
            wrap.className = 'relative';
            wrap.dataset.tempId = tempId;
            const im = document.createElement('img');
            im.src = previewUrl; im.width = 80; im.height = 80; im.className = 'rounded object-cover border border-gray-700';
            const del = document.createElement('button');
            del.className = 'absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 text-xs';
            del.textContent = 'Ã—';
            del.onclick = () => {
                const idx = pendingFormImages.findIndex(x => x.tempId === tempId);
                if (idx >= 0) { pendingFormImages.splice(idx,1); syncPendingFormImagesToLocal(); }
                if (wrap.parentNode) wrap.parentNode.removeChild(wrap);
            };
            wrap.appendChild(im); wrap.appendChild(del); previews.appendChild(wrap);
        }
        function updateThumbnailFor(tempId, thumbUrl) {
            const wrap = Array.from(document.querySelectorAll('#imagePreviewContainer > div')).find(d => d.dataset.tempId === String(tempId));
            if (!wrap) return;
            const im = wrap.querySelector('img');
            if (im) im.src = thumbUrl;
        }
        function showSuccessFor(tempId) {
            hideProgress();
        }
        function showErrorFor(tempId, msg) {
            hideProgress();
            showCustomMessage(msg || 'ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }

        async function createThumbnail(file, maxSize) {
            return await resizeImage(file, maxSize, 0.7);
        }
        function resizeImage(file, maxSize, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        if (width > height && width > maxSize) { height = (height * maxSize) / width; width = maxSize; }
                        else if (height > maxSize) { width = (width * maxSize) / height; height = maxSize; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d', { alpha: false });
                        ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (blob) {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(blob);
                            } else { reject(new Error('Blobç”Ÿæˆå¤±æ•—')); }
                        }, 'image/jpeg', quality);
                        canvas.width = 0; canvas.height = 0;
                        URL.revokeObjectURL(img.src);
                    } catch (err) { reject(err); }
                };
                img.onerror = reject;
                const url = URL.createObjectURL(file);
                img.src = url;
            });
        }

        async function saveToStorageEntry(tempId, dataBase64, thumbBase64) {
            const idx = pendingFormImages.findIndex(x => x.tempId === tempId);
            if (idx >= 0) {
                pendingFormImages[idx].data = dataBase64;
                if (thumbBase64) pendingFormImages[idx].thumb = thumbBase64;
            }
            syncPendingFormImagesToLocal();
        }

        async function handleImageUpload(file) {
            if (!file) return;
            if (file.size > TEN_MB) {
                showCustomMessage('ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBã¾ã§ï¼‰ã€‚', 'error');
                return;
            }
            if (pendingFormImages.length >= 3) {
                showCustomMessage('ç”»åƒãŒå¤šã™ãã¾ã™ã€‚å¤ã„ç”»åƒã‚’å‰Šé™¤ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            const tempId = crypto.randomUUID();
            const previewUrl = URL.createObjectURL(file);
            pendingFormImages.push({ tempId, previewUrl, createdAt: Date.now() });
            showPreview(previewUrl, tempId);
            showProgress('ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆä¸­...', 20);

            // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚µãƒ ãƒã‚¤ãƒ«
            setTimeout(async () => {
                try {
                    const thumb = await createThumbnail(file, 150);
                    updateThumbnailFor(tempId, thumb);
                    const idx = pendingFormImages.findIndex(x => x.tempId === tempId);
                    if (idx >= 0) pendingFormImages[idx].thumb = thumb;
                    showProgress('ä¿å­˜ç”¨ç”»åƒã‚’ç”Ÿæˆä¸­...', 60);
                } catch (err) {
                    console.error('ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå¤±æ•—:', err);
                }
            }, 100);

            // ã‚¹ãƒ†ãƒƒãƒ—3: ä¿å­˜ç”¨
            setTimeout(async () => {
                const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 5000));
                try {
                    const data = await Promise.race([resizeImage(file, 600, 0.6), timeout]);
                    await saveToStorageEntry(tempId, data, null);
                    showProgress('ä¿å­˜ã—ã¾ã—ãŸ', 100);
                    setTimeout(hideProgress, 500);
                    showSuccessFor(tempId);
                } catch (err) {
                    console.error('ç”»åƒä¿å­˜å¤±æ•—:', err);
                    showErrorFor(tempId, err.message === 'timeout' ? 'ç”»åƒã®å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ' : 'ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }, 200);
        }

        async function addFilesToPending(files) {
            const valid = files.filter(f => /^image\//i.test(f.type));
            for (const f of valid) {
                await handleImageUpload(f);
            }
        }

        // æ—¢å­˜inputã¸ã®onchangeã‚’ã‚·ãƒ³ãƒ—ãƒ«åŒ–
        (function setupFormImageUpload(){
            const input = document.getElementById('imageUpload');
            if (!input) return;
            input.onchange = async () => {
                const files = Array.from(input.files || []);
                input.value = '';
                await addFilesToPending(files);
            };
        })();

        // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒœã‚¿ãƒ³ã®æç”»
        function setupFormImageButtons() {
            const box = document.getElementById('form-image-buttons');
            if (!box) return;
            box.innerHTML = '';
            if (isMobile) {
                const cam = document.createElement('button');
                cam.type = 'button'; cam.className = 'btn-secondary flex-1'; cam.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±';
                cam.onclick = () => openCamera();
                const gal = document.createElement('button');
                gal.type = 'button'; gal.className = 'btn-secondary flex-1'; gal.textContent = 'ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰é¸æŠ';
                gal.onclick = () => selectFromGallery();
                box.appendChild(cam); box.appendChild(gal);
            } else {
                const sel = document.createElement('button');
                sel.type = 'button'; sel.className = 'btn-secondary flex-1'; sel.textContent = 'ğŸ“· ç”»åƒã‚’é¸æŠ';
                sel.onclick = () => selectImageFile();
                const pst = document.createElement('button');
                pst.type = 'button'; pst.className = 'btn-secondary flex-1'; pst.textContent = 'ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘';
                pst.onclick = () => pasteFromClipboard();
                box.appendChild(sel); box.appendChild(pst);
            }
        }

        // PC: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        window.selectImageFile = function() {
            const input = document.getElementById('imageUpload');
            if (input) input.click();
        }

        // PC: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘
        window.pasteFromClipboard = function() {
            if (!navigator.clipboard || !navigator.clipboard.read) {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç”»åƒã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\nç”»åƒã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }
            navigator.clipboard.read().then(async (items) => {
                const files = [];
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            files.push(new File([blob], 'clipboard-image', { type: blob.type }));
                        }
                    }
                }
                if (files.length === 0) {
                    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    return;
                }
                addFilesToPending(files);
            }).catch(() => {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç”»åƒã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\nç”»åƒã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            });
        }

        // ã‚¹ãƒãƒ›: ã‚«ãƒ¡ãƒ©èµ·å‹•
        window.openCamera = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = (e) => {
                const files = Array.from(e.target.files || []);
                addFilesToPending(files);
            };
            input.click();
        }

        // ã‚¹ãƒãƒ›: ã‚®ãƒ£ãƒ©ãƒªãƒ¼é¸æŠ
        window.selectFromGallery = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = (e) => {
                const files = Array.from(e.target.files || []);
                addFilesToPending(files);
            };
            input.click();
        }
    </script>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --><div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ãƒƒãƒ‘ãƒ¼ (ä»¥å‰ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯å‰Šé™¤) --><div>
        <div class="container min-h-screen mx-auto pt-6 pb-2">
            <header class="text-center mb-6">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜ã®æ–‡å­—ãƒ­ã‚´ã‚’CSSã§å†ç¾ã—ã€h1ã‚¿ã‚°ã¨ã—ã¦é…ç½® --><h1 class="app-logo-text">FX ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>
                <p id="user-info" class="text-sm text-gray-400 mt-1">èªè¨¼ä¸­...</p>
            </header>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ (Alertä»£æ›¿) --><div id="message-box" style="opacity:0;" class="p-3 rounded-lg text-center mt-4 transition-all duration-300"></div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="app-tabs">
                <button class="tab-btn active" onclick="switchTab('record')">
                    <span class="tab-icon">ğŸ“</span>
                    <span class="tab-label">è¨˜éŒ²</span>
                </button>
                <button class="tab-btn" onclick="switchTab('analytics')">
                    <span class="tab-icon">ğŸ“Š</span>
                    <span class="tab-label">åˆ†æ</span>
                </button>
                <button class="tab-btn" onclick="switchTab('settings')">
                    <span class="tab-icon">ğŸ”§</span>
                    <span class="tab-label">è¨­å®š</span>
                </button>
                <button class="tab-btn" onclick="switchTab('pro')">
                    <span class="tab-icon">â­</span>
                    <span class="tab-label">Pro</span>
                </button>
            </div>

            <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="tab-content active" id="tab-record">
                <!-- 1. è³‡é‡‘ç®¡ç†ï¼šãƒ­ãƒƒãƒˆè¨ˆç®—ãƒ„ãƒ¼ãƒ« --><section id="money-management" class="px-2 sm:px-0">
                <div class="mb-8 p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">ãƒ­ãƒƒãƒˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h2>
                    <p class="text-sm text-gray-400 mb-4">è¨±å®¹ãƒªã‚¹ã‚¯ã«åŸºã¥ãã€é©åˆ‡ãªãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="accountBalance" class="block text-sm font-medium text-gray-300">å£åº§æ®‹é«˜ (å††ç›¸å½“)</label>
                            <input type="number" id="accountBalance" value="1000000" min="1" class="input-style mt-1" placeholder="ä¾‹: 1000000">
                        </div>

                        <div>
                            <label for="riskPercentage" class="block text-sm font-medium text-gray-300">1ãƒˆãƒ¬ãƒ¼ãƒ‰ã®è¨±å®¹ãƒªã‚¹ã‚¯ç‡ (%)</label>
                            <input type="number" id="riskPercentage" value="1" min="0.1" max="100" step="0.1" class="input-style mt-1" placeholder="ä¾‹: 1.0">
                        </div>
                        
                        <div>
                            <label for="stopLossPips" class="block text-sm font-medium text-gray-300">æåˆ‡ã‚Šå¹… (pips)</label>
                            <input type="number" id="stopLossPips" value="50" min="1" class="input-style mt-1" placeholder="ä¾‹: 50">
                        </div>
                        
                        <div>
                            <label for="pipValuePerLot" class="block text-sm font-medium text-gray-300">1ãƒ­ãƒƒãƒˆã‚ãŸã‚Šã®1pipsã®ä¾¡å€¤ (å††ç›¸å½“)</label>
                            <input type="number" id="pipValuePerLot" value="1000" min="1" class="input-style mt-1" placeholder="ä¾‹: 1000">
                            <p class="text-xs text-gray-500 mt-1">â€»USD/JPYã®å ´åˆã€1ãƒ­ãƒƒãƒˆ=1000å††ç›¸å½“</p>
                        </div>
                    </div>

                    <button onclick="calculateLotSize()" class="btn-primary w-full mt-4">
                        ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                    </button>

                    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ --><div class="mt-6 p-4 summary-card text-center">
                        <p class="text-sm font-medium text-gray-400 mb-1">æ¨å¥¨ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚º</p>
                        <div id="calculatedLotSize" class="text-2xl text-white font-bold">-- ãƒ­ãƒƒãƒˆ</div>
                        <div id="riskAmountDisplay" class="text-sm text-gray-400 mt-2"></div>
                    </div>
                </div>
            </section>

            <!-- 2. ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ  --><section id="trade-recording" class="px-2 sm:px-0">
                <div class="p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">æ–°è¦ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²</h2>
                    <form id="tradeForm" onsubmit="event.preventDefault(); recordTrade();">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            
                            <!-- é€šè²¨ãƒšã‚¢ --><div>
                                <label for="pair" class="block text-sm font-medium text-gray-300">é€šè²¨ãƒšã‚¢</label>
                                <select id="pair" required class="input-style mt-1">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="USD/JPY">USD/JPY</option>
                                    <option value="EUR/USD">EUR/USD</option>
                                    <option value="GBP/JPY">GBP/JPY</option>
                                    <option value="AUD/USD">AUD/USD</option>
                                    <option value="OTHERS">ãã®ä»–</option>
                                </select>
                            </div>

                            <!-- å£²è²·æ–¹å‘ --><div>
                                <label for="direction" class="block text-sm font-medium text-gray-300">å£²è²·æ–¹å‘</label>
                                <select id="direction" required class="input-style mt-1">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="buy">è²·ã„ (Buy)</option>
                                    <option value="sell">å£²ã‚Š (Sell)</option>
                                </select>
                            </div>

                            <!-- ãƒ­ãƒƒãƒˆæ•° --><div>
                                <label for="lotSize" class="block text-sm font-medium text-gray-300">ãƒ­ãƒƒãƒˆæ•° (Lot)</label>
                                <input type="number" id="lotSize" required step="0.01" min="0.01" class="input-style mt-1" placeholder="ä¾‹: 1.0">
                            </div>

                            <!-- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼ --><div>
                                <label for="entryPrice" class="block text-sm font-medium text-gray-300">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼</label>
                                <input type="number" id="entryPrice" required step="any" class="input-style mt-1" placeholder="ä¾‹: 150.050">
                            </div>

                            <!-- ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼ --><div>
                                <label for="exitPrice" class="block text-sm font-medium text-gray-300">ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼</label>
                                <input type="number" id="exitPrice" required step="any" class="input-style mt-1" placeholder="ä¾‹: 150.100">
                            </div>

                            <!-- ç²å¾—/æå¤± pips --><div>
                                <label for="pips" class="block text-sm font-medium text-gray-300">ç²å¾—/æå¤± pips</label>
                                <input type="number" id="pips" required step="any" class="input-style mt-1" placeholder="ä¾‹: 50.0">
                            </div>

                            <!-- æç›Š (å††ç›¸å½“) --><div class="sm:col-span-2">
                                <label for="pnl" class="block text-sm font-medium text-gray-300">æç›Š (å††ç›¸å½“)</label>
                                <input type="number" id="pnl" required step="any" class="input-style mt-1" placeholder="ä¾‹: 5000">
                            </div>

                        </div>

                        <!-- ãƒ¡ãƒ¢ --><div class="mt-4">
                            <label for="notes" class="block text-sm font-medium text-gray-300">ãƒˆãƒ¬ãƒ¼ãƒ‰ã®è€ƒå¯Ÿ/ãƒ¡ãƒ¢</label>
                            <textarea id="notes" rows="3" class="input-style mt-1 resize-none" placeholder="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ ¹æ‹ ã€åçœç‚¹ãªã©ã‚’è¨˜è¿°..."></textarea>
                        </div>

                        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰ -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-300">ãƒãƒ£ãƒ¼ãƒˆç”»åƒï¼ˆä»»æ„ï¼‰</label>
                            <div id="form-image-buttons" class="flex gap-2 mb-2"></div>
                            <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;" />
                            <div id="imagePreviewContainer" class="flex flex-wrap gap-2"></div>
                            <div id="uploadProgress" class="mt-2 hidden">
                                <div class="w-full h-2 bg-gray-700 rounded">
                                    <div id="uploadProgressFill" class="h-2 bg-green-500 rounded" style="width:0%"></div>
                                </div>
                                <span id="uploadProgressText" class="text-xs text-gray-300 mt-1 inline-block">ç”»åƒã‚’å‡¦ç†ä¸­...</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-6">
                            ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’è¨˜éŒ²
                        </button>
                    </form>
                </div>
            </section>

            <!-- 3. å±¥æ­´ãƒ»åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ --><section id="history-analysis" class="px-2 sm:px-0">
                <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ --><div class="mb-6 summary-card grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-xs font-medium text-gray-400">åˆè¨ˆãƒˆãƒ¬ãƒ¼ãƒ‰æ•°</p>
                        <p id="totalTrades" class="text-xl font-bold text-white">0</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">å‹ç‡</p>
                        <p id="winRate" class="text-xl font-bold text-white">0.00%</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">ãƒ—ãƒ­ãƒ•ã‚£ãƒƒãƒˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼</p>
                        <p id="profitFactor" class="text-xl font-bold text-white">0.00</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">åˆè¨ˆæç›Š</p>
                        <p id="totalPnl" class="text-xl font-bold text-white">0 å††</p>
                    </div>
                </div>

                <div class="p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´</h2>

                    <!-- CSVãƒœã‚¿ãƒ³ --><button onclick="exportToCSV()" class="btn-secondary px-4 py-2 text-sm font-medium mb-4 mr-2">
                        <!-- ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’ç™½ã«èª¿æ•´ --><svg class="inline-block w-4 h-4 mr-2 -mt-0.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <!-- AIåˆ†æãƒœã‚¿ãƒ³ -->
                    <button id="btn-ai-analyze" onclick="handleAiAnalyze()" class="btn-primary px-4 py-2 text-sm font-bold mb-4 relative overflow-visible">
                        <span class="mr-1">ğŸ¤–</span> AIã§ä»Šé€±ã‚’åˆ†æ
                    </button>
                    
                    <div class="overflow-x-auto rounded-lg shadow-inner">
                        <table class="min-w-full divide-y divide-gray-700 text-white">
                            <thead class="bg-gray-800/60">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">æ—¥ä»˜</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ãƒšã‚¢</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">æ–¹å‘</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ãƒ­ãƒƒãƒˆ</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">E.ä¾¡æ ¼</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">X.ä¾¡æ ¼</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pips</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">æç›Š</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ç”»åƒ</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistoryBody" class="divide-y divide-gray-800 bg-transparent">
                                <tr><td colspan="9" class="p-3 text-center text-gray-400">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <footer class="text-center text-xs text-gray-500 py-4 mt-8">
                <p>Powered by LocalStorage | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯ä¸Šéƒ¨ã«è¡¨ç¤º</p>
            </footer>
            
            <!-- ãƒ•ãƒƒã‚¿ãƒ¼åºƒå‘ŠãƒãƒŠãƒ¼ -->
            <div id="footerAdBanner" class="ad-banner mt-4" style="display:none;">
                <span class="ad-label">åºƒå‘Š</span>
                <div class="ad-content">
                    <a href="#" onclick="logAdClick('footer-banner'); return true;">
                        ğŸ“– <strong>ç„¡æ–™PDFé…å¸ƒä¸­</strong> - FXãƒˆãƒ¬ãƒ¼ãƒ‰å®Œå…¨ã‚¬ã‚¤ãƒ‰
                        <span class="ad-cta">ä»Šã™ãå—ã‘å–ã‚‹ â†’</span>
                    </a>
                </div>
            </div>
            </div>

            <!-- åˆ†æã‚¿ãƒ– -->
            <div class="tab-content" id="tab-analytics">
                <div style="padding: 20px;">
                    <h2 class="text-2xl font-bold mb-4">ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
                    
                    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼ -->
                    <div class="stats-cards grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card">
                            <div class="stat-label">ç·ãƒˆãƒ¬ãƒ¼ãƒ‰æ•°</div>
                            <div class="stat-value" id="analyticsTotalTrades">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å‹ç‡</div>
                            <div class="stat-value" id="analyticsWinRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">åˆè¨ˆæç›Š</div>
                            <div class="stat-value" id="analyticsTotalPnl">Â¥0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ãƒ«ãƒ¼ãƒ«éµå®ˆç‡</div>
                            <div class="stat-value" id="analyticsRuleKeepRate">0%</div>
                        </div>
                    </div>
                    
                    <!-- é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ -->
                    <div class="p-5 rounded-xl card mb-6">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ“ é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</div>
                        <p class="text-sm text-gray-400 mb-4">æŒ‡å®šæœŸé–“ã®ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚’è‡ªå‹•é›†è¨ˆã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ</p>
                        
                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <select id="reportRangeAnalytics" class="input-style flex-1 text-sm">
                                <option value="7d">ç›´è¿‘7æ—¥é–“</option>
                                <option value="14d">ç›´è¿‘14æ—¥é–“</option>
                                <option value="30d">ç›´è¿‘30æ—¥é–“</option>
                                <option value="thisWeek">ä»Šé€±ï¼ˆæœˆã€œæ—¥ï¼‰</option>
                                <option value="lastWeek">å…ˆé€±ï¼ˆæœˆã€œæ—¥ï¼‰</option>
                            </select>
                            <button class="btn-primary text-sm px-4 py-2 whitespace-nowrap" onclick="generateWeeklyReportFromAnalytics()">
                                ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                            </button>
                        </div>
                        
                        <textarea 
                            id="weeklyReportOutputAnalytics" 
                            class="input-style w-full text-sm font-mono resize-y" 
                            style="height: 300px;"
                            placeholder="ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã“ã“ã«Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™"
                            readonly
                        ></textarea>
                        
                        <div class="flex gap-2 mt-3">
                            <button class="btn-secondary text-sm px-4 py-2 flex-1" onclick="copyWeeklyReportFromAnalytics()">
                                ğŸ“‹ ã‚³ãƒ”ãƒ¼
                            </button>
                            <button class="btn-secondary text-sm px-4 py-2 flex-1" onclick="downloadWeeklyReportFromAnalytics()">
                                ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                    
                    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚°ãƒ©ãƒ• -->
                    <div class="p-5 rounded-xl card mb-6">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚°ãƒ©ãƒ•</div>
                        <p class="text-sm text-gray-400 mb-4">ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’è¦–è¦šåŒ–ã—ã¦å‚¾å‘ã‚’æŠŠæ¡ã§ãã¾ã™</p>
                        
                        <div style="display: grid; gap: 24px; margin-top: 20px;">
                            <!-- æ—¥åˆ¥æç›Š -->
                            <div class="chart-container">
                                <h4>æ—¥åˆ¥æç›Š</h4>
                                <div style="position: relative; height: 200px;">
                                    <canvas id="chartDailyPnl"></canvas>
                                </div>
                            </div>
                            
                            <!-- å‹ç‡æ¨ç§» -->
                            <div class="chart-container">
                                <h4>å‹ç‡æ¨ç§»</h4>
                                <div style="position: relative; height: 200px;">
                                    <canvas id="chartWinRate"></canvas>
                                </div>
                            </div>
                            
                            <!-- é€šè²¨ãƒšã‚¢åˆ¥æˆç¸¾ -->
                            <div class="chart-container">
                                <h4>é€šè²¨ãƒšã‚¢åˆ¥æˆç¸¾</h4>
                                <div style="position: relative; height: 240px;">
                                    <canvas id="chartByPair"></canvas>
                                </div>
                            </div>
                            
                            <!-- æ™‚é–“å¸¯åˆ¥å‹ç‡ -->
                            <div class="chart-container">
                                <h4>æ™‚é–“å¸¯åˆ¥å‹ç‡</h4>
                                <div style="position: relative; height: 240px;">
                                    <canvas id="chartByHour"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä½¿ç”¨ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                    <div class="p-5 rounded-xl card">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ“¤ ä½¿ç”¨ãƒ­ã‚°</div>
                        <button class="btn-secondary px-4 py-2 text-sm" onclick="exportLogs()">
                            ğŸ“Š ä½¿ç”¨ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button class="text-xs text-gray-400 underline hover:text-white mt-3 block" onclick="clearLogs()">ğŸ—‘ï¸ ä½¿ç”¨ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>
            </div>

            <!-- è¨­å®šã‚¿ãƒ– -->
            <div class="tab-content" id="tab-settings">
                <div style="padding: 20px;">
                    <h2 class="text-2xl font-bold mb-4">ğŸ”§ è¨­å®š</h2>
                    
                    <!-- ãƒ—ãƒ©ãƒ³ç®¡ç† -->
                    <div class="p-5 rounded-xl card mb-6">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</div>
                        <div class="mb-3 p-3 rounded-lg" style="background: rgba(255,255,255,0.03);">
                            <div class="text-sm text-gray-300 mb-1">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</div>
                            <div class="flex items-center justify-between">
                                <span id="currentPlanDisplaySettings" class="font-bold text-white">ç„¡æ–™ç‰ˆ</span>
                            </div>
                        </div>
                        <button class="text-xs text-gray-500 underline hover:text-white mt-3 block" onclick="toggleDevPlan()">ãƒ—ãƒ©ãƒ³åˆ‡æ›¿ï¼ˆé–‹ç™ºç”¨ï¼‰</button>
                    </div>

                    <!-- AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¨­å®š -->
                    <div class="p-5 rounded-xl card mb-6">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸªŸ AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®è¨­å®š</div>
                        <div class="flex flex-col gap-3">
                            <div>
                                <label class="text-sm text-gray-300">ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚º</label>
                                <select id="windowSizePreferenceSettings" onchange="saveWindowPreferenceFromSettings()" class="input-style w-full mt-1">
                                    <option value="half">ç”»é¢ã®åŠåˆ†ï¼ˆæ¨å¥¨ï¼‰</option>
                                    <option value="two-thirds">ç”»é¢ã®2/3</option>
                                    <option value="full">å…¨ç”»é¢</option>
                                    <option value="small">å°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆ800x600ï¼‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">é…ç½®</label>
                                <select id="windowPositionPreferenceSettings" onchange="saveWindowPreferenceFromSettings()" class="input-style w-full mt-1">
                                    <option value="right">å³å´ã«é…ç½®</option>
                                    <option value="left">å·¦å´ã«é…ç½®</option>
                                    <option value="center">ä¸­å¤®ã«é…ç½®</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-sm text-gray-300">å…ƒã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚‚è‡ªå‹•ãƒªã‚µã‚¤ã‚º</span>
                                <label class="relative inline-block w-10 h-6 cursor-pointer">
                                    <input type="checkbox" id="autoResizeOriginalSettings" class="sr-only" onchange="saveWindowPreferenceFromSettings()" />
                                    <span id="autoResizeToggleBgSettings" class="absolute inset-0 bg-gray-600 rounded-full transition-colors"></span>
                                    <span id="autoResizeToggleThumbSettings" class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ -->
                    <div class="p-5 rounded-xl card mb-6">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ” é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰</div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-300">é€£ç¶šåˆ†æãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                            <label class="relative inline-block w-10 h-6 cursor-pointer">
                                <input type="checkbox" id="continuousMode" class="sr-only" onchange="saveContinuousMode()" />
                                <span id="continuousModeToggleBg" class="absolute inset-0 bg-gray-600 rounded-full transition-colors"></span>
                                <span id="continuousModeToggleThumb" class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"></span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">ONã«ã™ã‚‹ã¨ã€è¨˜éŒ²ã‚¿ãƒ–ã§ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãŸã³ã«ã€ãã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã®AIåˆ†æãŒè‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚è¤‡æ•°ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’é€£ç¶šã§åˆ†æã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚</p>
                        <div style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 12px;">
                            <strong style="color: #ffffff;">ğŸ’¡ ä½¿ã„æ–¹:</strong>
                            <ol style="margin: 8px 0 0 20px; padding: 0; color: rgba(255,255,255,0.7);">
                                <li>ã“ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ONã«ã™ã‚‹</li>
                                <li>è¨˜éŒ²ã‚¿ãƒ–ã§ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                                <li>è‡ªå‹•ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã€AIã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã</li>
                                <li>æ¬¡ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã</li>
                            </ol>
                        </div>
                    </div>

                    <!-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å®š -->
                    <div class="p-5 rounded-xl card mb-6">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å®š</div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-300">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç„¡åŠ¹åŒ–</span>
                            <label class="relative inline-block w-10 h-6 cursor-pointer">
                                <input type="checkbox" id="surveyToggleSettings" class="sr-only" onchange="toggleSurveyFromSettings()" />
                                <span id="surveyToggleBgSettings" class="absolute inset-0 bg-gray-600 rounded-full transition-colors"></span>
                                <span id="surveyToggleThumbSettings" class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"></span>
                            </label>
                        </div>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                    <div class="p-5 rounded-xl card">
                        <div class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
                        <button class="text-xs text-gray-400 underline hover:text-white block mb-2" onclick="resetPreferredAI()">ğŸ”„ æ—¢å®šAIè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                        <button class="btn-secondary px-4 py-2 text-sm w-full" onclick="exportToCSV()">
                            <svg class="inline-block w-4 h-4 mr-2 -mt-0.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Proã‚¿ãƒ– -->
            <div class="tab-content" id="tab-pro">
                <div style="padding: 20px;">
                    <div class="text-center p-10 mb-6" style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(147,51,234,0.2)); border-radius: 16px;">
                        <h1 class="text-4xl font-bold mb-4">FXãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ² Pro</h1>
                        <p class="text-xl text-gray-300 mb-6">æœ¬æ ¼çš„ãªãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã®ãŸã‚ã®<br>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³</p>
                        <div class="text-4xl font-bold mb-6">
                            æœˆé¡ <span style="color: #3b82f6;">Â¥2,980</span>
                        </div>
                        <button class="btn-primary px-8 py-3 text-lg" onclick="alert('è¿‘æ—¥å…¬é–‹äºˆå®š')">
                            ä»Šã™ãå§‹ã‚ã‚‹
                        </button>
                    </div>
                    
                    <!-- ç‰¹å…¸ä¸€è¦§ -->
                    <div class="pro-features">
                        <div class="feature-item">
                            <span class="feature-icon">ğŸš«</span>
                            <h3 class="text-white font-bold">åºƒå‘Šãªã—</h3>
                            <p class="text-gray-300 text-sm">å¿«é©ãªç’°å¢ƒã§é›†ä¸­ã§ãã¾ã™</p>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">ğŸ“Š</span>
                            <h3 class="text-white font-bold">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ</h3>
                            <p class="text-gray-300 text-sm">æ”¹å–„ç‚¹ãŒä¸€ç›®ç­ç„¶</p>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">ğŸ“ˆ</span>
                            <h3 class="text-white font-bold">é«˜åº¦ãªã‚°ãƒ©ãƒ•è¡¨ç¤º</h3>
                            <p class="text-gray-300 text-sm">å‹ç‡ãƒ»æç›Šã®æ¨ç§»ã‚’å¯è¦–åŒ–</p>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">ğŸ¯</span>
                            <h3 class="text-white font-bold">å…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
                            <p class="text-gray-300 text-sm">æˆ¦ç•¥åˆ¥ã®é«˜åº¦ãªåˆ†æ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AIåˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ai-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto mt-24 w-[92%] max-w-xl rounded-2xl border border-white/10 bg-gray-900/90 p-5 shadow-2xl">
            <h3 id="ai-modal-title" class="text-lg font-bold text-white">AIåˆ†æ</h3>
            <p id="ai-modal-desc" class="mt-1 text-sm text-gray-300">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆãªã„ãŸã‚ã€ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</p>
            <textarea id="ai-fallback-area" class="mt-4 w-full h-48 input-style"></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button class="btn-secondary px-4 py-2 text-sm" onclick="closeAiModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- AIé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚³ãƒ”ãƒ¼æˆåŠŸæ™‚ã®ã‚¬ã‚¤ãƒ‰ï¼‰ -->
    <div id="ai-select-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60" onclick="closeAiSelectModal()"></div>
        <div id="ai-select-card" class="relative mx-auto mt-8 mb-8 w-[92%] max-w-2xl rounded-2xl border border-white/10 bg-gray-900/90 shadow-2xl transition-all duration-150 ease-out opacity-0 scale-95" style="max-height: 90vh; display: flex; flex-direction: column;">
            <button class="absolute right-3 top-3 z-10 text-gray-400 hover:text-white" aria-label="é–‰ã˜ã‚‹" onclick="closeAiSelectModal()">Ã—</button>
            
            <div style="flex-shrink: 0; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div id="ai-copied-title" class="font-bold rounded-lg text-white animate-pulse" style="background:#065f46; padding:16px; font-size:24px;">
                    âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
                <div class="mt-3">
                    <div class="text-sm text-gray-300 font-bold mb-2">ğŸ“š åˆ†æã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</div>
                    <div id="prompt-library" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2"></div>
                </div>

                <div class="my-3 flex items-center text-gray-500 text-xs">
                    <div class="flex-1 h-px bg-gray-700"></div>
                    <span class="px-3">â”â”â”â”â”</span>
                    <div class="flex-1 h-px bg-gray-700"></div>
                </div>

                <div class="mt-3 text-sm text-gray-300 font-medium">ã©ã®AIã§åˆ†æã—ã¾ã™ã‹ï¼Ÿ</div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                <button class="btn-primary w-full" onclick="openAiUrl('chatgpt')"><span class="mr-1">ğŸ¤–</span> ChatGPTã§é–‹ã</button>
                <button class="btn-primary w-full" onclick="openAiUrl('gemini')"><span class="mr-1">âœ¨</span> Geminiã§é–‹ã</button>
                <button class="btn-primary w-full" onclick="openAiUrl('claude')"><span class="mr-1">ğŸ§ </span> Claudeã§é–‹ã</button>
            </div>

                <div id="ai-paste-hint" class="mt-3 rounded-lg text-gray-900 font-semibold" style="background:#fde68a; padding:12px; font-size:16px;">
                    <span class="mr-1">âš¡</span> é–‹ã„ãŸã‚‰ <span class="font-bold">Ctrl+V</span>ï¼ˆMacã¯ <span class="font-bold">âŒ˜+V</span>ï¼‰ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
                </div>

            <div class="my-4 flex items-center text-gray-500 text-xs">
                <div class="flex-1 h-px bg-gray-700"></div>
                <span class="px-3">â”â”â”â”â” ã¾ãŸã¯ â”â”â”â”â”</span>
                <div class="flex-1 h-px bg-gray-700"></div>
            </div>

            <div class="text-sm text-gray-300 font-medium">ã€æ–¹æ³•2: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‘</div>
            <button id="btn-download-prompt" class="btn-secondary mt-2 w-full md:w-auto" onclick="downloadPromptTxt()"><span class="mr-1">ğŸ“„</span> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <p class="mt-2 text-xs text-gray-400">â€»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’AIã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
            
            <!-- AIåˆ†æãƒ¢ãƒ¼ãƒ€ãƒ«å†…åºƒå‘Š -->
            <div id="modalAd" class="ad-inline mt-4" style="display:none;">
                <span class="ad-label">åºƒå‘Š</span>
                <div class="ad-content">
                    <p class="text-white mb-2">ğŸ¯ <strong>Proç‰ˆ</strong>ãªã‚‰åºƒå‘Šãªã—ï¼‹é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ</p>
                    <button class="btn-primary text-xs px-3 py-2" onclick="showProInfo()">è©³ã—ãè¦‹ã‚‹</button>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Proç‰ˆæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="proInfoModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/60" onclick="closeProInfo()"></div>
        <div class="relative mx-auto mt-10 w-[92%] max-w-2xl rounded-2xl border border-white/10 bg-gray-900/95 p-5 shadow-2xl">
            <button class="absolute right-3 top-3 text-gray-400 hover:text-white" onclick="closeProInfo()">Ã—</button>
            <h2 class="text-2xl font-bold text-white mb-4">â­ Proç‰ˆã®ç‰¹å…¸</h2>
            <div class="pro-features">
                <div class="feature-item">
                    <span class="feature-icon">ğŸš«</span>
                    <h3 class="text-white font-bold">åºƒå‘Šãªã—</h3>
                    <p class="text-gray-300 text-sm">å¿«é©ãªç’°å¢ƒã§é›†ä¸­ã§ãã¾ã™</p>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ“Š</span>
                    <h3 class="text-white font-bold">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ</h3>
                    <p class="text-gray-300 text-sm">æ”¹å–„ç‚¹ãŒä¸€ç›®ç­ç„¶</p>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ“ˆ</span>
                    <h3 class="text-white font-bold">é«˜åº¦ãªã‚°ãƒ©ãƒ•è¡¨ç¤º</h3>
                    <p class="text-gray-300 text-sm">å‹ç‡ãƒ»æç›Šã®æ¨ç§»ã‚’å¯è¦–åŒ–</p>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ¯</span>
                    <h3 class="text-white font-bold">å…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
                    <p class="text-gray-300 text-sm">æˆ¦ç•¥åˆ¥ã®é«˜åº¦ãªåˆ†æ</p>
                </div>
            </div>
            <p class="pro-price text-white">æœˆé¡ <strong class="text-3xl">Â¥2,980</strong>ã€œ</p>
            <button class="btn-primary w-full mt-4" onclick="alert('è¿‘æ—¥å…¬é–‹äºˆå®š')">ä»Šã™ãå§‹ã‚ã‚‹</button>
            <button class="btn-secondary w-full mt-2" onclick="closeProInfo()">å¾Œã§æ¤œè¨ã™ã‚‹</button>
        </div>
    </div>

    <!-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ -->
    <div id="surveySnackbar" class="snackbar" style="display:none;">
        <div class="snackbar-content">
            <p>ä»Šå›ã®AIåˆ†æã¯å½¹ç«‹ã¡ã¾ã—ãŸã‹ï¼Ÿï¼ˆ2ã‚¿ãƒƒãƒ—ã§å®Œäº†ï¼‰</p>
            <div class="rating-buttons">
                <button onclick="submitRating(1)">ğŸ˜</button>
                <button onclick="submitRating(2)">ğŸ˜</button>
                <button onclick="submitRating(3)">ğŸ™‚</button>
                <button onclick="submitRating(4)">ğŸ˜Š</button>
                <button onclick="submitRating(5)">ğŸ¤©</button>
            </div>
            <button class="close-btn" onclick="closeSurvey()">Ã—</button>
        </div>
    </div>

    <!-- AIã‚³ãƒ”ãƒ¼æˆåŠŸï¼šå·¨å¤§ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæœ€å‰é¢ï¼‰ -->
    <div id="ai-copy-tutorial" class="fixed inset-0 hidden" style="z-index:80;">
        <div class="absolute inset-0" style="background: rgba(16,185,129,0.25);"></div>
        <div class="relative mx-auto my-8 w-[92%] sm:w-[80%] md:w-[70%] lg:w-[60%] max-h-[85vh] overflow-y-auto rounded-2xl border border-white/10 bg-gray-900/95 p-5 shadow-2xl" role="dialog" aria-modal="true" aria-labelledby="ai-copy-tutorial-title" style="animation: pop-in 200ms ease-out;">
            <div class="flex items-start gap-3">
                <div class="text-green-400" aria-hidden="true" style="font-size:64px; line-height:1; animation: big-check 350ms ease-out;">âœ…</div>
                <div>
                    <div id="ai-copy-tutorial-title" class="font-extrabold text-white" style="font-size:24px;">ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>
                    <div class="mt-2 text-gray-300 text-sm">ã“ã®ã‚ã¨AIã‚’é–‹ã„ã¦è²¼ã‚Šä»˜ã‘ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®æ‰‹é †ã«æ²¿ã£ã¦é€²ã‚ã‚Œã°OKã§ã™ã€‚</div>
                </div>
            </div>

            <div class="mt-4 text-gray-200 text-sm">
                <div class="opacity-80">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</div>
                <div class="mt-2 font-bold text-white">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š</div>
                <div class="opacity-80 mt-2">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</div>

                <div class="mt-4 space-y-4">
                    <div class="text-white">
                        <div class="font-extrabold" style="font-size:20px;">â‘  ä¸‹ã®ãƒœã‚¿ãƒ³ã§AIã‚’é¸ã‚“ã§é–‹ã</div>
                        <div class="mt-1 text-gray-300">ChatGPT / Gemini / Claude ã®ã„ãšã‚Œã‹ã‚’é¸ã³ã¾ã™ã€‚</div>
                    </div>
                    <div class="text-white">
                        <div class="font-extrabold" style="font-size:20px;">â‘¡ é–‹ã„ãŸãƒšãƒ¼ã‚¸ã§ã€Œ<span class="font-extrabold" style="color:#ef4444;">è²¼ã‚Šä»˜ã‘</span>ã€ã™ã‚‹</div>
                        <div class="mt-2 text-gray-300">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ <span class="kbd-key">Ctrl</span> + <span class="kbd-key">V</span>ï¼ˆMac: <span class="kbd-key">âŒ˜</span> + <span class="kbd-key">V</span>ï¼‰</div>
                        <div class="mt-2 text-gray-300">ã¾ãŸã¯ã€å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œè²¼ã‚Šä»˜ã‘ã€</div>
                    </div>
                </div>

                <div class="opacity-80 mt-5">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</div>

                <div class="mt-4 flex items-center gap-3">
                    <input id="ai-copy-tutorial-noshow" type="checkbox" class="h-4 w-4">
                    <label for="ai-copy-tutorial-noshow" class="text-sm text-gray-300">æ¬¡å›ã‹ã‚‰ã“ã®ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤ºã—ãªã„</label>
                </div>

                <div class="mt-5 flex flex-col sm:flex-row gap-3">
                    <button id="ai-copy-tutorial-ack" class="btn-primary w-full sm:w-auto text-base px-5 py-3 font-extrabold">[ç†è§£ã—ã¾ã—ãŸ]</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»åƒç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="img-manage-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/60" onclick="closeImageManageModal()"></div>
        <div class="relative mx-auto mt-10 w-[92%] max-w-2xl rounded-2xl border border-white/10 bg-gray-900/95 p-5 shadow-2xl">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-white">ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’è¿½åŠ ãƒ»ç®¡ç†</h3>
                <button class="text-gray-400 hover:text-white" onclick="closeImageManageModal()">Ã—</button>
            </div>
            <div class="mt-3 text-xs text-gray-400">æœ€å¤§3æšã¾ã§ã€‚PNG/JPEG/GIFã€‚è²¼ã‚Šä»˜ã‘ã€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã«å¯¾å¿œã€‚</div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <input id="img-file-input" type="file" accept="image/png,image/jpeg,image/jpg,image/gif" multiple capture="environment" class="hidden" />
                <button class="btn-primary px-3 py-2 text-sm" onclick="document.getElementById('img-file-input').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                <div id="img-drop-area" class="flex-1 rounded-lg border border-dashed border-gray-600 p-4 text-center text-sm text-gray-300">
                    ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— / ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ Ctrl+V ã§è²¼ã‚Šä»˜ã‘
                </div>
            </div>

            <div class="mt-4">
                <div class="text-sm text-gray-300 mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div id="img-preview-list" class="flex flex-wrap gap-3"></div>
            </div>

            <div class="mt-5 flex justify-end gap-2">
                <button class="btn-secondary px-4 py-2 text-sm" onclick="closeImageManageModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="img-viewer-modal" class="fixed inset-0 z-[75] hidden">
        <div class="absolute inset-0 bg-black/80" onclick="closeImageViewer()"></div>
        <div class="relative mx-auto mt-8 w-[92%] max-w-4xl p-2">
            <img id="img-viewer-image" alt="preview" class="mx-auto max-h-[80vh] rounded-lg" style="touch-action: auto;" />
            <div class="mt-3 flex justify-center">
                <button class="btn-secondary px-4 py-2 text-sm" onclick="closeImageViewer()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆé–‹ç™ºç”¨ï¼‰ -->
    <button id="btn-add-testdata" aria-label="ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ " onclick="addTestData()" class="fixed bottom-20 right-4 z-[60] px-3 py-2 text-xs font-bold rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2" style="background-color:#f59e0b;color:#111827;">
        ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    </button>

    <script>
    // é–‹ç™ºç”¨: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’LocalStorageã«è¿½åŠ ï¼ˆä¸Šæ›¸ã or ç¢ºèªã®ä¸Šãƒªã‚»ãƒƒãƒˆï¼‰
    window.addTestData = function() {
        try {
            const key = 'fx_trades';
            const existing = localStorage.getItem(key);

            if (existing) {
                const ok = confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰');
                if (!ok) return;
            }

            // æ—¢å­˜ã®AIé€£æºã¨åŒä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: date, pair, side, lot, entry, exit, pnl, rule, memo
            const samples = [
                { date: '2025-10-31', pair: 'USD/JPY', side: 'è²·', lot: 0.1, entry: 150.50, exit: 150.80, pnl: 3000, rule: 'â—‹', memo: 'é †å¼µã‚Šã‚¨ãƒ³ãƒˆãƒªãƒ¼æˆåŠŸ' },
                { date: '2025-10-31', pair: 'EUR/USD', side: 'å£²', lot: 0.2, entry: 1.0850, exit: 1.0820, pnl: 6000, rule: 'â—‹', memo: 'é€†å¼µã‚Šã‚¨ãƒ³ãƒˆãƒªãƒ¼æˆåŠŸ' },
                { date: '2025-10-30', pair: 'GBP/JPY', side: 'è²·', lot: 0.15, entry: 195.50, exit: 195.20, pnl: -3000, rule: 'Ã—', memo: 'æåˆ‡ã‚Šé…å»¶ã§æå¤±æ‹¡å¤§' }
            ];

            localStorage.setItem(key, JSON.stringify(samples));
            alert('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’3ä»¶è¿½åŠ ã—ã¾ã—ãŸ');
            location.reload();
        } catch (e) {
            console.error('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
            alert('âŒ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }
    </script>

    <script>
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Shift + A ã§AIåˆ†æã‚’é–‹ã
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'a') {
                e.preventDefault();
                const btn = document.getElementById('btn-ai-analyze');
                if (btn && !btn.closest('.hidden')) {
                    handleAiAnalyze();
                }
            }
            
            // Escã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            if (e.key === 'Escape') {
                closeAiSelectModal();
                const proModal = document.getElementById('proInfoModal');
                if (proModal) proModal.classList.add('hidden');
                closeSurvey();
            }
            
            // æ•°å­—ã‚­ãƒ¼1-3ã§AIã‚’é¸æŠï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ï¼‰
            const aiModal = document.getElementById('ai-select-modal');
            if (aiModal && !aiModal.classList.contains('hidden')) {
                if (e.key === '1') {
                    e.preventDefault();
                    openAiUrl('chatgpt');
                } else if (e.key === '2') {
                    e.preventDefault();
                    openAiUrl('gemini');
                } else if (e.key === '3') {
                    e.preventDefault();
                    openAiUrl('claude');
                }
            }
        });
    </script>
</body>
</html>

