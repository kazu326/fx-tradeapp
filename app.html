<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXãƒˆãƒ¬ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>
    <!-- Tailwind CSS CDNã‚’ãƒ­ãƒ¼ãƒ‰ --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Interãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif, 'Noto Sans JP', sans-serif; 
            /* ã‚·ãƒ³ãƒ—ãƒ«ãªæš—ã„èƒŒæ™¯è‰² */
            background-color: #1a1a1a; /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
            min-height: 100vh;
            color: #e5e7eb; /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã‚’æ˜ã‚‹ã„è‰²ã« */
        }

        .container {
            max-width: 100%;
            padding: 1rem;
            padding-bottom: 5rem; 
        }

        /* ------------------------------------- */
        /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« (ã‚·ãƒ³ãƒ—ãƒ«åŒ–) */
        /* ------------------------------------- */

        /* ã‚«ãƒ¼ãƒ‰ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: rgba(255, 255, 255, 0.1); /* åŠé€æ˜ã®ç™½ */
            backdrop-filter: blur(8px); /* ã¼ã‹ã— */
            -webkit-backdrop-filter: blur(8px); 
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08); /* ç´°ã„æ ç·š */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); /* ã‚½ãƒ•ãƒˆãªå½± */
            transition: all 0.3s ease;
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-style {
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3); /* æš—ãã€ã‚„ã‚„é€æ˜ãªèƒŒæ™¯ */
            color: #ffffff; /* å…¥åŠ›æ–‡å­—ã‚’ç™½ã« */
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.5); /* å‡¹ã¿å½± */
            transition: all 0.3s ease;
        }
        .input-style:focus {
            background: rgba(0, 0, 0, 0.4); 
            box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.7);
            outline: none;
        }
        .input-style::placeholder {
            color: rgba(255, 255, 255, 0.4); 
        }
        /* Selectã‚¿ã‚°ã®çŸ¢å°ã®è‰² */
        select.input-style {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23ffffff'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }


        /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒœã‚¿ãƒ³ */
        .btn-primary {
            background-color: #3b82f6; /* é’ */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); /* ã‚·ãƒ³ãƒ—ãƒ«ãªå½± */
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav {
            background: rgba(0, 0, 0, 0.7); /* æš—ã„åŠé€æ˜ */
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5); 
        }
        .nav-button-active {
            color: #93c5fd; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè‰²ã‚’æ˜ã‚‹ã„é’ã« */
            background: rgba(255, 255, 255, 0.08); /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®èƒŒæ™¯ */
            border-radius: 10px;
        }
        
        /* ãƒ­ãƒ¼ãƒ‰ä¸­ */
        .loading-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
        }
        
        @media (min-width: 640px) {
            .container {
                max-width: 800px;
                margin: auto;
            }
        }
        
        /* çµ±è¨ˆã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6);
        }
        /* CSVãƒœã‚¿ãƒ³ */
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚´ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .app-logo-text {
            font-size: 1.8rem; 
            font-weight: 900; 
            color: #ffffff; /* ç™½æŠœã */
            letter-spacing: -0.025em; 
            margin-bottom: 0.5rem;
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.4); /* é’ã„ã‚½ãƒ•ãƒˆã‚°ãƒ­ãƒ¼ */
        }
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®èª¿æ•´ */
        #message-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }
        .text-green-700 { color: #84cc16; } 
        .text-red-700 { color: #ef4444; }   

        @media (min-width: 640px) {
             .app-logo-text {
                font-size: 2.25rem; 
            }
        }
    </style>

    <!-- Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        setLogLevel('Debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app;
        let db;
        let auth;
        let userId = 'loading';
        let tradeDataCache = []; 
        let currentPage = 'money-management'; 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // åˆæœŸåŒ–ã¨èªè¨¼
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼å‡¦ç†
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ãƒªãƒƒã‚¹ãƒ³
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`;
                        setupRealtimeListener();
                    } else {
                        userId = crypto.randomUUID();
                        document.getElementById('user-info').textContent = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${userId} (åŒ¿å)`;
                        setupRealtimeListener();
                    }
                    hideLoading();
                });

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('user-info').textContent = 'ã‚¨ãƒ©ãƒ¼: Firebaseæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                hideLoading();
            }
        }

        // ãƒ­ãƒ¼ãƒ‰ç”»é¢éè¡¨ç¤º
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã®Firestoreãƒ‘ã‚¹
        function getTradeCollectionRef() {
            return collection(db, `artifacts/${appId}/users/${userId}/trades`);
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupRealtimeListener() {
            if (!db || userId === 'loading') return;

            const tradesCollection = getTradeCollectionRef();
            const q = query(tradesCollection);

            onSnapshot(q, (snapshot) => {
                const trades = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate() : new Date(0); 
                    trades.push({
                        id: doc.id,
                        dateObj: date, 
                        date: date.toLocaleString('ja-JP'), 
                        ...data
                    });
                });
                // æœ€æ–°ã®è¨˜éŒ²ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ä¸¦ã¹æ›¿ãˆ
                trades.sort((a, b) => b.dateObj - a.dateObj);
                tradeDataCache = trades; 
                renderTrades(trades);
                calculateStats(trades);

                // LocalStorageã¸åŒæœŸï¼ˆAIåˆ†æç”¨ï¼‰
                try {
                    const lsTrades = trades.map(t => {
                        const dateStr = t.dateObj instanceof Date && !isNaN(t.dateObj) ? t.dateObj.toISOString().slice(0,10) : '';
                        return {
                            date: dateStr,
                            pair: t.pair || '',
                            side: t.direction === 'buy' ? 'è²·' : 'å£²',
                            lot: typeof t.lotSize === 'number' ? t.lotSize : Number(t.lotSize) || 0,
                            entry: t.entryPrice,
                            exit: t.exitPrice,
                            pnl: t.pnl,
                            rule: typeof t.ruleCompliance === 'string' ? t.ruleCompliance : 'â€”',
                            memo: t.notes || ''
                        };
                    });
                    localStorage.setItem('fx_trades', JSON.stringify(lsTrades));
                } catch (e) {
                    console.warn('LocalStorageã¸ã®åŒæœŸã«å¤±æ•—:', e);
                }
            }, (error) => {
                console.error("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
                showCustomMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            });
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆä»£æ›¿ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showCustomMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            
            messageBox.className = `p-3 rounded-lg text-center mt-4 mb-4 transition-all duration-300 ${
                type === 'success' ? 'text-green-700' :
                type === 'error' ? 'text-red-700' :
                'text-blue-400'
            }`; 
            
            messageBox.style.opacity = '1';
            messageBox.style.background = 'rgba(0, 0, 0, 0.5)'; 
            messageBox.style.border = '1px solid rgba(255, 255, 255, 0.08)';

            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 5000);
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚’Firestoreã«ä¿å­˜
        window.recordTrade = async function() {
            const pair = document.getElementById('pair').value;
            const direction = document.getElementById('direction').value;
            const lotSize = parseFloat(document.getElementById('lotSize').value);
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const exitPrice = parseFloat(document.getElementById('exitPrice').value);
            const pips = parseFloat(document.getElementById('pips').value);
            const pnl = parseFloat(document.getElementById('pnl').value);
            const chartUrl = document.getElementById('chartUrl').value;
            const notes = document.getElementById('notes').value;

            // å¿…é ˆå…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!pair || !direction || isNaN(lotSize) || isNaN(entryPrice) || isNaN(exitPrice) || isNaN(pips) || isNaN(pnl)) {
                showCustomMessage('å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            document.getElementById('loading-overlay').style.display = 'flex';

            const tradeData = {
                pair,
                direction,
                lotSize,
                entryPrice,
                exitPrice,
                pips,
                pnl,
                chartUrl,
                notes,
                timestamp: serverTimestamp(),
                userId: userId
            };

            try {
                const newTradeRef = doc(getTradeCollectionRef());
                await setDoc(newTradeRef, tradeData);
                showCustomMessage('ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼', 'success');
                document.getElementById('tradeForm').reset();
            } catch (e) {
                console.error("ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã®è¿½åŠ ã‚¨ãƒ©ãƒ¼: ", e);
                showCustomMessage('è¨˜éŒ²ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            } finally {
                hideLoading();
            }
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚’HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderTrades(trades) {
            const tableBody = document.getElementById('tradeHistoryBody');
            tableBody.innerHTML = ''; 

            if (trades.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="p-3 text-center text-gray-500">ã¾ã ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                return;
            }

            trades.forEach(trade => {
                const pnlClass = trade.pnl > 0 ? 'text-green-400 font-bold' : trade.pnl < 0 ? 'text-red-400 font-bold' : 'text-gray-400';
                const row = tableBody.insertRow();
                row.className = 'border-b border-gray-800 hover:bg-gray-800/50 transition-colors text-sm'; 

                row.insertCell().textContent = trade.date;
                row.insertCell().textContent = trade.pair;
                row.insertCell().textContent = trade.direction === 'buy' ? 'è²·ã„' : 'å£²ã‚Š';
                row.insertCell().textContent = trade.lotSize.toFixed(2);
                const priceDecimals = trade.pair.includes('JPY') ? 3 : 5;
                row.insertCell().textContent = trade.entryPrice.toFixed(priceDecimals);
                row.insertCell().textContent = trade.exitPrice.toFixed(priceDecimals);
                row.insertCell().textContent = trade.pips.toFixed(2);

                const pnlCell = row.insertCell();
                pnlCell.className = pnlClass;
                pnlCell.textContent = trade.pnl.toFixed(0).toLocaleString() + 'å††'; 

                const chartCell = row.insertCell();
                if (trade.chartUrl) {
                    const link = document.createElement('a');
                    link.href = trade.chartUrl;
                    link.target = '_blank';
                    link.textContent = 'ãƒãƒ£ãƒ¼ãƒˆ';
                    link.className = 'text-blue-400 hover:text-blue-300 text-sm font-medium';
                    chartCell.appendChild(link);
                } else {
                    chartCell.textContent = 'ãªã—';
                    chartCell.className = 'text-gray-500';
                }
            });
        }
        
        // çµ±è¨ˆæƒ…å ±ã®è¨ˆç®—ã¨è¡¨ç¤º
        function calculateStats(trades) {
            if (trades.length === 0) {
                document.getElementById('totalTrades').textContent = 0;
                document.getElementById('winRate').textContent = '0.00%';
                document.getElementById('profitFactor').textContent = '0.00';
                document.getElementById('totalPnl').textContent = '0 å††';
                
                document.getElementById('totalPnl').className = 'text-2xl font-bold text-gray-400';
                return;
            }

            const totalTrades = trades.length;
            let winningTrades = 0;
            let totalPnl = 0;
            let grossProfit = 0;
            let grossLoss = 0;

            trades.forEach(trade => {
                totalPnl += trade.pnl;
                if (trade.pnl > 0) {
                    winningTrades++;
                    grossProfit += trade.pnl;
                } else {
                    grossLoss += Math.abs(trade.pnl);
                }
            });

            const winRate = (winningTrades / totalTrades) * 100;
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? '---' : '0.00');

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = `${winRate.toFixed(2)}%`;
            document.getElementById('profitFactor').textContent = profitFactor === '---' ? 'âˆ' : profitFactor.toFixed(2);
            
            const totalPnlElement = document.getElementById('totalPnl');
            totalPnlElement.textContent = `${totalPnl.toFixed(0).toLocaleString()} å††`;
            totalPnlElement.className = totalPnl >= 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
        }

        // è³‡é‡‘ç®¡ç†ï¼šãƒ­ãƒƒãƒˆã‚µã‚¤ã‚ºè¨ˆç®—
        window.calculateLotSize = function() {
            const balance = parseFloat(document.getElementById('accountBalance').value);
            const riskPct = parseFloat(document.getElementById('riskPercentage').value);
            const stopLossPips = parseFloat(document.getElementById('stopLossPips').value);
            const pipValuePerLot = parseFloat(document.getElementById('pipValuePerLot').value);

            if (isNaN(balance) || balance <= 0 || isNaN(riskPct) || riskPct <= 0 || isNaN(stopLossPips) || stopLossPips <= 0 || isNaN(pipValuePerLot) || pipValuePerLot <= 0) {
                document.getElementById('calculatedLotSize').textContent = 'ç„¡åŠ¹ãªå…¥åŠ›å€¤';
                document.getElementById('calculatedLotSize').className = 'text-xl text-red-400 font-semibold';
                document.getElementById('riskAmountDisplay').textContent = '';
                return;
            }

            const riskAmount = balance * (riskPct / 100);
            const calculatedLotSize = riskAmount / (stopLossPips * pipValuePerLot);

            const resultElement = document.getElementById('calculatedLotSize');
            resultElement.textContent = calculatedLotSize.toFixed(2) + ' ãƒ­ãƒƒãƒˆ';
            resultElement.className = 'text-2xl text-blue-400 font-bold';
            
            document.getElementById('riskAmountDisplay').textContent = `è¨±å®¹ãƒªã‚¹ã‚¯é¡: ${riskAmount.toLocaleString()} å††ç›¸å½“`;
            document.getElementById('riskAmountDisplay').className = 'text-sm text-gray-400 mt-1';
            
            showCustomMessage(`é©åˆ‡ãªãƒ­ãƒƒãƒˆã‚µã‚¤ã‚ºã¯ ${calculatedLotSize.toFixed(2)} ãƒ­ãƒƒãƒˆã§ã™ã€‚`, 'info');
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        window.exportToCSV = function() {
            if (tradeDataCache.length === 0) {
                showCustomMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            const headers = ["æ—¥ä»˜", "é€šè²¨ãƒšã‚¢", "æ–¹å‘", "ãƒ­ãƒƒãƒˆæ•°", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼", "ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼", "ç²å¾—/æå¤± pips", "æç›Š(å††)", "ãƒãƒ£ãƒ¼ãƒˆURL", "ãƒ¡ãƒ¢"];
            
            const csvRows = tradeDataCache.map(trade => {
                const dateString = trade.dateObj.toISOString(); 
                const directionText = trade.direction === 'buy' ? 'è²·ã„' : 'å£²ã‚Š';
                
                return [
                    `"${dateString}"`, 
                    `"${trade.pair}"`,
                    `"${directionText}"`,
                    trade.lotSize,
                    trade.entryPrice,
                    trade.exitPrice,
                    trade.pips,
                    trade.pnl,
                    `"${trade.chartUrl || ''}"`,
                    `"${trade.notes ? trade.notes.replace(/"/g, '""') : ''}"` 
                ].join(',');
            });
            
            const csvContent = headers.join(',') + '\n' + csvRows.join('\n');
            const blob = new Blob(['\ufeff', csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `fx_trade_history_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showCustomMessage('ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ã‚’CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚', 'success');
            } else {
                showCustomMessage('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
        window.showPage = function(pageId) {
            currentPage = pageId;
            const pages = ['money-management', 'trade-recording', 'history-analysis'];
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (pageId === id) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°åˆ‡ã‚Šæ›¿ãˆ
            pages.forEach(id => {
                const navItem = document.getElementById(`nav-${id}`);
                const icon = navItem.querySelector('svg');

                if (pageId === id) {
                    navItem.classList.add('nav-button-active');
                    icon.classList.add('text-blue-400'); 
                    navItem.classList.remove('text-gray-400');
                } else {
                    navItem.classList.remove('nav-button-active');
                    icon.classList.remove('text-blue-400');
                    navItem.classList.add('text-gray-400');
                }
            });
        }

        // FirebaseåˆæœŸåŒ–ã¨åˆæœŸãƒšãƒ¼ã‚¸è¡¨ç¤ºã‚’ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ­ãƒ¼ãƒ‰å¾Œã«å®Ÿè¡Œ
        window.onload = () => {
            initializeFirebase();
            showPage(currentPage);
        };

        // ===== AIåˆ†ææ©Ÿèƒ½ =====
        let lastGeneratedPrompt = '';
        function getTradesFromLocalStorage() {
            try {
                const raw = localStorage.getItem('fx_trades');
                if (!raw) return [];
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function convertTradesToCsv(trades) {
            const headers = ['æ—¥ä»˜','é€šè²¨ãƒšã‚¢','å£²è²·','ãƒ­ãƒƒãƒˆæ•°','ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼','æ±ºæ¸ˆä¾¡æ ¼','æç›Š','ãƒ«ãƒ¼ãƒ«éµå®ˆ','ãƒ¡ãƒ¢'];
            const rows = trades.map(t => {
                const safeMemo = String(t.memo || '').replace(/"/g, '""');
                const pnlStr = typeof t.pnl === 'number' ? (t.pnl >= 0 ? `+${t.pnl}` : `${t.pnl}`) : String(t.pnl || '');
                return [
                    t.date || '',
                    t.pair || '',
                    t.side || '',
                    t.lot ?? '',
                    t.entry ?? '',
                    t.exit ?? '',
                    pnlStr,
                    (t.rule === true || t.rule === 'â—‹') ? 'â—‹' : (t.rule === false || t.rule === 'Ã—') ? 'Ã—' : (t.rule || 'â€”'),
                    `"${safeMemo}` + `"`
                ].join(',');
            });
            return headers.join(',') + '\n' + rows.join('\n');
        }

        function buildAiPrompt(csv) {
            const template = `ã‚ãªãŸã¯FXãƒˆãƒ¬ãƒ¼ãƒ‰ã®ãƒ—ãƒ­ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®CSVãƒ‡ãƒ¼ã‚¿ã¯ç§ã®ä»Šé€±ã®ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã§ã™ã€‚

ã€åˆ†æé …ç›®ã€‘
1. å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨è² ã‘ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å¾´
2. æ™‚é–“å¸¯ãƒ»é€šè²¨ãƒšã‚¢åˆ¥ã®å‚¾å‘
3. ãƒ«ãƒ¼ãƒ«éµå®ˆç‡ã¨å‹ç‡ã®ç›¸é–¢
4. ãƒ¡ãƒ³ã‚¿ãƒ«é¢ã®èª²é¡Œï¼ˆé€£æ•—æ™‚ã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã©ï¼‰
5. æ¬¡é€±æ”¹å–„ã™ã¹ãå…·ä½“çš„è¡Œå‹•3ã¤

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿]
${csv}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

åˆå¿ƒè€…ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãã€ç®‡æ¡æ›¸ãã§åˆ†æã—ã¦ãã ã•ã„ã€‚
ç‰¹ã«æ”¹å–„ç‚¹ã¯å…·ä½“çš„ãªæ•°å€¤ç›®æ¨™ä»˜ãã§ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
            return template;
        }

        async function copyToClipboardWithFallback(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (e) {
                    // fallthrough to fallback
                }
            }
            // Fallback: create textarea and select
            try {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.top = '-1000px';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                const ok = document.execCommand('copy');
                if (!ok) {
                    // è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    showAiPromptFallback(text);
                    document.body.removeChild(ta);
                    return false;
                }
                document.body.removeChild(ta);
                return true;
            } catch (e) {
                showAiPromptFallback(text);
                return false;
            }
        }

        function showAiPromptFallback(text) {
            const area = document.getElementById('ai-fallback-area');
            const modal = document.getElementById('ai-modal');
            area.value = text;
            area.focus();
            area.select();
            modal.classList.remove('hidden');
        }

        window.handleAiAnalyze = async function() {
            const trades = getTradesFromLocalStorage();
            if (!trades || trades.length === 0) {
                showCustomMessage('âš ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            const csv = convertTradesToCsv(trades);
            const prompt = buildAiPrompt(csv);
            lastGeneratedPrompt = prompt;

            const btn = document.getElementById('btn-ai-analyze');
            const originalHtml = btn ? btn.innerHTML : '';

            const copied = await copyToClipboardWithFallback(prompt);
            if (copied) {
                // ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã®å¼·åŒ–ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                if (navigator.vibrate) try { navigator.vibrate(200); } catch (_) {}
                playFeedbackBeep();

                if (btn) {
                    // ç·‘è‰²ã«å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    btn.classList.add('bg-green-500','shadow-[0_0_0_0_rgba(34,197,94,0.9)]');
                    btn.style.boxShadow = '0 0 0 0 rgba(34,197,94,0.9)';
                    btn.style.transition = 'box-shadow 0.6s ease-out, background-color 0.2s ease-out';
                    setTimeout(() => {
                        btn.style.boxShadow = '0 0 24px 6px rgba(34,197,94,0.45)';
                    }, 10);

                    // ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€ç¬å·®ã—æ›¿ãˆ
                    btn.innerHTML = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';

                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³
                    const pop = document.createElement('span');
                    pop.textContent = 'âœ…';
                    pop.className = 'absolute -top-4 -right-2 text-2xl';
                    pop.style.transition = 'transform 250ms ease, opacity 300ms ease';
                    pop.style.transform = 'translateY(8px) scale(0.6)';
                    pop.style.opacity = '0';
                    btn.appendChild(pop);
                    requestAnimationFrame(() => {
                        pop.style.transform = 'translateY(-8px) scale(1)';
                        pop.style.opacity = '1';
                    });

                    setTimeout(() => {
                        if (btn && originalHtml) btn.innerHTML = originalHtml;
                        btn.classList.remove('bg-green-500');
                        pop.remove();
                        btn.style.boxShadow = '';
                    }, 1000);
                }

                openAiSelectModal();
            }
        }

        window.closeAiModal = function() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        // AIé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡
        function openAiSelectModal() {
            const modal = document.getElementById('ai-select-modal');
            const card = document.getElementById('ai-select-card');
            modal.classList.remove('hidden');
            // åˆæœŸã¯é€æ˜ãƒ»ç¸®å° â†’ æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§è¡¨ç¤º
            card.classList.add('opacity-0','scale-95');
            requestAnimationFrame(() => {
                card.classList.remove('opacity-0','scale-95');
                card.classList.add('opacity-100','scale-100');
            });
        }

        window.closeAiSelectModal = function() {
            const modal = document.getElementById('ai-select-modal');
            const card = document.getElementById('ai-select-card');
            card.classList.remove('opacity-100','scale-100');
            card.classList.add('opacity-0','scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 150);
        }

        window.openAiUrl = function(type) {
            const urlMap = {
                chatgpt: 'https://chat.openai.com/',
                gemini: 'https://gemini.google.com/app',
                claude: 'https://claude.ai/new'
            };
            const url = urlMap[type];
            if (url) window.open(url, '_blank', 'noopener');
        }

        window.downloadPromptTxt = function() {
            const content = lastGeneratedPrompt || '';
            if (!content) {
                showCustomMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            const btn = document.getElementById('btn-download-prompt');
            const originalHtml = btn.innerHTML;
            const ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
            try {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `FX_analysis_prompt_${ymd}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                btn.textContent = 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 3000);
            } catch (e) {
                btn.textContent = 'âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 3000);
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        function playFeedbackBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880; // A5
                o.connect(g);
                g.connect(ctx.destination);
                g.gain.setValueAtTime(0.0001, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
                o.start();
                o.stop(ctx.currentTime + 0.2);
            } catch (_) { /* ignore */ }
        }
    </script>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --><div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ãƒƒãƒ‘ãƒ¼ (ä»¥å‰ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯å‰Šé™¤) --><div>
        <div class="container min-h-screen mx-auto pt-6 pb-2">
            <header class="text-center mb-6">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜ã®æ–‡å­—ãƒ­ã‚´ã‚’CSSã§å†ç¾ã—ã€h1ã‚¿ã‚°ã¨ã—ã¦é…ç½® --><h1 class="app-logo-text">FX ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>
                <p id="user-info" class="text-sm text-gray-400 mt-1">èªè¨¼ä¸­...</p>
            </header>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ (Alertä»£æ›¿) --><div id="message-box" style="opacity:0;" class="p-3 rounded-lg text-center mt-4 transition-all duration-300"></div>

            <!-- ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ --><!-- 1. è³‡é‡‘ç®¡ç†ï¼šãƒ­ãƒƒãƒˆè¨ˆç®—ãƒ„ãƒ¼ãƒ« --><section id="money-management" class="hidden px-2 sm:px-0">
                <div class="mb-8 p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">ãƒ­ãƒƒãƒˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h2>
                    <p class="text-sm text-gray-400 mb-4">è¨±å®¹ãƒªã‚¹ã‚¯ã«åŸºã¥ãã€é©åˆ‡ãªãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="accountBalance" class="block text-sm font-medium text-gray-300">å£åº§æ®‹é«˜ (å††ç›¸å½“)</label>
                            <input type="number" id="accountBalance" value="1000000" min="1" class="input-style mt-1" placeholder="ä¾‹: 1000000">
                        </div>

                        <div>
                            <label for="riskPercentage" class="block text-sm font-medium text-gray-300">1ãƒˆãƒ¬ãƒ¼ãƒ‰ã®è¨±å®¹ãƒªã‚¹ã‚¯ç‡ (%)</label>
                            <input type="number" id="riskPercentage" value="1" min="0.1" max="100" step="0.1" class="input-style mt-1" placeholder="ä¾‹: 1.0">
                        </div>
                        
                        <div>
                            <label for="stopLossPips" class="block text-sm font-medium text-gray-300">æåˆ‡ã‚Šå¹… (pips)</label>
                            <input type="number" id="stopLossPips" value="50" min="1" class="input-style mt-1" placeholder="ä¾‹: 50">
                        </div>
                        
                        <div>
                            <label for="pipValuePerLot" class="block text-sm font-medium text-gray-300">1ãƒ­ãƒƒãƒˆã‚ãŸã‚Šã®1pipsã®ä¾¡å€¤ (å††ç›¸å½“)</label>
                            <input type="number" id="pipValuePerLot" value="1000" min="1" class="input-style mt-1" placeholder="ä¾‹: 1000">
                            <p class="text-xs text-gray-500 mt-1">â€»USD/JPYã®å ´åˆã€1ãƒ­ãƒƒãƒˆ=1000å††ç›¸å½“</p>
                        </div>
                    </div>

                    <button onclick="calculateLotSize()" class="btn-primary w-full mt-4">
                        ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                    </button>

                    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ --><div class="mt-6 p-4 summary-card text-center">
                        <p class="text-sm font-medium text-gray-400 mb-1">æ¨å¥¨ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚º</p>
                        <div id="calculatedLotSize" class="text-2xl text-white font-bold">-- ãƒ­ãƒƒãƒˆ</div>
                        <div id="riskAmountDisplay" class="text-sm text-gray-400 mt-2"></div>
                    </div>
                </div>
            </section>

            <!-- 2. ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ  --><section id="trade-recording" class="hidden px-2 sm:px-0">
                <div class="p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">æ–°è¦ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²</h2>
                    <form id="tradeForm" onsubmit="event.preventDefault(); recordTrade();">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            
                            <!-- é€šè²¨ãƒšã‚¢ --><div>
                                <label for="pair" class="block text-sm font-medium text-gray-300">é€šè²¨ãƒšã‚¢</label>
                                <select id="pair" required class="input-style mt-1">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="USD/JPY">USD/JPY</option>
                                    <option value="EUR/USD">EUR/USD</option>
                                    <option value="GBP/JPY">GBP/JPY</option>
                                    <option value="AUD/USD">AUD/USD</option>
                                    <option value="OTHERS">ãã®ä»–</option>
                                </select>
                            </div>

                            <!-- å£²è²·æ–¹å‘ --><div>
                                <label for="direction" class="block text-sm font-medium text-gray-300">å£²è²·æ–¹å‘</label>
                                <select id="direction" required class="input-style mt-1">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="buy">è²·ã„ (Buy)</option>
                                    <option value="sell">å£²ã‚Š (Sell)</option>
                                </select>
                            </div>

                            <!-- ãƒ­ãƒƒãƒˆæ•° --><div>
                                <label for="lotSize" class="block text-sm font-medium text-gray-300">ãƒ­ãƒƒãƒˆæ•° (Lot)</label>
                                <input type="number" id="lotSize" required step="0.01" min="0.01" class="input-style mt-1" placeholder="ä¾‹: 1.0">
                            </div>

                            <!-- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼ --><div>
                                <label for="entryPrice" class="block text-sm font-medium text-gray-300">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼</label>
                                <input type="number" id="entryPrice" required step="any" class="input-style mt-1" placeholder="ä¾‹: 150.050">
                            </div>

                            <!-- ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼ --><div>
                                <label for="exitPrice" class="block text-sm font-medium text-gray-300">ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼</label>
                                <input type="number" id="exitPrice" required step="any" class="input-style mt-1" placeholder="ä¾‹: 150.100">
                            </div>

                            <!-- ç²å¾—/æå¤± pips --><div>
                                <label for="pips" class="block text-sm font-medium text-gray-300">ç²å¾—/æå¤± pips</label>
                                <input type="number" id="pips" required step="any" class="input-style mt-1" placeholder="ä¾‹: 50.0">
                            </div>

                            <!-- æç›Š (å††ç›¸å½“) --><div class="sm:col-span-2">
                                <label for="pnl" class="block text-sm font-medium text-gray-300">æç›Š (å††ç›¸å½“)</label>
                                <input type="number" id="pnl" required step="any" class="input-style mt-1" placeholder="ä¾‹: 5000">
                            </div>

                        </div>

                        <!-- ãƒãƒ£ãƒ¼ãƒˆç”»åƒURL --><div class="mt-4">
                            <label for="chartUrl" class="block text-sm font-medium text-gray-300">ãƒãƒ£ãƒ¼ãƒˆç”»åƒURL (ä»»æ„)</label>
                            <input type="url" id="chartUrl" class="input-style mt-1" placeholder="å¤–éƒ¨ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®URL">
                        </div>

                        <!-- ãƒ¡ãƒ¢ --><div class="mt-4">
                            <label for="notes" class="block text-sm font-medium text-gray-300">ãƒˆãƒ¬ãƒ¼ãƒ‰ã®è€ƒå¯Ÿ/ãƒ¡ãƒ¢</label>
                            <textarea id="notes" rows="3" class="input-style mt-1 resize-none" placeholder="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ ¹æ‹ ã€åçœç‚¹ãªã©ã‚’è¨˜è¿°..."></textarea>
                        </div>

                        <button type="submit" class="btn-primary w-full mt-6">
                            ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’è¨˜éŒ²
                        </button>
                    </form>
                </div>
            </section>

            <!-- 3. å±¥æ­´ãƒ»åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ --><section id="history-analysis" class="hidden px-2 sm:px-0">
                <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ --><div class="mb-6 summary-card grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-xs font-medium text-gray-400">åˆè¨ˆãƒˆãƒ¬ãƒ¼ãƒ‰æ•°</p>
                        <p id="totalTrades" class="text-xl font-bold text-white">0</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">å‹ç‡</p>
                        <p id="winRate" class="text-xl font-bold text-white">0.00%</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">ãƒ—ãƒ­ãƒ•ã‚£ãƒƒãƒˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼</p>
                        <p id="profitFactor" class="text-xl font-bold text-white">0.00</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-400">åˆè¨ˆæç›Š</p>
                        <p id="totalPnl" class="text-xl font-bold text-white">0 å††</p>
                    </div>
                </div>

                <div class="p-5 rounded-xl card">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-white">ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´</h2>

                    <!-- CSVãƒœã‚¿ãƒ³ --><button onclick="exportToCSV()" class="btn-secondary px-4 py-2 text-sm font-medium mb-4 mr-2">
                        <!-- ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’ç™½ã«èª¿æ•´ --><svg class="inline-block w-4 h-4 mr-2 -mt-0.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <!-- AIåˆ†æãƒœã‚¿ãƒ³ -->
                    <button id="btn-ai-analyze" onclick="handleAiAnalyze()" class="btn-primary px-4 py-2 text-sm font-bold mb-4 relative overflow-visible">
                        <span class="mr-1">ğŸ¤–</span> AIã§ä»Šé€±ã‚’åˆ†æ
                    </button>
                    
                    <div class="overflow-x-auto rounded-lg shadow-inner">
                        <table class="min-w-full divide-y divide-gray-700 text-white">
                            <thead class="bg-gray-800/60">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">æ—¥ä»˜</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ãƒšã‚¢</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">æ–¹å‘</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ãƒ­ãƒƒãƒˆ</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">E.ä¾¡æ ¼</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">X.ä¾¡æ ¼</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pips</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">æç›Š</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ãƒãƒ£ãƒ¼ãƒˆ</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistoryBody" class="divide-y divide-gray-800 bg-transparent">
                                <tr><td colspan="9" class="p-3 text-center text-gray-400">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ãƒ•ãƒƒã‚¿ãƒ¼ --><footer class="text-center text-xs text-gray-500 py-4 mt-8">
                <p>Powered by Firebase Firestore | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}</p>
            </footer>
        </div>
    </div>
    
    <!-- å›ºå®šã•ã‚ŒãŸä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ --><div class="fixed bottom-0 left-0 right-0 border-t border-gray-800 shadow-2xl z-50 bottom-nav">
        <nav class="flex justify-around max-w-xl mx-auto">
            <!-- è³‡é‡‘ç®¡ç†ã‚¿ãƒ– (ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ/ã‚·ãƒ³ãƒ—ãƒ«) --><button id="nav-money-management" onclick="showPage('money-management')" class="flex-1 flex flex-col items-center p-2 text-xs font-semibold rounded-xl transition-colors text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V9m0 4v1m-4 5h8a2 2 0 002-2V6a2 2 0 00-2-2H8a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                è³‡é‡‘ç®¡ç†
            </button>
            <!-- ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚¿ãƒ– (ãƒšãƒ³/ã‚·ãƒ³ãƒ—ãƒ«) --><button id="nav-trade-recording" onclick="showPage('trade-recording')" class="flex-1 flex flex-col items-center p-2 text-xs font-semibold rounded-xl transition-colors text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²
            </button>
            <!-- å±¥æ­´ãƒ»åˆ†æã‚¿ãƒ– (ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰/ã‚·ãƒ³ãƒ—ãƒ«) --><button id="nav-history-analysis" onclick="showPage('history-analysis')" class="flex-1 flex flex-col items-center p-2 text-xs font-semibold rounded-xl transition-colors text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                å±¥æ­´ãƒ»åˆ†æ
            </button>
        </nav>
    </div>
    <!-- AIåˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ai-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto mt-24 w-[92%] max-w-xl rounded-2xl border border-white/10 bg-gray-900/90 p-5 shadow-2xl">
            <h3 id="ai-modal-title" class="text-lg font-bold text-white">AIåˆ†æ</h3>
            <p id="ai-modal-desc" class="mt-1 text-sm text-gray-300">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆãªã„ãŸã‚ã€ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</p>
            <textarea id="ai-fallback-area" class="mt-4 w-full h-48 input-style"></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button class="btn-secondary px-4 py-2 text-sm" onclick="closeAiModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- AIé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚³ãƒ”ãƒ¼æˆåŠŸæ™‚ã®ã‚¬ã‚¤ãƒ‰ï¼‰ -->
    <div id="ai-select-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60" onclick="closeAiSelectModal()"></div>
        <div id="ai-select-card" class="relative mx-auto mt-16 w-[92%] max-w-2xl rounded-2xl border border-white/10 bg-gray-900/90 p-5 shadow-2xl transition-all duration-150 ease-out opacity-0 scale-95">
            <button class="absolute right-3 top-3 text-gray-400 hover:text-white" aria-label="é–‰ã˜ã‚‹" onclick="closeAiSelectModal()">Ã—</button>
            <div id="ai-copied-title" class="font-bold rounded-lg text-white animate-pulse" style="background:#065f46; padding:16px; font-size:24px;">
                âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ
            </div>

            <div class="mt-3 text-sm text-gray-300 font-medium">ã€æ–¹æ³•1: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘ï¼ˆæ¨å¥¨ï¼‰ã€‘</div>
            <p class="mt-1 text-sm text-gray-300">ã©ã®AIã§åˆ†æã—ã¾ã™ã‹ï¼Ÿ</p>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                <button class="btn-primary w-full" onclick="openAiUrl('chatgpt')"><span class="mr-1">ğŸ¤–</span> ChatGPTã§é–‹ã</button>
                <button class="btn-primary w-full" onclick="openAiUrl('gemini')"><span class="mr-1">âœ¨</span> Geminiã§é–‹ã</button>
                <button class="btn-primary w-full" onclick="openAiUrl('claude')"><span class="mr-1">ğŸ§ </span> Claudeã§é–‹ã</button>
            </div>

            <div id="ai-paste-hint" class="mt-3 rounded-lg text-gray-900 font-semibold" style="background:#fde68a; padding:12px; font-size:16px;">
                <span class="mr-1">âš¡</span> é–‹ã„ãŸã‚‰ <span class="font-bold">Ctrl+V</span>ï¼ˆMacã¯ <span class="font-bold">âŒ˜+V</span>ï¼‰ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
            </div>

            <div class="my-4 flex items-center text-gray-500 text-xs">
                <div class="flex-1 h-px bg-gray-700"></div>
                <span class="px-3">â”â”â”â”â” ã¾ãŸã¯ â”â”â”â”â”</span>
                <div class="flex-1 h-px bg-gray-700"></div>
            </div>

            <div class="text-sm text-gray-300 font-medium">ã€æ–¹æ³•2: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‘</div>
            <button id="btn-download-prompt" class="btn-secondary mt-2 w-full md:w-auto" onclick="downloadPromptTxt()"><span class="mr-1">ğŸ“„</span> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <p class="mt-2 text-xs text-gray-400">â€»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’AIã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <!-- ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆé–‹ç™ºç”¨ï¼‰ -->
    <button id="btn-add-testdata" aria-label="ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ " onclick="addTestData()" class="fixed bottom-20 right-4 z-[60] px-3 py-2 text-xs font-bold rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2" style="background-color:#f59e0b;color:#111827;">
        ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    </button>

    <script>
    // é–‹ç™ºç”¨: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’LocalStorageã«è¿½åŠ ï¼ˆä¸Šæ›¸ã or ç¢ºèªã®ä¸Šãƒªã‚»ãƒƒãƒˆï¼‰
    window.addTestData = function() {
        try {
            const key = 'fx_trades';
            const existing = localStorage.getItem(key);

            if (existing) {
                const ok = confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰');
                if (!ok) return;
            }

            // æ—¢å­˜ã®AIé€£æºã¨åŒä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: date, pair, side, lot, entry, exit, pnl, rule, memo
            const samples = [
                { date: '2025-10-31', pair: 'USD/JPY', side: 'è²·', lot: 0.1, entry: 150.50, exit: 150.80, pnl: 3000, rule: 'â—‹', memo: 'é †å¼µã‚Šã‚¨ãƒ³ãƒˆãƒªãƒ¼æˆåŠŸ' },
                { date: '2025-10-31', pair: 'EUR/USD', side: 'å£²', lot: 0.2, entry: 1.0850, exit: 1.0820, pnl: 6000, rule: 'â—‹', memo: 'é€†å¼µã‚Šã‚¨ãƒ³ãƒˆãƒªãƒ¼æˆåŠŸ' },
                { date: '2025-10-30', pair: 'GBP/JPY', side: 'è²·', lot: 0.15, entry: 195.50, exit: 195.20, pnl: -3000, rule: 'Ã—', memo: 'æåˆ‡ã‚Šé…å»¶ã§æå¤±æ‹¡å¤§' }
            ];

            localStorage.setItem(key, JSON.stringify(samples));
            alert('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’3ä»¶è¿½åŠ ã—ã¾ã—ãŸ');
            location.reload();
        } catch (e) {
            console.error('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
            alert('âŒ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }
    </script>
</body>
</html>
